<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SaaS SST - Control de Campo</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --color-primario: #1E3A8A;
            --color-acento: #F59E0B;
        }

        .bg-primary {
            background-color: var(--color-primario);
        }

        .text-primary {
            color: var(--color-primario);
        }

        .border-primary {
            border-color: var(--color-primario);
        }

        .bg-accent {
            background-color: var(--color-acento);
        }

        .text-accent {
            color: var(--color-acento);
        }

        .ring-primary {
            --tw-ring-color: var(--color-primario);
        }

        body {
            font-family: 'Inter', sans-serif;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4);
            }

            50% {
                box-shadow: 0 0 20px 6px rgba(245, 158, 11, 0.15);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.6s ease-out forwards;
        }

        .animate-slide-up {
            animation: slideUp 0.5s ease-out forwards;
        }

        .animate-pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite;
        }

        /* Custom focus ring */
        .field-focus:focus {
            border-color: var(--color-primario);
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col">

    <!-- CONFIG INYECTADA POR EL SERVIDOR -->
    <script>
        var SERVER_CONFIG = {};
        var SERVER_ROLE = '';
        var SERVER_EMAIL = '';
        var SERVER_URL = '';
        try {
            SERVER_CONFIG = <?!= configJSON || '{}' ?>;
            SERVER_ROLE = '<?= role || "" ?>';
            SERVER_EMAIL = '<?= email || "" ?>';
            SERVER_URL = '<?= scriptUrl || "" ?>';
        } catch (e) {
            console.error('[SST] Error parseando config del servidor:', e);
        }

        if (SERVER_CONFIG.COLOR_PRIMARIO) {
            document.documentElement.style.setProperty('--color-primario', SERVER_CONFIG.COLOR_PRIMARIO);
        }
        if (SERVER_CONFIG.COLOR_ACENTO) {
            document.documentElement.style.setProperty('--color-acento', SERVER_CONFIG.COLOR_ACENTO);
        }

        console.log('[SST] Página cargada. Rol:', SERVER_ROLE, 'Email:', SERVER_EMAIL);
    </script>

    <!-- Capa de Carga Inicial -->
    <div id="initial-loader" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center"
        style="transition: opacity 0.5s ease;">
        <div class="animate-spin rounded-full h-16 w-16 mb-4"
            style="border: 4px solid #e5e7eb; border-top-color: var(--color-primario);"></div>
        <p class="text-gray-600 font-medium">Verificando sesión segura...</p>
    </div>
    <script>
        setTimeout(function () {
            var loader = document.getElementById('initial-loader');
            if (loader) {
                loader.style.opacity = '0';
                setTimeout(function () { if (loader.parentNode) loader.parentNode.removeChild(loader); }, 600);
                console.warn('[SST] Loader eliminado por timeout de seguridad (8s)');
            }
        }, 8000);
    </script>

    <!-- Header compacto -->
    <header class="bg-white shadow-sm px-4 py-3 flex justify-between items-center border-b-2 border-primary/20">
        <div class="flex items-center space-x-3">
            <span id="logo-marca-icon" class="material-symbols-outlined text-primary text-3xl">security</span>
            <img id="logo-marca" src="" alt="Logo" class="h-10 w-auto object-contain hidden">
            <div>
                <h1 class="text-base font-bold text-gray-800 leading-tight">Sistema SST</h1>
                <p class="text-xs text-gray-400 font-medium">Control de Campo</p>
            </div>
        </div>
        <div id="user-info" class="hidden flex items-center space-x-2 text-sm">
            <div class="text-right">
                <p id="user-name" class="font-bold text-gray-800 text-sm leading-none">...</p>
                <p id="user-role-label" class="text-[10px] text-primary font-semibold uppercase tracking-wider mt-0.5">
                </p>
            </div>
            <div class="flex items-center space-x-3">
                <div class="w-9 h-9 bg-primary/10 rounded-full flex items-center justify-center">
                    <span class="material-symbols-outlined text-primary text-lg">person</span>
                </div>
                <button onclick="cerrarSesion()"
                    class="w-8 h-8 rounded-full bg-red-50 flex items-center justify-center text-red-500 hover:bg-red-500 hover:text-white transition-colors shadow-sm"
                    title="Cerrar Sesión">
                    <span class="material-symbols-outlined text-sm">logout</span>
                </button>
            </div>
        </div>
        <span id="user-email" class="hidden"></span>
    </header>
    <script>
        if (SERVER_CONFIG.URL_LOGO) {
            var logoImg = document.getElementById('logo-marca');
            var logoIcon = document.getElementById('logo-marca-icon');
            if (logoImg) { logoImg.src = SERVER_CONFIG.URL_LOGO; logoImg.classList.remove('hidden'); }
            if (logoIcon) { logoIcon.classList.add('hidden'); }
        }
    </script>

    <!-- Hero / Bienvenida Principal -->
    <header id="welcome-section" class="max-w-2xl mx-auto px-4 pt-6 pb-2 hidden">
        <div
            class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8 flex flex-col items-center text-center animate-fade-in relative overflow-hidden">
            <!-- Decoración sutil de fondo -->
            <div class="absolute top-0 right-0 -mt-8 -mr-8 w-32 h-32 bg-primary/5 rounded-full blur-3xl"></div>
            <div class="absolute bottom-0 left-0 -mb-8 -ml-8 w-32 h-32 bg-accent/5 rounded-full blur-3xl"></div>

            <div
                class="w-20 h-20 bg-primary/10 rounded-3xl flex items-center justify-center mb-6 ring-8 ring-primary/5 rotate-3 hover:rotate-0 transition-transform duration-500">
                <span id="welcome-icon" class="material-symbols-outlined text-5xl text-primary">waving_hand</span>
            </div>
            <h2 id="welcome-message" class="text-2xl font-black text-gray-800 tracking-tight mb-3">¡Cargando...!</h2>
            <div class="max-w-sm">
                <p id="welcome-subtext" class="text-gray-500 font-medium leading-relaxed italic text-sm md:text-base">
                    Preparando su entorno de trabajo seguro...
                </p>
            </div>
        </div>
    </header>

    <!-- Contenedor Principal -->
    <main class="flex-grow p-4 container mx-auto max-w-2xl">

        <!-- ═══════════════════════════════════════════════ -->
        <!-- MÓDULO DE ASISTENCIA — INICIO DE JORNADA       -->
        <!-- ═══════════════════════════════════════════════ -->
        <div id="asistencia-content" class="hidden animate-slide-up">
            <div class="max-w-md mx-auto">
                <!-- Card principal -->
                <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-100">
                    <!-- Banner superior con gradiente -->
                    <div
                        class="bg-gradient-to-br from-blue-900 via-blue-800 to-blue-700 px-6 py-8 text-center text-white relative overflow-hidden">
                        <div class="absolute inset-0 opacity-10"
                            style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 80 80%22><circle cx=%2240%22 cy=%2240%22 r=%2230%22 fill=%22white%22 opacity=%220.05%22/></svg>'); background-size: 80px;">
                        </div>
                        <div class="relative z-10">
                            <div
                                class="inline-flex items-center justify-center w-16 h-16 bg-white/15 rounded-2xl mb-4 backdrop-blur-sm">
                                <span class="material-symbols-outlined text-4xl text-white">fingerprint</span>
                            </div>
                            <h3 class="text-xl font-black uppercase tracking-tight">Inicio de Jornada</h3>
                            <p class="text-blue-200 text-sm mt-1 font-medium">Registre su ingreso para comenzar</p>
                        </div>
                    </div>

                    <!-- Formulario -->
                    <div class="p-6 space-y-5">
                        <form id="attendance-form" class="space-y-5">
                            <!-- Campo 1: Obra -->
                            <div>
                                <label
                                    class="flex items-center text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">
                                    <span
                                        class="material-symbols-outlined text-sm mr-1.5 text-primary">location_on</span>
                                    Obra / Proyecto
                                </label>
                                <select id="idObraAsistencia" required
                                    class="w-full px-4 py-3.5 bg-gray-50 border border-gray-200 rounded-xl field-focus outline-none transition-all font-medium text-gray-700 text-sm appearance-none cursor-pointer">
                                    <option value="">Seleccione ubicación...</option>
                                </select>
                            </div>

                            <!-- Campo 2: Foto -->
                            <div>
                                <label
                                    class="flex items-center text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">
                                    <span
                                        class="material-symbols-outlined text-sm mr-1.5 text-primary">photo_camera</span>
                                    Evidencia Fotográfica
                                </label>

                                <div id="asis-preview-container"
                                    class="hidden mb-3 rounded-xl overflow-hidden shadow-md border-2 border-primary/20 aspect-video relative">
                                    <img id="asis-img-preview" src="" alt="Soporte" class="w-full h-full object-cover">
                                    <div
                                        class="absolute bottom-2 right-2 bg-green-500 text-white text-[10px] font-bold px-2 py-1 rounded-full flex items-center">
                                        <span class="material-symbols-outlined text-xs mr-0.5">check_circle</span>
                                        Capturada
                                    </div>
                                </div>

                                <label for="asis-foto" id="asis-foto-label"
                                    class="cursor-pointer border-2 border-dashed border-gray-200 rounded-xl p-6 flex flex-col items-center hover:border-primary/50 hover:bg-blue-50/50 transition-all group">
                                    <div
                                        class="bg-primary/10 p-3 rounded-full group-hover:scale-110 transition-transform">
                                        <span class="material-symbols-outlined text-3xl text-primary">add_a_photo</span>
                                    </div>
                                    <span class="mt-2 text-xs font-semibold text-gray-500">Toque para capturar
                                        selfie</span>
                                    <input type="file" id="asis-foto" accept="image/*" capture="camera" class="hidden"
                                        onchange="previewAsistencia(this)">
                                </label>
                            </div>

                            <!-- Botón de acción -->
                            <button type="submit" id="btn-asistencia"
                                class="w-full bg-gradient-to-r from-blue-800 to-blue-600 text-white py-4 rounded-xl font-bold text-base shadow-lg shadow-blue-800/25 hover:shadow-xl hover:from-blue-700 hover:to-blue-500 active:scale-[0.98] transition-all flex justify-center items-center gap-2">
                                <span id="asis-spinner"
                                    class="hidden animate-spin border-3 border-white border-t-transparent rounded-full w-5 h-5"></span>
                                <span class="material-symbols-outlined text-xl" id="asis-btn-icon">login</span>
                                <span id="asis-btn-text">INICIAR JORNADA</span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Banner de jornada activa + botón salida (Independiente) -->
        <div id="exit-section"
            class="hidden mb-6 rounded-2xl overflow-hidden border border-amber-200 shadow-md animate-pulse-glow max-w-2xl mx-auto">
            <div class="bg-gradient-to-r from-amber-500 to-orange-500 px-4 py-3 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="bg-white/20 p-2 rounded-lg backdrop-blur-sm">
                        <span class="material-symbols-outlined text-white">schedule</span>
                    </div>
                    <div>
                        <p class="text-sm font-bold text-white">Jornada Activa</p>
                        <p class="text-xs text-amber-100">Registre su salida al finalizar</p>
                    </div>
                </div>
                <button onclick="openExitModal()"
                    class="bg-white text-orange-600 hover:bg-orange-50 px-4 py-2.5 rounded-xl font-bold shadow-lg transition-all active:scale-95 flex items-center text-sm whitespace-nowrap ml-3">
                    <span class="material-symbols-outlined mr-1.5 text-base">logout</span>
                    Finalizar
                </button>
            </div>
        </div>

        <!-- ═══════════════════════════════════════════════ -->
        <!-- PANEL DE TRABAJO (main-content)                -->
        <!-- ═══════════════════════════════════════════════ -->
        <div id="main-content" class="hidden animate-slide-up">
            <!-- Contenido del panel (se inyecta por JS según rol) -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                <div id="content-placeholder" class="text-center py-8 text-gray-400">
                    <span class="material-symbols-outlined text-4xl mb-2">hourglass_top</span>
                    <p class="text-sm">Cargando módulo...</p>
                </div>
            </div>
        </div>

        <!-- ═══════════════════════════════════════════════ -->
        <!-- MODAL DE SALIDA                                -->
        <!-- ═══════════════════════════════════════════════ -->
        <div id="exit-modal"
            class="fixed inset-0 bg-black/60 z-[60] flex items-end sm:items-center justify-center hidden backdrop-blur-sm"
            onclick="if(event.target===this) closeExitModal()">
            <div
                class="bg-white rounded-t-3xl sm:rounded-2xl shadow-2xl w-full sm:max-w-md overflow-hidden animate-slide-up">
                <!-- Handle bar (mobile) -->
                <div class="sm:hidden flex justify-center pt-3 pb-1">
                    <div class="w-10 h-1 bg-gray-300 rounded-full"></div>
                </div>

                <!-- Header del modal -->
                <div class="px-6 pt-5 pb-4 text-center">
                    <div class="inline-flex items-center justify-center w-14 h-14 bg-orange-100 rounded-2xl mb-3">
                        <span class="material-symbols-outlined text-3xl text-orange-500">waving_hand</span>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800">Finalizar Jornada</h3>
                    <p class="text-gray-400 text-sm mt-1">Capture su foto de salida para cerrar el registro</p>
                </div>

                <div class="px-6 pb-6">
                    <!-- Preview de la foto capturada -->
                    <div id="exit-preview-container"
                        class="hidden mb-4 rounded-xl overflow-hidden shadow-md border-2 border-green-200 relative">
                        <img id="exit-img-preview" src="" class="w-full h-48 object-cover">
                        <div
                            class="absolute bottom-2 right-2 bg-green-500 text-white text-[10px] font-bold px-2 py-1 rounded-full flex items-center">
                            <span class="material-symbols-outlined text-xs mr-0.5">check_circle</span> Lista
                        </div>
                    </div>

                    <!-- Botón de captura -->
                    <label for="exit-foto" id="exit-foto-label"
                        class="cursor-pointer border-2 border-dashed border-gray-200 rounded-xl p-5 flex flex-col items-center hover:border-orange-300 hover:bg-orange-50/50 transition-all group mb-5">
                        <div class="bg-orange-100 p-3 rounded-full group-hover:scale-110 transition-transform">
                            <span class="material-symbols-outlined text-2xl text-orange-500">add_a_photo</span>
                        </div>
                        <span class="mt-2 text-xs font-bold text-gray-500 uppercase">Toque para capturar</span>
                        <input type="file" id="exit-foto" accept="image/*" capture="camera" class="hidden"
                            onchange="previewSalida(this)">
                    </label>

                    <!-- Botones de acción -->
                    <div class="flex space-x-3">
                        <button onclick="closeExitModal()"
                            class="flex-1 py-3.5 text-gray-500 font-bold hover:bg-gray-100 rounded-xl transition text-sm border border-gray-200">Cancelar</button>
                        <button onclick="submitSalida()" id="btn-submit-salida"
                            class="flex-1 py-3.5 bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold rounded-xl shadow-lg shadow-orange-500/20 hover:from-orange-600 hover:to-red-600 transition-all active:scale-[0.98] flex items-center justify-center text-sm">
                            <span id="exit-spinner"
                                class="hidden animate-spin mr-2 border-2 border-white border-t-transparent rounded-full w-4 h-4"></span>
                            <span class="material-symbols-outlined text-base mr-1">logout</span>
                            Confirmar Salida
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- CONTENIDO CONDICIONAL SEGÚN ROL (templates ocultos) -->
    <template id="tpl-inspeccion">
        <?!= include('FormInspeccion'); ?>
    </template>
    <template id="tpl-admin">
        <div class="text-center py-10">
            <span class="material-symbols-outlined text-6xl text-primary mb-4">dashboard</span>
            <h3 class="text-2xl font-bold text-gray-800">Panel de Administración</h3>
            <p class="text-gray-500 mt-2">Bienvenido, Administrador. Próximamente visualización de métricas y gestión de
                usuarios.</p>
        </div>
    </template>
    <template id="tpl-error">
        <div class="text-center py-10">
            <span class="material-symbols-outlined text-6xl text-red-400 mb-4">error</span>
            <p class="text-red-500 text-lg font-bold">Rol no reconocido o acceso no autorizado.</p>
            <a id="error-login-link" href="#" class="text-primary underline mt-4 inline-block">Volver al Login</a>
        </div>
    </template>

    <script>
        // Inyectar contenido según rol del servidor
        (function () {
            var mainContent = document.getElementById('main-content');
            var placeholder = document.getElementById('content-placeholder');
            var tplId = '';

            if (SERVER_ROLE === 'SUP-SST') {
                tplId = 'tpl-inspeccion';
            } else if (SERVER_ROLE === 'ADMIN') {
                tplId = 'tpl-admin';
            } else {
                tplId = 'tpl-error';
            }

            var tpl = document.getElementById(tplId);
            if (tpl && mainContent) {
                var contentDiv = mainContent.querySelector('.bg-white.rounded-xl');
                if (contentDiv) {
                    contentDiv.innerHTML = tpl.innerHTML;
                } else {
                    mainContent.innerHTML += tpl.innerHTML;
                }
                var loginLink = document.getElementById('error-login-link');
                if (loginLink && SERVER_URL) {
                    loginLink.href = SERVER_URL;
                }
            }
            console.log('[SST] Contenido cargado para rol:', SERVER_ROLE);
        })();
    </script>

    <!-- Lógica principal del cliente -->
    <?!= include('App.js'); ?>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white p-3 text-center text-xs mt-auto">
        <p>&copy; 2026 ITELSA IA - SaaS SST White-Label Solutions</p>
        <p class="mt-0.5 text-gray-400">Powered by Google Cloud & AI Engine</p>
    </footer>

</body>

</html>