<script>
    /**
     * APP.JS.HTML ‚Äî v3.0
     * Manejador central de sesi√≥n y l√≥gica UI.
     * Session h√≠brida: URL params + localStorage para evadir
     * limitaciones del sandbox de Google Apps Script.
     */

    let currentUser = null;
    let archivoBase64 = null;
    let nombreArchivo = '';
    let _obraSeleccionada = ''; // Obra elegida en el formulario de jornada
    let _clientesCargados = false; // Flag: ¬øya se carg√≥ el select de clientes?
    let _formatosDisponibles = []; // Cache de formatos del cliente seleccionado

    window.addEventListener('load', function () {
        verificarSesion();
    });

    // ================================================================
    // GESTI√ìN DE SESI√ìN ‚Äî L√ìGICA ROBUSTA
    // ================================================================

    function verificarSesion() {
        console.log("[SST] Iniciando verificaci√≥n de sesi√≥n...");

        // 1. Prioridad absoluta: Si hay 'logout=true' en la URL o flag de salida reciente
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('logout') === 'true' || sessionStorage.getItem('justLoggedOut')) {
            console.log("[SST] Logout detectado. Bloqueando acceso autom√°tico.");
            sessionStorage.removeItem('justLoggedOut');
            localStorage.clear();
            mostrarErrorAcceso("Sesi√≥n cerrada correctamente.");
            return;
        }


        if (typeof SERVER_EMAIL !== 'undefined' && SERVER_EMAIL &&
            typeof SERVER_ROLE !== 'undefined' && SERVER_ROLE) {
            console.log("[SST] Datos del servidor detectados ‚Äî Email:", SERVER_EMAIL, "Rol:", SERVER_ROLE);
            recuperarSesionConEmail(decodeURIComponent(SERVER_EMAIL));
            return;
        }

        const storedUser = localStorage.getItem('userSST');
        if (storedUser) {
            try {
                currentUser = JSON.parse(storedUser);
                console.log("[SST] Sesi√≥n recuperada de localStorage:", currentUser.email);
            } catch (e) {
                localStorage.removeItem('userSST');
                currentUser = null;
            }
        }

        if (currentUser && currentUser.email && currentUser.rol) {
            inicializarAppConSesion();
            return;
        }

        console.log("[SST] Sin sesi√≥n en servidor ni localStorage, intentando URL...");

        try {
            if (typeof google !== 'undefined' && google.script && google.script.url) {
                google.script.url.getLocation(function (location) {
                    console.log("[SST] getLocation response:", JSON.stringify(location));
                    var emailParam = location.parameter ? location.parameter.email : null;
                    var roleParam = location.parameter ? location.parameter.role : null;

                    if (emailParam) {
                        recuperarSesionConEmail(decodeURIComponent(emailParam));
                    } else if (roleParam) {
                        recuperarSesionConServidor();
                    } else {
                        recuperarSesionConServidor();
                    }
                });
            } else {
                recuperarSesionConServidor();
            }
        } catch (e) {
            console.error("[SST] Error en getLocation:", e);
            recuperarSesionConServidor();
        }
    }

    function recuperarSesionConEmail(email) {
        google.script.run
            .withSuccessHandler(function (response) {
                if (response.status === 'success') {
                    currentUser = response.data;
                    localStorage.setItem('userSST', JSON.stringify(currentUser));
                    console.log("[SST] Sesi√≥n OK v√≠a email:", currentUser.email);
                    inicializarAppConSesion();
                } else {
                    mostrarErrorAcceso("No se pudo verificar la sesi√≥n. Por favor inicie sesi√≥n nuevamente.");
                }
            })
            .withFailureHandler(function (err) {
                mostrarErrorAcceso("Error de conexi√≥n. Por favor inicie sesi√≥n nuevamente.");
            })
            .obtenerDatosUsuario(email);
    }

    function recuperarSesionConServidor() {
        google.script.run
            .withSuccessHandler(function (response) {
                if (response.status === 'success') {
                    currentUser = response.data;
                    localStorage.setItem('userSST', JSON.stringify(currentUser));
                    inicializarAppConSesion();
                } else {
                    mostrarErrorAcceso("No se detect√≥ una sesi√≥n activa. Por favor inicie sesi√≥n.");
                }
            })
            .withFailureHandler(function (err) {
                mostrarErrorAcceso("Error de conexi√≥n. Por favor inicie sesi√≥n nuevamente.");
            })
            .obtenerUsuarioActivo();
    }

    /**
     * Orquesta la UI una vez que currentUser est√° disponible.
     */
    function inicializarAppConSesion() {
        inyectarDatosIdentidad();
        mostrarBienvenidaPersonalizada();

        if (currentUser && currentUser.rol === 'SUP-SST') {
            try {
                cargarObrasAsistencia();
                configurarAsistencia();
                cargarOtrasOpciones();
                verificarEstadoAsistencia();
            } catch (e) {
                console.error('[SST] Error en inicializaci√≥n SUP-SST:', e);
                switchModule('asistencia');
            }
        } else if (currentUser && currentUser.rol === 'ADMIN') {
            // Ampliar contenedor principal para pantalla completa
            var mainEl = document.querySelector('main');
            if (mainEl) {
                mainEl.classList.remove('max-w-2xl');
                mainEl.classList.add('max-w-6xl');
            }
            // Etiquetar el m√≥dulo activo en el header
            actualizarModuloHeader('Administraci√≥n');
            switchModule('admin');
        }

        ocultarLoader();
    }

    // ================================================================
    // IDENTIDAD Y BIENVENIDA
    // ================================================================

    function inyectarDatosIdentidad() {
        if (!currentUser) return;
        const elName = document.getElementById('user-name');
        const elEmail = document.getElementById('user-email');
        const elRole = document.getElementById('user-role-label');
        const elInfo = document.getElementById('user-info');
        if (elName) elName.textContent = currentUser.nombre || "Usuario";
        if (elEmail) elEmail.textContent = currentUser.email || "";
        if (elRole) elRole.textContent = currentUser.rol || "COLABORADOR";
        if (elInfo) elInfo.classList.remove('hidden');
    }

    function mostrarBienvenidaPersonalizada() {
        if (!currentUser) return;

        const welcomeSection = document.getElementById('welcome-section');
        const welcomeMsg = document.getElementById('welcome-message');
        const welcomeSub = document.getElementById('welcome-subtext');
        const welcomeIcon = document.getElementById('welcome-icon');

        if (!welcomeSection) return;

        const rol = currentUser.rol;
        const nombre = (currentUser.nombre || "Usuario").split(' ')[0];

        // Frases motivacionales para SST
        const quotes = [
            "La seguridad no es un eslogan, es un estilo de vida. üë∑",
            "Tu familia te espera, trabaja con seguridad. üë®‚Äçüë© family",
            "La mejor herramienta eres t√∫. ¬°Cu√≠date! üõ°Ô∏è",
            "Nada es tan importante que no pueda hacerse de forma segura. ‚úÖ",
            "Hoy es un gran d√≠a para prevenir accidentes. üöÄ",
            "Tu compromiso con la seguridad salva vidas. ü§ù",
            "Trabaja con pasi√≥n, pero siempre con precauci√≥n. ‚ú®",
            "La prevenci√≥n es la clave del √©xito. üîë"
        ];
        const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];

        let config = {
            msg: `¬°Hola, ${nombre}! üëã`,
            sub: randomQuote,
            icon: "sentiment_satisfied"
        };

        if (rol === 'SUP-SST') {
            config.msg = `¬°Bienvenido/a, ${nombre}! üë∑`;
            config.icon = "engineering";
        } else if (rol === 'ADMIN') {
            const adminQuotes = [
                "Una buena gesti√≥n es la base de una empresa segura.",
                "El liderazgo administrativo impulsa la cultura SST.",
                "Gestionar con datos, prevenir con conocimiento.",
                "La excelencia operativa comienza desde la administraci√≥n."
            ];
            config.msg = `¬°Hola, ${nombre}! Es un gusto saludarte. üëî`;
            config.sub = adminQuotes[Math.floor(Math.random() * adminQuotes.length)];
            config.icon = "admin_panel_settings";
        }

        if (rol === 'ADMIN') {
            // Para admin: poblar la bienvenida inline del portal (no la secci√≥n flotante)
            var inlineMsg  = document.getElementById('admin-welcome-msg');
            var inlineSub  = document.getElementById('admin-welcome-sub');
            var inlineIcon = document.getElementById('admin-welcome-icon');
            if (inlineMsg)  inlineMsg.textContent  = config.msg;
            if (inlineSub)  inlineSub.textContent  = config.sub;
            if (inlineIcon) inlineIcon.textContent = config.icon;
            // welcome-section permanece oculta para evitar solapamiento con el modal
        } else {
            if (welcomeMsg)  welcomeMsg.textContent  = config.msg;
            if (welcomeSub)  welcomeSub.textContent  = config.sub;
            if (welcomeIcon) welcomeIcon.textContent = config.icon;
            const mobileGreet = document.getElementById('welcome-message-mobile');
            if (mobileGreet) mobileGreet.textContent = '¬°Hola, ' + nombre + '!';
            welcomeSection.classList.remove('hidden');
        }
    }

    /**
     * Actualiza el subt√≠tulo del m√≥dulo en el header principal.
     * @param {string} texto Nombre del m√≥dulo activo (ej: 'Gesti√≥n de Empresas')
     */
    function actualizarModuloHeader(texto) {
        var el = document.getElementById('header-modulo-label');
        if (el) el.textContent = texto;
    }

    function mostrarErrorAcceso(msj) {
        const content = document.getElementById('main-content');
        if (!content) return;
        const scriptUrl = window.location.href.split('?')[0];
        content.innerHTML = `
            <div class="flex flex-col items-center justify-center py-12 px-4 animate-fade-in">
                <div class="bg-white/5 backdrop-blur-xl rounded-3xl p-10 border border-white/10 shadow-2xl max-w-sm w-full text-center">
                    <div class="w-20 h-20 bg-red-500/10 rounded-2xl flex items-center justify-center mx-auto mb-6 border border-red-500/20">
                        <span class="material-symbols-outlined text-5xl text-red-500">lock</span>
                    </div>
                    <h3 class="text-2xl font-black text-white tracking-tight mb-2 uppercase">Acceso Restringido</h3>
                    <p class="text-slate-400 font-medium mb-8 leading-relaxed">${msj}</p>
                    <a href="${scriptUrl}" 
                       class="block w-full bg-primary text-black py-4 rounded-xl font-black uppercase tracking-widest shadow-lg shadow-primary/20 hover:opacity-90 transition-all active:scale-95">
                        Ir al Login
                    </a>
                </div>
            </div>
        `;
        content.classList.remove('hidden');
        ocultarLoader();
    }

    function ocultarLoader() {
        const loader = document.getElementById('initial-loader');
        if (loader) {
            loader.classList.add('opacity-0');
            setTimeout(() => loader.remove(), 500);
        }
    }

    // Helper: navega al Login usando anchor target="_top" (m√©todo oficial en GAS iframes)
    function _irAlLogin(urlBase) {
        var url = urlBase.split('?')[0] + '?page=login';
        console.log("[SST] Navegando al Login:", url);
        var a = document.createElement('a');
        a.href = url;
        a.target = '_top';
        document.body.appendChild(a);
        a.click();
    }

    // Bot√≥n "Cerrar Sesi√≥n" del header
    function cerrarSesion() {
        console.log("[SST] Cerrando sesi√≥n (header)...");
        localStorage.clear();
        sessionStorage.clear();

        // SERVER_URL est√° inyectado por el servidor ‚Äî es la fuente m√°s confiable.
        // Si por alguna raz√≥n est√° vac√≠o, caemos al API de GAS como respaldo.
        if (typeof SERVER_URL !== 'undefined' && SERVER_URL) {
            _irAlLogin(SERVER_URL);
        } else {
            google.script.run
                .withSuccessHandler(_irAlLogin)
                .withFailureHandler(function () {
                    alert("No se pudo obtener la URL de sesi√≥n. Recargue la p√°gina.");
                })
                .getScriptUrl();
        }
    }

    // ================================================================
    // M√ìDULO: ASISTENCIA
    // ================================================================

    /**
     * Cambia entre la vista de asistencia y el panel de trabajo.
     */
    function switchModule(target) {
        const asisCont = document.getElementById('asistencia-content');
        const mainCont = document.getElementById('main-content');

        console.log("[SST] switchModule llamado con:", target);

        if (target === 'asistencia') {
            if (asisCont) asisCont.classList.remove('hidden');
            if (mainCont) mainCont.classList.add('hidden');
        } else {
            // 'inspeccion' o cualquier otro -> mostrar panel principal
            if (asisCont) asisCont.classList.add('hidden');
            if (mainCont) mainCont.classList.remove('hidden');
        }
    }

    /**
     * Verifica el estado de asistencia en el servidor.
     * Si tiene jornada activa -> panel de trabajo + bot√≥n salida.
     * Si no -> pantalla de registro de entrada.
     */
    function verificarEstadoAsistencia() {
        if (!currentUser || !currentUser.email) return;
        console.log('[SST] Verificando estado de asistencia para:', currentUser.email);

        google.script.run
            .withSuccessHandler(function (response) {
                console.log('[SST] Respuesta de obtenerEstadoAsistencia:', JSON.stringify(response));
                const exitSection = document.getElementById('exit-section');

                if (response.status === 'success' && response.data && response.data.activo) {
                    console.log('[SST] ‚úÖ Jornada ACTIVA detectada ‚Äî mostrando panel de trabajo');
                    // Recuperar la obra activa para bloquear el formulario de inspecci√≥n
                    if (response.data.obra) {
                        _obraSeleccionada = response.data.obra;
                        console.log('[SST] Obra activa recuperada del servidor:', _obraSeleccionada);
                    }
                    switchModule('inspeccion');
                    if (exitSection) exitSection.classList.remove('hidden');
                    // Intentar bloquear (puede que los clientes ya hayan cargado)
                    _intentarBloqueoEmpresa();
                } else {
                    console.log('[SST] ‚è≥ Sin jornada activa ‚Äî mostrando registro de entrada');
                    switchModule('asistencia');
                    if (exitSection) exitSection.classList.add('hidden');
                }
            })
            .withFailureHandler(function (err) {
                console.error('[SST] Error verificando asistencia:', err);
                switchModule('asistencia');
            })
            .obtenerEstadoAsistencia(currentUser.email);
    }

    function previewAsistencia(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                archivoBase64 = e.target.result;
                const prev = document.getElementById('asis-img-preview');
                const cont = document.getElementById('asis-preview-container');
                const label = document.getElementById('asis-foto-label');
                if (prev) prev.src = e.target.result;
                if (cont) cont.classList.remove('hidden');
                // Ocultar bot√≥n de captura para evitar duplicados
                if (label) label.classList.add('hidden');
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    /**
     * Configura el formulario de asistencia (solo ENTRADA).
     * FIX PRINCIPAL: Despu√©s de registrar exitosamente, se redirige
     * DIRECTAMENTE al panel de trabajo sin esperar otra llamada al servidor.
     */
    function configurarAsistencia() {
        const form = document.getElementById('attendance-form');
        if (!form) return;

        form.addEventListener('submit', function (e) {
            e.preventDefault();

            const obraSelect = document.getElementById('idObraAsistencia');

            if (obraSelect && (obraSelect.value === '' || obraSelect.selectedIndex === 0)) {
                alert("‚ö†Ô∏è Por favor seleccione la Obra / Proyecto.");
                return;
            }

            if (!archivoBase64) {
                alert("‚ö†Ô∏è Debe capturar la foto de ingreso.");
                return;
            }

            const btn = document.getElementById('btn-asistencia');
            const spinner = document.getElementById('asis-spinner');
            const btnText = document.getElementById('asis-btn-text');
            const btnIcon = document.getElementById('asis-btn-icon');

            if (btn) btn.disabled = true;
            if (spinner) spinner.classList.remove('hidden');
            if (btnText) btnText.textContent = "REGISTRANDO...";
            if (btnIcon) btnIcon.classList.add('hidden');

            const payload = {
                userEmail: currentUser.email,
                obra: obraSelect ? obraSelect.options[obraSelect.selectedIndex].text : "Gen√©rica",
                archivoBase64: archivoBase64
            };

            google.script.run
                .withSuccessHandler(function (res) {
                    console.log('[SST] Respuesta registrarIngreso:', JSON.stringify(res));

                    if (res.status === 'success') {
                        // Guardar la obra seleccionada para pre-rellenar el formulario de inspecci√≥n
                        _obraSeleccionada = obraSelect
                            ? obraSelect.options[obraSelect.selectedIndex].text
                            : '';
                        console.log('[SST] Obra guardada:', _obraSeleccionada);

                        // Limpiar formulario
                        archivoBase64 = null;
                        const cont = document.getElementById('asis-preview-container');
                        if (cont) cont.classList.add('hidden');

                        // Mostrar el panel de trabajo DIRECTAMENTE
                        switchModule('inspeccion');

                        // Mostrar el bot√≥n de salida
                        const exitSection = document.getElementById('exit-section');
                        if (exitSection) exitSection.classList.remove('hidden');

                        // Bloquear el campo empresa con la obra seleccionada
                        _intentarBloqueoEmpresa();

                        // Notificaci√≥n amigable (no bloqueante)
                        mostrarNotificacion('‚úÖ ' + res.message, 'success');
                    } else {
                        alert("‚ö†Ô∏è " + res.message);
                    }

                    // Restaurar bot√≥n
                    if (btn) btn.disabled = false;
                    if (spinner) spinner.classList.add('hidden');
                    if (btnText) btnText.textContent = "INICIAR JORNADA";
                    if (btnIcon) btnIcon.classList.remove('hidden');
                })
                .withFailureHandler(function (err) {
                    console.error("[SST] Error en registrarIngreso:", err);
                    alert("‚ùå Error: " + err.toString());
                    if (btn) btn.disabled = false;
                    if (spinner) spinner.classList.add('hidden');
                    if (btnText) btnText.textContent = "INICIAR JORNADA";
                    if (btnIcon) btnIcon.classList.remove('hidden');
                }).registrarIngreso(payload);
        });
    }

    /**
     * Muestra una notificaci√≥n tipo toast no-bloqueante
     */
    function mostrarNotificacion(mensaje, tipo) {
        const toast = document.createElement('div');
        toast.className = `fixed bottom-8 left-1/2 -translate-x-1/2 z-[100] px-6 py-4 rounded-2xl shadow-2xl backdrop-blur-xl border font-bold text-xs uppercase tracking-widest animate-slide-up flex items-center space-x-3 min-w-[300px] justify-center ${tipo === 'success'
            ? 'bg-green-500/10 border-green-500/20 text-green-400'
            : 'bg-red-500/10 border-red-500/20 text-red-400'
            }`;

        const icon = tipo === 'success' ? 'check_circle' : 'error';
        toast.innerHTML = `<span class="material-symbols-outlined text-lg">${icon}</span><span>${mensaje}</span>`;

        document.body.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translate(-50%, 20px)';
            toast.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
            setTimeout(() => toast.remove(), 500);
        }, 3500);
    }

    // ================================================================
    // GESTI√ìN DE SALIDA (MODAL)
    // ================================================================

    function openExitModal() {
        document.getElementById('exit-modal').classList.remove('hidden');
    }

    function closeExitModal() {
        document.getElementById('exit-modal').classList.add('hidden');
        const prev = document.getElementById('exit-preview-container');
        const label = document.getElementById('exit-foto-label');
        if (prev) prev.classList.add('hidden');
        // Mostrar el label de nuevo por si cancel√≥ para volver a intentar
        if (label) label.classList.remove('hidden');
        archivoBase64 = null;
    }

    function previewSalida(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                archivoBase64 = e.target.result;
                const prev = document.getElementById('exit-img-preview');
                const cont = document.getElementById('exit-preview-container');
                const label = document.getElementById('exit-foto-label');
                if (prev) prev.src = e.target.result;
                if (cont) cont.classList.remove('hidden');
                // Ocultar bot√≥n de captura
                if (label) label.classList.add('hidden');
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function submitSalida() {
        if (!archivoBase64) {
            alert("‚ö†Ô∏è Debe capturar la foto de salida.");
            return;
        }

        const btn = document.getElementById('btn-submit-salida');
        const spinner = document.getElementById('exit-spinner');
        if (btn) btn.disabled = true;
        if (spinner) spinner.classList.remove('hidden');

        // ‚îÄ‚îÄ PASO 1: Registrar salida en el backend (fire-and-forget) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // No esperamos la respuesta del servidor para cerrar sesi√≥n.
        // La sesi√≥n se cierra SIEMPRE, independientemente del resultado del backend.
        google.script.run
            .withSuccessHandler(function (r) { console.log("[SST] registrarSalida:", r.status); })
            .withFailureHandler(function (e) { console.warn("[SST] registrarSalida error:", e); })
            .registrarSalida({
                userEmail: currentUser ? currentUser.email : '',
                archivoBase64: archivoBase64
            });

        // ‚îÄ‚îÄ PASO 2: Cerrar modal, notificar y limpiar almacenamiento ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        closeExitModal();
        if (btn) btn.disabled = false;
        if (spinner) spinner.classList.add('hidden');
        mostrarNotificacion("üëã Jornada finalizada. Cerrando sesi√≥n...", "success");
        localStorage.clear();
        sessionStorage.clear();

        // ‚îÄ‚îÄ PASO 3: Obtener URL real del script y navegar al Login ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Usamos getScriptUrl() porque es la fuente m√°s confiable en GAS.
        // SERVER_URL puede quedar vac√≠o si el bloque try{} de Index.html falla.
        google.script.run
            .withSuccessHandler(_irAlLogin)
            .withFailureHandler(function () {
                // Fallback: SERVER_URL si el API falla
                if (typeof SERVER_URL !== 'undefined' && SERVER_URL) {
                    _irAlLogin(SERVER_URL);
                } else {
                    alert("Error al cerrar sesi√≥n. Cierre la pesta√±a manualmente.");
                }
            })
            .getScriptUrl();
    }

    // ================================================================
    // CARGA DE DATOS
    // ================================================================

    function cargarObrasAsistencia() {
        google.script.run
            .withSuccessHandler(function (response) {
                const select = document.getElementById('idObraAsistencia');
                if (!select) return;
                if (response.status === "success" && response.data && response.data.length > 0) {
                    select.innerHTML = '<option value="">Seleccione la obra...</option>';
                    response.data.forEach(clie => {
                        const opt = document.createElement('option');
                        opt.value = clie.id;
                        opt.textContent = clie.nombre;
                        select.appendChild(opt);
                    });
                } else {
                    select.innerHTML = '<option value="">No hay obras registradas</option>';
                }
            })
            .withFailureHandler(function () {
                const select = document.getElementById('idObraAsistencia');
                if (select) select.innerHTML = '<option value="">Error al cargar obras</option>';
            })
            .obtenerClientesRegistrados();
    }

    function cargarOtrasOpciones() {
        google.script.run.withSuccessHandler(llenarClientes).obtenerClientesRegistrados();
        configurarFormulario();
    }

    // ================================================================
    // M√ìDULO: INSPECCI√ìN
    // ================================================================

    function cargarClientes() {
        google.script.run.withSuccessHandler(llenarClientes).obtenerClientesRegistrados();
    }

    function llenarClientes(response) {
        const select = document.getElementById('idCliente');
        if (!select) return;
        if (response.status === 'success') {
            select.innerHTML = '<option value="">Seleccione la empresa...</option>';
            response.data.forEach(function (clie) {
                const opt = document.createElement('option');
                opt.value = clie.id;
                opt.textContent = clie.nombre;
                select.appendChild(opt);
            });
            _clientesCargados = true;
            // Intentar bloquear (puede que la obra ya se haya detectado)
            _intentarBloqueoEmpresa();
        } else {
            select.innerHTML = '<option value="">Error al cargar clientes</option>';
        }
    }

    /**
     * Carga los formatos espec√≠ficos de una empresa/obra.
     */
    function cargarFormatos(nombreObra) {
        const selectFmt = document.getElementById('idFormato');
        if (!selectFmt) return;
        selectFmt.innerHTML = '<option value="">Cargando formatos...</option>';

        google.script.run
            .withSuccessHandler(function (res) {
                if (res.status === 'success') {
                    _formatosDisponibles = res.data;
                    selectFmt.innerHTML = '<option value="">Seleccione un formato...</option>';
                    if (_formatosDisponibles.length === 0) {
                        selectFmt.innerHTML = '<option value="">Sin formatos registrados</option>';
                    }
                    _formatosDisponibles.forEach(function (f) {
                        const op = document.createElement('option');
                        op.value = f.id;
                        op.textContent = f.id + ' - ' + f.descripcion;
                        selectFmt.appendChild(op);
                    });
                } else {
                    selectFmt.innerHTML = '<option value="">Error al cargar formatos</option>';
                }
            })
            .obtenerFormatosPorEmpresa(nombreObra);

        // Cargar tambi√©n los pendientes para cierre
        cargarPendientes();
    }

    /**
     * Se dispara al seleccionar un formato en el combo.
     */
    function onCambioFormato(select) {
        const descCont = document.getElementById('formato-descripcion-container');
        const descText = document.getElementById('formato-descripcion-text');
        if (!descCont || !descText) return;

        const fmtId = select.value;
        const fmtData = _formatosDisponibles.find(f => f.id === fmtId);

        if (fmtData) {
            descText.textContent = fmtData.descripcion;
            descCont.classList.remove('hidden');
        } else {
            descCont.classList.add('hidden');
        }
    }

    /**
     * Coordinador: bloquea el campo empresa SOLO cuando ya se
     * cargaron los clientes Y se conoce la obra de la jornada activa.
     * Resuelve la race-condition entre llenarClientes() y verificarEstadoAsistencia().
     */
    function _intentarBloqueoEmpresa() {
        if (!_obraSeleccionada || !_clientesCargados) return;
        var select = document.getElementById('idCliente');
        if (!select) return;

        // Primero auto-seleccionar la opci√≥n correcta
        var obraLower = _obraSeleccionada.trim().toLowerCase();
        for (var i = 0; i < select.options.length; i++) {
            if (select.options[i].text.trim().toLowerCase() === obraLower) {
                select.selectedIndex = i;
                console.log('[SST] Obra auto-seleccionada:', _obraSeleccionada);
                break;
            }
        }
        // Ahora bloquear visualmente
        bloquearCampoEmpresa(select);

        // DISPARAR CARGA DE FORMATOS PARA ESTA OBRA
        cargarFormatos(_obraSeleccionada);
    }

    /**
     * Reemplaza el select de empresa/proyecto por un campo bloqueado.
     * Garantiza que cada hallazgo quede vinculado a la obra de la jornada activa.
     */
    function bloquearCampoEmpresa(select) {
        if (!select) select = document.getElementById('idCliente');
        if (!select) return;

        var id = select.value;
        var texto = select.options[select.selectedIndex]
            ? select.options[select.selectedIndex].text
            : _obraSeleccionada;

        // Contenedor padre del select
        var wrapper = select.parentNode;

        // Ocultar el select original (no disabled, para que siga siendo accesible por JS)
        select.style.display = 'none';

        // Ocultar bot√≥n "Actualizar" (innecesario cuando est√° bloqueado)
        var btnActualizar = wrapper.parentNode
            ? wrapper.parentNode.querySelector('[onclick="cargarClientes()"]')
            : null;
        if (btnActualizar) btnActualizar.style.display = 'none';

        // Insertar campo visual bloqueado (si no existe)
        var bloqueado = document.getElementById('idCliente-bloqueado');
        if (!bloqueado) {
            bloqueado = document.createElement('div');
            bloqueado.id = 'idCliente-bloqueado';
            bloqueado.style.cssText = [
                'display:flex', 'align-items:center', 'gap:.6rem',
                'background:rgba(197,160,72,.07)',
                'border:1px solid rgba(197,160,72,.3)',
                'border-radius:.75rem',
                'padding:.75rem 1rem',
                'cursor:not-allowed'
            ].join(';');
            bloqueado.innerHTML =
                '<span class="material-symbols-outlined" style="font-size:18px;color:var(--color-primario);flex-shrink:0;">lock</span>' +
                '<div style="flex:1;min-width:0;">' +
                '<p id="idCliente-bloqueado-texto" style="font-size:.9rem;font-weight:700;color:#f8fafc;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + texto + '</p>' +
                '<p style="font-size:.65rem;text-transform:uppercase;letter-spacing:.07em;color:rgba(197,160,72,.65);font-weight:700;margin-top:2px;">Fija para esta jornada</p>' +
                '</div>';
            wrapper.insertBefore(bloqueado, select);
        } else {
            // Actualizar texto si ya exist√≠a
            var t = document.getElementById('idCliente-bloqueado-texto');
            if (t) t.textContent = texto;
        }

        // Asegurar que el hidden input exista y tenga el valor correcto
        var hidden = document.getElementById('idCliente-hidden');
        if (!hidden) {
            hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.id = 'idCliente-hidden';
            hidden.name = 'idCliente-backup';
            wrapper.appendChild(hidden);
        }
        hidden.value = id;

        // Redirigir la lectura del ID al hidden input desde configurarFormulario()
        // actualizando el value del select oculto tambi√©n para que el c√≥digo existente funcione
        // (configurarFormulario() lee selectCliente.value que sigue accesible)
        console.log('[SST] Campo empresa BLOQUEADO. ID:', id, '| Obra:', texto);
    }


    function previewImagen(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            nombreArchivo = input.files[0].name;
            reader.onload = function (e) {
                archivoBase64 = e.target.result;
                const previewCont = document.getElementById('preview-container');
                const imgP = document.getElementById('img-preview');
                if (imgP) imgP.src = e.target.result;
                if (previewCont) previewCont.classList.remove('hidden');
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function configurarFormulario() {
        // Los botones de acci√≥n llaman directamente a enviarInspeccion(modo)
        // mediante onclick ‚Äî no se usa el evento submit del form.
    }

    /**
     * Env√≠a el formulario de inspecci√≥n.
     * @param {'pendiente'|'firma'} modo
     *   'pendiente' ‚Üí guarda con estado PENDIENTE y recarga la lista de pendientes.
     *   'firma'     ‚Üí guarda con estado PENDIENTE y abre el modal de firma
     *                 para capturar la firma inmediatamente.
     */
    function enviarInspeccion(modo) {
        const btnP = document.getElementById('btn-pendiente');
        const btnF = document.getElementById('btn-con-firma');
        const spP  = document.getElementById('spinner-pendiente');
        const spF  = document.getElementById('spinner-firma');

        const selectCliente = document.getElementById('idCliente');
        const selectFormato = document.getElementById('idFormato');
        const fmtData = _formatosDisponibles.find(
            function(f) { return f.id === (selectFormato ? selectFormato.value : ''); }
        );

        // Validar campos m√≠nimos
        if (!selectFormato || !selectFormato.value || !archivoBase64) {
            mostrarNotificacion('‚ö†Ô∏è Por favor seleccione un formato y capture la foto.', 'warning');
            return;
        }

        // Deshabilitar ambos botones y mostrar spinner del bot√≥n presionado
        if (btnP) btnP.disabled = true;
        if (btnF) btnF.disabled = true;
        if (modo === 'pendiente' && spP) spP.classList.remove('hidden');
        if (modo === 'firma'     && spF) spF.classList.remove('hidden');

        const formData = {
            userCode:            currentUser.codigo || '',
            nombreCliente:       selectCliente
                                    ? selectCliente.options[selectCliente.selectedIndex].text
                                    : _obraSeleccionada,
            idFormato:           selectFormato.value,
            descripcionRegistro: fmtData ? fmtData.descripcion : '',
            archivoBase64:       archivoBase64
        };

        function _resetBotones() {
            if (btnP) btnP.disabled = false;
            if (btnF) btnF.disabled = false;
            if (spP)  spP.classList.add('hidden');
            if (spF)  spF.classList.add('hidden');
        }

        function _resetFormulario() {
            archivoBase64 = null;
            const form = document.getElementById('sst-form');
            if (form) form.reset();
            const prev = document.getElementById('preview-container');
            if (prev) prev.classList.add('hidden');
            const descCont = document.getElementById('formato-descripcion-container');
            if (descCont) descCont.classList.add('hidden');
            _intentarBloqueoEmpresa();
        }

        google.script.run
            .withSuccessHandler(function(res) {
                _resetBotones();
                if (res.status === 'success') {
                    _resetFormulario();
                    if (modo === 'firma') {
                        mostrarNotificacion('‚úÖ Formato guardado. Capture la firma del jefe SST.', 'success');
                        abrirModalFirma(res.data.id);
                    } else {
                        mostrarNotificacion('‚úÖ ' + res.message, 'success');
                        cargarPendientes();
                    }
                } else {
                    mostrarNotificacion('‚ùå ' + res.message, 'error');
                }
            })
            .withFailureHandler(function(err) {
                _resetBotones();
                mostrarNotificacion('‚ùå Error: ' + err.toString(), 'error');
            })
            .guardarRegistroFormato(formData);
    }
    /**
     * Gesti√≥n de registros pendientes
     */
    function cargarPendientes() {
        if (!currentUser || !currentUser.email) return;
        const cont = document.getElementById('pendientes-container');
        const list = document.getElementById('lista-pendientes');
        if (!list) return;

        google.script.run
            .withSuccessHandler(function (res) {
                if (res.status === 'success' && res.data.length > 0) {
                    if (cont) cont.classList.remove('hidden');
                    renderizarPendientes(res.data);
                } else {
                    if (cont) cont.classList.add('hidden');
                }
            })
            .obtenerRegistrosPendientes(currentUser.email);
    }

    // Cache para filtrado
    let _registrosPendientes = [];

    function renderizarPendientes(registros) {
        _registrosPendientes = registros;
        const badge = document.getElementById('badge-pendientes');
        if (badge) badge.textContent = registros.length + ' pendiente' + (registros.length !== 1 ? 's' : '');
        _renderCards(registros);
    }

    function _renderCards(registros) {
        const list = document.getElementById('lista-pendientes');
        if (!list) return;
        list.innerHTML = '';

        if (registros.length === 0) {
            list.innerHTML = '<p class="text-center text-xs text-slate-600 italic py-4">Sin resultados</p>';
            return;
        }

        registros.forEach(function (reg) {
            const card = document.createElement('div');
            card.className = 'pendiente-card bg-white/5 border border-amber-500/20 rounded-xl p-3 animate-fade-in';
            card.dataset.id  = reg.id;
            card.dataset.fmt = (reg.formato + ' ' + reg.descripcion).toLowerCase();

            card.innerHTML = `
                <div class="flex items-start justify-between gap-2">
                    <div style="min-width:0; flex:1;">
                        <div class="flex items-center gap-1.5 mb-1">
                            <span class="inline-block w-2 h-2 rounded-full bg-amber-400 shrink-0"></span>
                            <p class="text-[10px] font-black text-amber-400 uppercase tracking-tight">${reg.id}</p>
                        </div>
                        <p class="text-xs font-bold text-white truncate leading-tight">${reg.formato}</p>
                        <p class="text-[10px] text-slate-400 truncate leading-tight">${reg.descripcion}</p>
                        <p class="text-[9px] text-slate-600 font-bold mt-1 flex items-center gap-1">
                            <span class="material-symbols-outlined text-[10px]">schedule</span>${reg.fecha}
                        </p>
                    </div>
                    <button onclick="abrirModalFirma('${reg.id}')"
                        class="shrink-0 flex items-center gap-1 bg-green-600/15 hover:bg-green-600/30 text-green-400 border border-green-500/30 px-3 py-2 rounded-lg text-[9px] font-black uppercase tracking-widest transition-all active:scale-95">
                        <span class="material-symbols-outlined text-sm">verified</span>Firmar
                    </button>
                </div>
            `;
            list.appendChild(card);
        });
    }

    /**
     * Filtra las tarjetas de pendientes en tiempo real (client-side).
     */
    function filtrarPendientes(query) {
        if (!query || query.trim() === '') {
            _renderCards(_registrosPendientes);
            return;
        }
        const q = query.trim().toLowerCase();
        const filtrados = _registrosPendientes.filter(function (r) {
            return r.id.toLowerCase().includes(q)
                || r.formato.toLowerCase().includes(q)
                || r.descripcion.toLowerCase().includes(q);
        });
        _renderCards(filtrados);
    }

    // ‚îÄ‚îÄ Estado interno del modal de firma ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let _firmaBase64 = null;
    let _firmaIdRegistro = '';

    /**
     * Abre el modal de captura de firma para un registro pendiente.
     */
    function abrirModalFirma(idRegistro) {
        _firmaBase64 = null;
        _firmaIdRegistro = idRegistro;

        // Reset visual del modal
        const preview = document.getElementById('firma-preview-container');
        const label   = document.getElementById('firma-foto-label');
        const input   = document.getElementById('firma-foto');
        const idLabel = document.getElementById('firma-modal-id');
        if (preview) preview.classList.add('hidden');
        if (label)   label.classList.remove('hidden');
        if (input)   input.value = '';
        if (idLabel) idLabel.textContent = 'Registro: ' + idRegistro;

        const modal = document.getElementById('firma-modal');
        if (modal) modal.classList.remove('hidden');
    }

    function cerrarModalFirma() {
        _firmaBase64 = null;
        _firmaIdRegistro = '';
        const modal = document.getElementById('firma-modal');
        if (modal) modal.classList.add('hidden');
    }

    /**
     * Muestra la preview de la foto de firma.
     */
    function previewFirma(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                _firmaBase64 = e.target.result;
                const prev  = document.getElementById('firma-img-preview');
                const cont  = document.getElementById('firma-preview-container');
                const label = document.getElementById('firma-foto-label');
                if (prev)  prev.src = e.target.result;
                if (cont)  cont.classList.remove('hidden');
                if (label) label.classList.add('hidden');
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    /**
     * Env√≠a el cierre con firma al backend.
     */
    function submitFirma() {
        if (!_firmaBase64) {
            mostrarNotificacion('‚ö†Ô∏è Capture la foto del formato firmado antes de confirmar.', 'error');
            return;
        }

        const btn     = document.getElementById('btn-submit-firma');
        const spinner = document.getElementById('firma-spinner');
        if (btn)     btn.disabled = true;
        if (spinner) spinner.classList.remove('hidden');

        google.script.run
            .withSuccessHandler(function (res) {
                if (btn)     btn.disabled = false;
                if (spinner) spinner.classList.add('hidden');
                cerrarModalFirma();
                if (res.status === 'success') {
                    mostrarNotificacion('‚úÖ ' + res.message, 'success');
                    cargarPendientes();
                } else {
                    mostrarNotificacion('‚ùå ' + res.message, 'error');
                }
            })
            .withFailureHandler(function (err) {
                if (btn)     btn.disabled = false;
                if (spinner) spinner.classList.add('hidden');
                mostrarNotificacion('‚ùå Error: ' + err.toString(), 'error');
            })
            .cerrarRegistroFormato(_firmaIdRegistro, _firmaBase64);
    }

    /** @deprecated ‚Äî reemplazado por abrirModalFirma */
    function confirmarCierrePendiente(id) {
        abrirModalFirma(id);
    }

    // ================================================================
    // M√ìDULO: ADMINISTRACI√ìN DE CLIENTES/EMPRESAS
    // ================================================================

    let _clientesAdmin   = [];   // Cache completo de clientes
    let _filtroAdmin     = 'todas'; // Filtro activo actual
    let _clienteEditando = null; // Cliente en edici√≥n (null = nuevo)

    /**
     * Muestra el workspace del m√≥dulo admin seleccionado y oculta el portal.
     */
    function abrirModuloAdmin(modulo) {
        const portal = document.getElementById('admin-portal');
        if (portal) portal.classList.add('hidden');

        if (modulo === 'clientes') {
            const workspace = document.getElementById('admin-workspace-clientes');
            if (workspace) workspace.classList.remove('hidden');
            actualizarModuloHeader('Gesti√≥n de Empresas');
            cargarClientesAdmin();
        } else if (modulo === 'asistencia') {
            const workspace = document.getElementById('admin-workspace-asistencia');
            if (workspace) workspace.classList.remove('hidden');
            actualizarModuloHeader('Control de Asistencia');
            cargarAsistenciaAdmin();
        } else if (modulo === 'usuarios') {
            const workspace = document.getElementById('admin-workspace-usuarios');
            if (workspace) workspace.classList.remove('hidden');
            actualizarModuloHeader('Gesti√≥n de Usuarios');
            cargarUsuariosAdmin();
        } else if (modulo === 'formatos') {
            const workspace = document.getElementById('admin-workspace-formatos');
            if (workspace) workspace.classList.remove('hidden');
            actualizarModuloHeader('Gestor de Formatos');
            cargarFormatosAdmin();
        }
    }

    /**
     * Regresa al portal principal de m√≥dulos del administrador.
     */
    function volverAlPortalAdmin() {
        const portal = document.getElementById('admin-portal');
        if (portal) portal.classList.remove('hidden');

        // Ocultar todos los workspaces
        ['admin-workspace-clientes', 'admin-workspace-asistencia', 'admin-workspace-usuarios', 'admin-workspace-formatos'].forEach(function(id) {
            var ws = document.getElementById(id);
            if (ws) ws.classList.add('hidden');
        });

        actualizarModuloHeader('Administraci√≥n');
        _filtroAdmin = 'todas';
    }

    /**
     * Carga todos los clientes desde el servidor y actualiza ambas vistas (tabla y tarjetas).
     */
    function cargarClientesAdmin() {
        // Estado de carga ‚Äî tabla (escritorio)
        var tbody = document.getElementById('tabla-clientes-body');
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="10" class="text-center py-10 text-slate-500 text-xs italic">' +
                '<div class="flex flex-col items-center gap-2">' +
                '<div class="animate-spin h-6 w-6 border-2 border-primary/30 border-t-primary rounded-full"></div>' +
                '<span>Cargando empresas...</span></div></td></tr>';
        }
        // Estado de carga ‚Äî tarjetas (m√≥vil)
        var listaMov = document.getElementById('lista-clientes-mobile');
        if (listaMov) {
            listaMov.innerHTML = '<div class="flex flex-col items-center gap-2 py-8 text-slate-500 text-xs italic">' +
                '<div class="animate-spin h-6 w-6 border-2 border-primary/30 border-t-primary rounded-full"></div>' +
                '<span>Cargando...</span></div>';
        }

        google.script.run
            .withSuccessHandler(function (res) {
                if (res.status === 'success') {
                    _clientesAdmin = res.data || [];
                    actualizarStatsClientes();
                    filtrarClientes(_filtroAdmin);
                } else {
                    mostrarNotificacion('‚ùå ' + res.message, 'error');
                    if (tbody) tbody.innerHTML = '<tr><td colspan="10" class="text-center py-8 text-red-400 text-xs">Error al cargar datos</td></tr>';
                    if (listaMov) listaMov.innerHTML = '<div class="text-center py-6 text-red-400 text-xs">Error al cargar datos</div>';
                }
            })
            .withFailureHandler(function (err) {
                mostrarNotificacion('‚ùå Error de conexi√≥n: ' + err.toString(), 'error');
            })
            .obtenerListaClientesAdmin();
    }

    /**
     * Actualiza los contadores en las tarjetas de estad√≠sticas.
     */
    function actualizarStatsClientes() {
        const total     = _clientesAdmin.length;
        const activas   = _clientesAdmin.filter(function(c) { return c.estado === 'ACTIVO'; }).length;
        const inactivas = _clientesAdmin.filter(function(c) { return c.estado === 'INACTIVO'; }).length;

        var elTotal     = document.getElementById('stat-total');
        var elActivas   = document.getElementById('stat-activas');
        var elInactivas = document.getElementById('stat-inactivas');

        if (elTotal)     elTotal.querySelector('.stat-num').textContent     = total;
        if (elActivas)   elActivas.querySelector('.stat-num').textContent   = activas;
        if (elInactivas) elInactivas.querySelector('.stat-num').textContent = inactivas;
    }

    /**
     * Filtra la lista de clientes seg√∫n el tipo y actualiza los pills.
     * @param {string} tipo 'todas' | 'activas' | 'inactivas'
     */
    function filtrarClientes(tipo) {
        _filtroAdmin = tipo;

        // Actualizar estilos de los pills
        document.querySelectorAll('[data-filtro]').forEach(function (btn) {
            const isActive = btn.dataset.filtro === tipo;
            btn.style.backgroundColor = isActive ? 'rgba(197,160,72,0.18)' : 'rgba(255,255,255,0.05)';
            btn.style.borderColor     = isActive ? 'rgba(197,160,72,0.40)' : 'rgba(255,255,255,0.10)';
            btn.style.color           = isActive ? 'var(--color-primario)'  : 'rgb(148,163,184)';
        });

        // Filtrar y renderizar
        var filtrados = _clientesAdmin;
        if (tipo === 'activas')   filtrados = _clientesAdmin.filter(function(c) { return c.estado === 'ACTIVO'; });
        if (tipo === 'inactivas') filtrados = _clientesAdmin.filter(function(c) { return c.estado === 'INACTIVO'; });

        renderizarTablaClientes(filtrados);
    }

    /**
     * Genera filas de la tabla (escritorio) y tarjetas (m√≥vil) con la lista de clientes.
     * @param {Array} clientes Lista filtrada de clientes.
     */
    function renderizarTablaClientes(clientes) {
        // Renderizar vista m√≥vil primero (siempre)
        _renderCardsMovil(clientes);

        const tbody = document.getElementById('tabla-clientes-body');
        if (!tbody) return;

        if (!clientes || clientes.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" class="text-center py-10 text-slate-500 text-xs italic">' +
                '<div class="flex flex-col items-center gap-2">' +
                '<span class="material-symbols-outlined text-3xl">search_off</span>' +
                '<span>Sin registros para mostrar</span></div></td></tr>';
            return;
        }

        tbody.innerHTML = clientes.map(function (c) {
            const esActivo    = c.estado === 'ACTIVO';
            const badgeClases = esActivo
                ? 'bg-green-500/15 text-green-400 border border-green-500/30'
                : 'bg-red-500/15 text-red-400 border border-red-500/30';
            const toggleIcon  = esActivo ? 'toggle_on' : 'toggle_off';
            const toggleTip   = esActivo ? 'Desactivar' : 'Activar';
            const toggleClase = esActivo
                ? 'bg-amber-500/10 hover:bg-amber-500/20 text-amber-400 border border-amber-500/20'
                : 'bg-green-500/10 hover:bg-green-500/20 text-green-400 border border-green-500/20';

            return '<tr class="border-b border-white/5 hover:bg-white/5 transition-colors' + (esActivo ? '' : ' opacity-55') + '">' +
                '<td class="px-3 py-3 text-[11px] font-black whitespace-nowrap" style="color:var(--color-primario)">' + _esc(c.id) + '</td>' +
                '<td class="px-3 py-3 text-xs font-bold text-white whitespace-nowrap">' + _esc(c.nombre) + '</td>' +
                '<td class="px-3 py-3 text-[11px] text-slate-400 whitespace-nowrap">' + (c.nit || '<span class="text-slate-600">-</span>') + '</td>' +
                '<td class="px-3 py-3 text-[11px] text-slate-400 whitespace-nowrap">' + (c.correo || '<span class="text-slate-600">-</span>') + '</td>' +
                '<td class="px-3 py-3 text-[11px] text-slate-400 whitespace-nowrap">' + (c.direccion || '<span class="text-slate-600">-</span>') + '</td>' +
                '<td class="px-3 py-3 text-[11px] text-slate-400 whitespace-nowrap">' + (c.contacto || '<span class="text-slate-600">-</span>') + '</td>' +
                '<td class="px-3 py-3 text-[11px] text-slate-400 whitespace-nowrap">' + (c.celular || '<span class="text-slate-600">-</span>') + '</td>' +
                '<td class="px-3 py-3 text-[11px] text-slate-400 whitespace-nowrap">' + (c.obra || '<span class="text-slate-600">-</span>') + '</td>' +
                '<td class="px-3 py-3 whitespace-nowrap">' +
                    '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[9px] font-black uppercase tracking-widest ' + badgeClases + '">' + c.estado + '</span>' +
                '</td>' +
                '<td class="px-3 py-3 whitespace-nowrap">' +
                    '<div class="flex items-center gap-1">' +
                        '<button onclick="abrirModalClientePorId(\'' + _esc(c.id) + '\')" ' +
                            'class="p-1.5 rounded-lg bg-primary/10 hover:bg-primary/20 text-primary border border-primary/20 transition-all" title="Editar">' +
                            '<span class="material-symbols-outlined text-sm">edit</span>' +
                        '</button>' +
                        '<button onclick="toggleEstadoCliente(\'' + _esc(c.id) + '\',\'' + c.estado + '\')" ' +
                            'class="p-1.5 rounded-lg ' + toggleClase + ' transition-all" title="' + toggleTip + '">' +
                            '<span class="material-symbols-outlined text-sm">' + toggleIcon + '</span>' +
                        '</button>' +
                        '<button onclick="confirmarEliminarCliente(\'' + _esc(c.id) + '\',\'' + _escAttr(c.nombre) + '\')" ' +
                            'class="p-1.5 rounded-lg bg-red-500/10 hover:bg-red-500/20 text-red-400 border border-red-500/20 transition-all" title="Eliminar">' +
                            '<span class="material-symbols-outlined text-sm">delete</span>' +
                        '</button>' +
                    '</div>' +
                '</td>' +
            '</tr>';
        }).join('');
    }

    /** Escapa texto para insertar en contenido HTML */
    function _esc(str) {
        return (str || '').toString()
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
    }

    /** Escapa texto para insertar en atributo onclick (comillas simples ya usadas) */
    function _escAttr(str) {
        return (str || '').toString()
            .replace(/\\/g, '\\\\')
            .replace(/'/g, "\\'");
    }

    /**
     * Renderiza la vista de tarjetas para pantallas m√≥viles (sm:hidden).
     * Muestra los campos clave + acciones en formato compacto y legible.
     * @param {Array} clientes Lista filtrada de clientes.
     */
    function _renderCardsMovil(clientes) {
        var lista = document.getElementById('lista-clientes-mobile');
        if (!lista) return;

        if (!clientes || clientes.length === 0) {
            lista.innerHTML = '<div class="flex flex-col items-center gap-2 py-8 text-slate-500 text-xs italic">' +
                '<span class="material-symbols-outlined text-3xl">search_off</span>' +
                '<span>Sin registros para mostrar</span></div>';
            return;
        }

        lista.innerHTML = clientes.map(function (c) {
            var esActivo    = c.estado === 'ACTIVO';
            var badgeClases = esActivo
                ? 'bg-green-500/15 text-green-400 border border-green-500/30'
                : 'bg-red-500/15 text-red-400 border border-red-500/30';
            var toggleIcon  = esActivo ? 'toggle_on' : 'toggle_off';
            var toggleLabel = esActivo ? 'Desactivar' : 'Activar';
            var toggleClase = esActivo
                ? 'bg-amber-500/10 text-amber-400 border border-amber-500/20'
                : 'bg-green-500/10 text-green-400 border border-green-500/20';

            // Campos secundarios visibles en tarjeta
            var extras = '';
            if (c.nit)     extras += '<div><span class="text-slate-600">NIT</span><br><span class="text-slate-300 font-medium">' + _esc(c.nit) + '</span></div>';
            if (c.celular) extras += '<div><span class="text-slate-600">Celular</span><br><span class="text-slate-300 font-medium">' + _esc(c.celular) + '</span></div>';
            if (c.correo)  extras += '<div class="col-span-2"><span class="text-slate-600">Correo</span><br><span class="text-slate-300 font-medium break-all">' + _esc(c.correo) + '</span></div>';

            return '<div class="bg-white/5 border border-white/10 rounded-xl p-3.5 animate-fade-in' + (esActivo ? '' : ' opacity-60') + '">' +
                // Cabecera tarjeta: ID + Nombre + Badge estado
                '<div class="flex items-start justify-between gap-2 mb-2.5">' +
                    '<div class="min-w-0 flex-1">' +
                        '<p class="text-[9px] font-black uppercase tracking-widest mb-0.5" style="color:var(--color-primario)">' + _esc(c.id) + '</p>' +
                        '<p class="text-sm font-black text-white leading-tight">' + _esc(c.nombre) + '</p>' +
                        (c.obra ? '<p class="text-[10px] text-slate-500 font-medium mt-0.5 leading-tight">' + _esc(c.obra) + '</p>' : '') +
                    '</div>' +
                    '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[9px] font-black uppercase tracking-widest shrink-0 ' + badgeClases + '">' + c.estado + '</span>' +
                '</div>' +
                // Campos secundarios
                (extras ? '<div class="grid grid-cols-2 gap-x-4 gap-y-1.5 text-[10px] mb-3 pb-3 border-b border-white/5">' + extras + '</div>' : '') +
                // Acciones
                '<div class="flex gap-2">' +
                    '<button onclick="abrirModalClientePorId(\'' + _esc(c.id) + '\')" ' +
                        'class="flex-1 flex items-center justify-center gap-1.5 py-2.5 rounded-xl bg-primary/10 text-primary border border-primary/20 text-[10px] font-black uppercase tracking-widest transition-all active:scale-95">' +
                        '<span class="material-symbols-outlined text-sm">edit</span>Editar' +
                    '</button>' +
                    '<button onclick="toggleEstadoCliente(\'' + _esc(c.id) + '\',\'' + c.estado + '\')" ' +
                        'class="flex-1 flex items-center justify-center gap-1.5 py-2.5 rounded-xl ' + toggleClase + ' border text-[10px] font-black uppercase tracking-widest transition-all active:scale-95">' +
                        '<span class="material-symbols-outlined text-sm">' + toggleIcon + '</span>' + toggleLabel +
                    '</button>' +
                    '<button onclick="confirmarEliminarCliente(\'' + _esc(c.id) + '\',\'' + _escAttr(c.nombre) + '\')" ' +
                        'class="w-10 flex items-center justify-center rounded-xl bg-red-500/10 text-red-400 border border-red-500/20 transition-all active:scale-95" title="Eliminar">' +
                        '<span class="material-symbols-outlined text-sm">delete</span>' +
                    '</button>' +
                '</div>' +
            '</div>';
        }).join('');
    }

    /**
     * Abre el modal de creaci√≥n/edici√≥n buscando el cliente por ID en el cach√©.
     */
    function abrirModalClientePorId(id) {
        var cliente = _clientesAdmin.find(function(c) { return c.id === id; }) || null;
        abrirModalCliente(cliente);
    }

    /**
     * Abre el modal de cliente.
     * @param {Object|null} cliente null = modo creaci√≥n, objeto = modo edici√≥n
     */
    function abrirModalCliente(cliente) {
        _clienteEditando = cliente;
        var modal  = document.getElementById('modal-cliente');
        var titulo = document.getElementById('modal-cliente-titulo');
        var estadoWrapper = document.getElementById('mc-estado-wrapper');
        if (!modal) return;

        // Poblar campos
        document.getElementById('mc-id').value        = cliente ? cliente.id        : '';
        document.getElementById('mc-nombre').value    = cliente ? cliente.nombre    : '';
        document.getElementById('mc-direccion').value = cliente ? cliente.direccion : '';
        document.getElementById('mc-nit').value       = cliente ? cliente.nit       : '';
        document.getElementById('mc-correo').value    = cliente ? cliente.correo    : '';
        document.getElementById('mc-contacto').value  = cliente ? cliente.contacto  : '';
        document.getElementById('mc-celular').value   = cliente ? cliente.celular   : '';
        document.getElementById('mc-obra').value      = cliente ? cliente.obra      : '';
        var selectEstado = document.getElementById('mc-estado');
        if (selectEstado) selectEstado.value = cliente ? cliente.estado : 'ACTIVO';

        if (titulo) titulo.textContent = cliente ? 'Editar Empresa' : 'Nueva Empresa';

        // El campo Estado solo es editable al editar (no al crear)
        if (estadoWrapper) estadoWrapper.classList.toggle('hidden', !cliente);

        modal.classList.remove('hidden');
    }

    /**
     * Cierra el modal de cliente y limpia el estado.
     */
    function cerrarModalCliente() {
        var modal = document.getElementById('modal-cliente');
        if (modal) modal.classList.add('hidden');
        _clienteEditando = null;
    }

    /**
     * Env√≠a el formulario de creaci√≥n/edici√≥n al servidor.
     */
    function guardarClienteAdmin() {
        var nombre = (document.getElementById('mc-nombre').value || '').trim();
        if (!nombre) {
            mostrarNotificacion('‚ö†Ô∏è El nombre de la empresa es obligatorio.', 'error');
            return;
        }

        var data = {
            id:        (document.getElementById('mc-id').value || '').trim(),
            nombre:    nombre,
            direccion: (document.getElementById('mc-direccion').value || '').trim(),
            nit:       (document.getElementById('mc-nit').value || '').trim(),
            correo:    (document.getElementById('mc-correo').value || '').trim(),
            contacto:  (document.getElementById('mc-contacto').value || '').trim(),
            celular:   (document.getElementById('mc-celular').value || '').trim(),
            obra:      (document.getElementById('mc-obra').value || '').trim(),
            estado:    (document.getElementById('mc-estado') ? document.getElementById('mc-estado').value : 'ACTIVO')
        };

        var btn     = document.getElementById('btn-guardar-cliente');
        var spinner = document.getElementById('spinner-guardar-cliente');
        if (btn)     btn.disabled = true;
        if (spinner) spinner.classList.remove('hidden');

        google.script.run
            .withSuccessHandler(function (res) {
                if (btn)     btn.disabled = false;
                if (spinner) spinner.classList.add('hidden');
                if (res.status === 'success') {
                    cerrarModalCliente();
                    mostrarNotificacion('‚úÖ ' + res.message, 'success');
                    cargarClientesAdmin();
                } else {
                    mostrarNotificacion('‚ùå ' + res.message, 'error');
                }
            })
            .withFailureHandler(function (err) {
                if (btn)     btn.disabled = false;
                if (spinner) spinner.classList.add('hidden');
                mostrarNotificacion('‚ùå Error: ' + err.toString(), 'error');
            })
            .guardarCliente(data);
    }

    /**
     * Solicita confirmaci√≥n antes de eliminar un cliente.
     */
    function confirmarEliminarCliente(id, nombre) {
        if (!confirm('¬øEst√° seguro de eliminar la empresa "' + nombre + '"?\nEsta acci√≥n no se puede deshacer.')) return;
        google.script.run
            .withSuccessHandler(function (res) {
                if (res.status === 'success') {
                    mostrarNotificacion('‚úÖ ' + res.message, 'success');
                    cargarClientesAdmin();
                } else {
                    mostrarNotificacion('‚ùå ' + res.message, 'error');
                }
            })
            .withFailureHandler(function (err) {
                mostrarNotificacion('‚ùå Error: ' + err.toString(), 'error');
            })
            .eliminarCliente(id);
    }

    /**
     * Alterna el estado ACTIVO/INACTIVO de una empresa.
     * Si se desactiva, ya no aparecer√° en el selector de supervisores.
     */
    function toggleEstadoCliente(id, estadoActual) {
        var nuevoEstado = estadoActual === 'ACTIVO' ? 'INACTIVO' : 'ACTIVO';
        var msg = nuevoEstado === 'INACTIVO'
            ? '¬øDesactivar esta empresa?\nLos supervisores ya no podr√°n iniciar jornadas para ella.'
            : '¬øReactivar esta empresa?';
        if (!confirm(msg)) return;

        google.script.run
            .withSuccessHandler(function (res) {
                if (res.status === 'success') {
                    mostrarNotificacion('‚úÖ ' + res.message, 'success');
                    cargarClientesAdmin();
                } else {
                    mostrarNotificacion('‚ùå ' + res.message, 'error');
                }
            })
            .withFailureHandler(function (err) {
                mostrarNotificacion('‚ùå Error: ' + err.toString(), 'error');
            })
            .cambiarEstadoCliente(id, nuevoEstado);
    }

    // ================================================================
    // M√ìDULO: CONTROL DE ASISTENCIA (PERSONAL / SUPERVISORES)
    // ================================================================

    let _asistenciaTotal    = [];    // Cache completo de registros
    let _filtroEstadoAsist  = 'todos'; // Filtro de estado activo

    /**
     * Carga todos los registros desde el servidor.
     */
    function cargarAsistenciaAdmin() {
        var tbody  = document.getElementById('asis-tabla-body');
        var movil  = document.getElementById('asis-lista-mobile');
        var loader = '<div class="flex flex-col items-center gap-2 py-8 text-slate-500 text-xs italic">' +
                     '<div class="animate-spin h-6 w-6 border-2 border-primary/30 border-t-primary rounded-full"></div>' +
                     '<span>Cargando asistencia...</span></div>';

        if (tbody)  tbody.innerHTML  = '<tr><td colspan="10" class="py-10 text-center">' + loader + '</td></tr>';
        if (movil)  movil.innerHTML  = loader;

        // Reiniciar selects de filtro
        var selEst = document.getElementById('asis-filtro-estado');
        if (selEst) selEst.value = '';

        google.script.run
            .withSuccessHandler(function(res) {
                if (res.status === 'success') {
                    _asistenciaTotal = res.data || [];
                    _poblarSelectsAsistencia(_asistenciaTotal);
                    filtrarAsistencia();
                } else {
                    mostrarNotificacion('‚ùå ' + res.message, 'error');
                    if (tbody) tbody.innerHTML = '<tr><td colspan="10" class="text-center py-8 text-red-400 text-xs">Error al cargar datos</td></tr>';
                }
            })
            .withFailureHandler(function(err) {
                mostrarNotificacion('‚ùå Error de conexi√≥n: ' + err.toString(), 'error');
            })
            .obtenerAsistenciaAdmin();
    }

    /**
     * Puebla los <select> de supervisores y obras con los valores √∫nicos del dataset.
     * Preserva la selecci√≥n actual si el valor sigue existiendo.
     */
    function _poblarSelectsAsistencia(registros) {
        var selNombre = document.getElementById('asis-filtro-nombre');
        var selObra   = document.getElementById('asis-filtro-obra');
        if (!selNombre || !selObra) return;

        var valNombre = selNombre.value;
        var valObra   = selObra.value;

        // Supervisores √∫nicos ordenados por nombre
        var supervisores = {};
        registros.forEach(function(r) {
            if (r.email) supervisores[r.email] = r.nombre || r.email;
        });
        selNombre.innerHTML = '<option value="" style="background:#1a242f;">Todos los supervisores...</option>';
        Object.keys(supervisores).sort(function(a, b) {
            return supervisores[a].localeCompare(supervisores[b]);
        }).forEach(function(email) {
            var opt = document.createElement('option');
            opt.value = email;
            opt.textContent = supervisores[email];
            opt.style.background = '#1a242f';
            selNombre.appendChild(opt);
        });

        // Obras √∫nicas ordenadas alfab√©ticamente
        var obras = {};
        registros.forEach(function(r) { if (r.obra) obras[r.obra] = true; });
        selObra.innerHTML = '<option value="" style="background:#1a242f;">Todas las obras...</option>';
        Object.keys(obras).sort(function(a, b) { return a.localeCompare(b); }).forEach(function(obra) {
            var opt = document.createElement('option');
            opt.value = obra;
            opt.textContent = obra;
            opt.style.background = '#1a242f';
            selObra.appendChild(opt);
        });

        // Restaurar selecci√≥n previa si a√∫n existe
        if (valNombre) selNombre.value = valNombre;
        if (valObra)   selObra.value   = valObra;
    }

    /**
     * Aplica los filtros de supervisor + obra + estado y actualiza la vista.
     */
    function filtrarAsistencia() {
        var emailSel  = ((document.getElementById('asis-filtro-nombre')  || {}).value || '').trim();
        var obraSel   = ((document.getElementById('asis-filtro-obra')    || {}).value || '').trim();
        var estadoSel = ((document.getElementById('asis-filtro-estado')  || {}).value || '').trim();

        var filtrados = _asistenciaTotal.filter(function(r) {
            var coincideNombre = !emailSel  || r.email === emailSel;
            var coincideObra   = !obraSel   || (r.obra || '') === obraSel;
            var coincideEstado = !estadoSel || r.estado === estadoSel;
            return coincideNombre && coincideObra && coincideEstado;
        });

        actualizarStatsAsistencia(filtrados);
        _renderTablaAsistencia(filtrados);
        _renderCardsAsistenciaMovil(filtrados);
    }


    /**
     * Actualiza las tarjetas de estad√≠sticas seg√∫n los registros visibles.
     */
    function actualizarStatsAsistencia(registros) {
        var emailsUnicos = {};
        registros.forEach(function(r) { if (r.email) emailsUnicos[r.email] = true; });
        var supervisores = Object.keys(emailsUnicos).length;
        var activas      = registros.filter(function(r) { return r.estado === 'ACTIVO'; }).length;
        var cerradas     = registros.filter(function(r) { return r.estado === 'CERRADO'; }).length;

        var elSup  = document.getElementById('asis-stat-supervisores');
        var elTot  = document.getElementById('asis-stat-total');
        var elAct  = document.getElementById('asis-stat-activas');
        var elCer  = document.getElementById('asis-stat-cerradas');

        if (elSup) elSup.querySelector('.stat-num').textContent = supervisores;
        if (elTot) elTot.querySelector('.stat-num').textContent = registros.length;
        if (elAct) elAct.querySelector('.stat-num').textContent = activas;
        if (elCer) elCer.querySelector('.stat-num').textContent = cerradas;
    }

    /**
     * Renderiza la tabla de escritorio.
     */
    function _renderTablaAsistencia(registros) {
        var tbody = document.getElementById('asis-tabla-body');
        if (!tbody) return;

        if (!registros || registros.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-10 text-slate-500 text-xs italic">' +
                '<div class="flex flex-col items-center gap-2">' +
                '<span class="material-symbols-outlined text-3xl">search_off</span>' +
                '<span>Sin registros para mostrar</span></div></td></tr>';
            return;
        }

        tbody.innerHTML = registros.map(function(r) {
            var esActiva = r.estado === 'ACTIVO';
            var badge = esActiva
                ? '<span class="inline-flex items-center gap-1 text-[9px] font-black uppercase bg-amber-500/15 text-amber-400 border border-amber-500/30 px-2 py-0.5 rounded-lg">' +
                  '<span class="w-1.5 h-1.5 rounded-full bg-amber-400 animate-pulse"></span>ACTIVA</span>'
                : '<span class="inline-flex items-center gap-1 text-[9px] font-black uppercase bg-green-500/15 text-green-400 border border-green-500/30 px-2 py-0.5 rounded-lg">' +
                  '<span class="w-1.5 h-1.5 rounded-full bg-green-400"></span>CERRADA</span>';

            var tipoBadge = r.tipoDia === 'HABIL'
                ? '<span class="text-slate-400 text-[10px]">' + _esc(r.tipoDia) + '</span>'
                : '<span class="text-amber-400 font-bold text-[10px]">' + _esc(r.tipoDia) + '</span>';

            return '<tr class="border-b border-white/5 hover:bg-white/5 transition-colors' + (esActiva ? ' bg-amber-500/3' : '') + '">' +
                '<td class="px-3 py-2.5 text-xs font-bold text-white whitespace-nowrap">' + _esc(r.nombre) + '</td>' +
                '<td class="px-3 py-2.5 text-[11px] text-slate-300 whitespace-nowrap">' + _esc(r.fecha) + '</td>' +
                '<td class="px-3 py-2.5 text-[11px] text-green-400 font-bold whitespace-nowrap">' + (_esc(r.horaEntrada) || '-') + '</td>' +
                '<td class="px-3 py-2.5 text-[11px] whitespace-nowrap">' + (r.horaSalida ? _esc(r.horaSalida) : '<span class="text-amber-400 font-bold">En curso</span>') + '</td>' +
                '<td class="px-3 py-2.5 whitespace-nowrap">' + tipoBadge + '</td>' +
                '<td class="px-3 py-2.5 text-[11px] text-slate-300 whitespace-nowrap max-w-[160px] truncate" title="' + _escAttr(r.obra) + '">' + _esc(r.obra || '-') + '</td>' +
                '<td class="px-3 py-2.5 whitespace-nowrap">' + badge + '</td>' +
                '</tr>';
        }).join('');
    }

    /**
     * Renderiza tarjetas para la vista m√≥vil.
     */
    function _renderCardsAsistenciaMovil(registros) {
        var lista = document.getElementById('asis-lista-mobile');
        if (!lista) return;

        if (!registros || registros.length === 0) {
            lista.innerHTML = '<div class="text-center py-8 text-slate-500 text-xs italic">Sin registros para mostrar</div>';
            return;
        }

        lista.innerHTML = registros.map(function(r) {
            var esActiva = r.estado === 'ACTIVO';
            var borderClass = esActiva ? 'border-amber-500/30' : 'border-green-500/20';
            var estadoBadge = esActiva
                ? '<span class="text-[9px] font-black text-amber-400 bg-amber-500/15 border border-amber-500/30 px-2 py-0.5 rounded-lg flex items-center gap-1">' +
                  '<span class="w-1.5 h-1.5 rounded-full bg-amber-400 animate-pulse"></span>ACTIVA</span>'
                : '<span class="text-[9px] font-black text-green-400 bg-green-500/15 border border-green-500/30 px-2 py-0.5 rounded-lg flex items-center gap-1">' +
                  '<span class="w-1.5 h-1.5 rounded-full bg-green-400"></span>CERRADA</span>';

            return '<div class="bg-white/5 border ' + borderClass + ' rounded-xl p-3 animate-fade-in">' +
                '<div class="flex items-start justify-between gap-2 mb-2">' +
                '<p class="text-xs font-bold text-white">' + _esc(r.nombre) + '</p>' +
                estadoBadge + '</div>' +
                '<div class="grid grid-cols-2 gap-x-3 gap-y-1 text-[10px]">' +
                '<span class="text-slate-500">Fecha:</span><span class="text-slate-300">' + _esc(r.fecha) + '</span>' +
                '<span class="text-slate-500">Tipo d√≠a:</span><span class="' + (r.tipoDia === 'HABIL' ? 'text-slate-300' : 'text-amber-400 font-bold') + '">' + _esc(r.tipoDia || '-') + '</span>' +
                '<span class="text-slate-500">Entrada:</span><span class="text-green-400 font-bold">' + (_esc(r.horaEntrada) || '-') + '</span>' +
                '<span class="text-slate-500">Salida:</span><span class="' + (r.horaSalida ? 'text-slate-300' : 'text-amber-400 font-bold') + '">' + (r.horaSalida ? _esc(r.horaSalida) : 'En curso') + '</span>' +
                '<span class="text-slate-500">Cliente:</span><span class="text-slate-300 truncate">' + _esc(r.obra || '-') + '</span>' +
                '</div></div>';
        }).join('');
    }

    /**
     * Genera y descarga un archivo CSV con los datos de asistencia visibles.
     */
    function exportarCSVAsistencia() {
        if (!_asistenciaTotal || _asistenciaTotal.length === 0) {
            mostrarNotificacion('‚ö†Ô∏è No hay datos de asistencia para exportar.', 'warning');
            return;
        }

        var encabezado = ['Nombre_Supervisor', 'Email', 'Fecha', 'Hora_Entrada', 'Hora_Salida',
                          'Tipo_Dia', 'Cliente_Empresa', 'Estado'];

        // Usar los datos actualmente filtrados (iguales a lo visible en pantalla)
        var emailSel  = ((document.getElementById('asis-filtro-nombre')  || {}).value || '').trim();
        var obraSel   = ((document.getElementById('asis-filtro-obra')    || {}).value || '').trim();
        var estadoSel = ((document.getElementById('asis-filtro-estado')  || {}).value || '').trim();
        var datos = _asistenciaTotal.filter(function(r) {
            var n = !emailSel  || r.email === emailSel;
            var o = !obraSel   || (r.obra || '') === obraSel;
            var e = !estadoSel || r.estado === estadoSel;
            return n && o && e;
        });

        var csv = encabezado.join(',') + '\n';
        csv += datos.map(function(r) {
            return [r.nombre, r.email, r.fecha, r.horaEntrada, r.horaSalida,
                    r.tipoDia, r.obra, r.estado]
                .map(function(v) {
                    var s = (v || '').toString().replace(/"/g, '""');
                    return '"' + s + '"';
                }).join(',');
        }).join('\n');

        var blob     = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
        var url      = URL.createObjectURL(blob);
        var link     = document.createElement('a');
        var fecha    = new Date().toISOString().slice(0, 10);
        link.href    = url;
        link.download = 'Asistencia_SST_' + fecha + '.csv';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        mostrarNotificacion('‚úÖ CSV exportado con ' + datos.length + ' registros.', 'success');
    }

    // ================================================================
    // M√ìDULO: GESTI√ìN DE USUARIOS
    // ================================================================

    let _usuariosTotal   = [];   // Cache completo
    let _usrEditandoId    = null; // ID del usuario en edici√≥n (null = nuevo)
    let _usrResetId       = null; // ID del usuario en reset de contrase√±a
    let _clientesParaModal = [];  // Cache de clientes DB_CLIENTES para el selector CLI

    function cargarUsuariosAdmin() {
        var loader = '<div class="flex flex-col items-center gap-2 py-8 text-slate-500 text-xs italic">' +
                     '<div class="animate-spin h-6 w-6 border-2 border-primary/30 border-t-primary rounded-full"></div>' +
                     '<span>Cargando usuarios...</span></div>';
        var tbody = document.getElementById('usr-tabla-body');
        var movil = document.getElementById('usr-lista-mobile');
        if (tbody) tbody.innerHTML = '<tr><td colspan="8" class="py-10 text-center">' + loader + '</td></tr>';
        if (movil) movil.innerHTML = loader;

        google.script.run
            .withSuccessHandler(function(res) {
                if (res.status === 'success') {
                    _usuariosTotal = res.data || [];
                    _poblarSelectRoles();
                    filtrarUsuarios();
                } else {
                    mostrarNotificacion('‚ùå ' + res.message, 'error');
                }
            })
            .withFailureHandler(function(err) {
                mostrarNotificacion('‚ùå Error de conexi√≥n: ' + err.toString(), 'error');
            })
            .obtenerUsuariosAdmin();
    }

    function _poblarSelectRoles() {
        var sel = document.getElementById('usr-filtro-rol');
        if (!sel) return;
        var valActual = sel.value;
        var roles = {};
        _usuariosTotal.forEach(function(u) { if (u.rol) roles[u.rol] = true; });
        sel.innerHTML = '<option value="" style="background:#1a242f;">Todos los roles</option>';
        Object.keys(roles).sort().forEach(function(r) {
            var opt = document.createElement('option');
            opt.value = r; opt.textContent = r; opt.style.background = '#1a242f';
            sel.appendChild(opt);
        });
        if (valActual) sel.value = valActual;
    }

    function filtrarUsuarios() {
        var q      = ((document.getElementById('usr-filtro-texto')  || {}).value || '').trim().toLowerCase();
        var rol    = ((document.getElementById('usr-filtro-rol')    || {}).value || '').trim();
        var estado = ((document.getElementById('usr-filtro-estado') || {}).value || '').trim();

        var filtrados = _usuariosTotal.filter(function(u) {
            var coincideTexto  = !q      || u.nombre.toLowerCase().includes(q) || u.email.toLowerCase().includes(q);
            var coincideRol    = !rol    || u.rol === rol;
            var coincideEstado = !estado || u.estado === estado;
            return coincideTexto && coincideRol && coincideEstado;
        });

        _actualizarStatsUsuarios(filtrados);
        _renderTablaUsuarios(filtrados);
        _renderCardsUsuariosMobil(filtrados);
    }

    function _actualizarStatsUsuarios(registros) {
        var activos   = registros.filter(function(u) { return u.estado === 'ACTIVO'; }).length;
        var inactivos = registros.filter(function(u) { return u.estado === 'INACTIVO'; }).length;
        var roles     = {};
        registros.forEach(function(u) { if (u.rol) roles[u.rol] = true; });

        var elTot = document.getElementById('usr-stat-total');
        var elAct = document.getElementById('usr-stat-activos');
        var elIna = document.getElementById('usr-stat-inactivos');
        var elRol = document.getElementById('usr-stat-roles');
        if (elTot) elTot.querySelector('.stat-num').textContent = registros.length;
        if (elAct) elAct.querySelector('.stat-num').textContent = activos;
        if (elIna) elIna.querySelector('.stat-num').textContent = inactivos;
        if (elRol) elRol.querySelector('.stat-num').textContent = Object.keys(roles).length;
    }

    function _renderTablaUsuarios(registros) {
        var tbody = document.getElementById('usr-tabla-body');
        if (!tbody) return;

        if (!registros || registros.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center py-10 text-slate-500 text-xs italic">' +
                '<div class="flex flex-col items-center gap-2">' +
                '<span class="material-symbols-outlined text-3xl">search_off</span>' +
                '<span>Sin usuarios para mostrar</span></div></td></tr>';
            return;
        }

        tbody.innerHTML = registros.map(function(u) {
            var esActivo = u.estado === 'ACTIVO';
            var estadoBadge = esActivo
                ? '<span class="inline-flex items-center gap-1 text-[9px] font-black bg-green-500/15 text-green-400 border border-green-500/30 px-2 py-0.5 rounded-lg">' +
                  '<span class="w-1.5 h-1.5 rounded-full bg-green-400"></span>ACTIVO</span>'
                : '<span class="inline-flex items-center gap-1 text-[9px] font-black bg-red-500/15 text-red-400 border border-red-500/30 px-2 py-0.5 rounded-lg">' +
                  '<span class="w-1.5 h-1.5 rounded-full bg-red-400"></span>INACTIVO</span>';

            var rolBadge = '<span class="text-[9px] font-black px-2 py-0.5 rounded-lg" style="background:rgba(197,160,72,0.12);color:var(--color-primario);border:1px solid rgba(197,160,72,0.3)">' +
                _esc(u.rol) + '</span>';

            return '<tr class="border-b border-white/5 hover:bg-white/5 transition-colors">' +
                '<td class="px-3 py-2.5 text-[10px] font-mono whitespace-nowrap" style="color:var(--color-primario)">' + _esc(u.id) + '</td>' +
                '<td class="px-3 py-2.5 text-xs font-bold text-white whitespace-nowrap">' + _esc(u.nombre) + '</td>' +
                '<td class="px-3 py-2.5 text-[11px] text-slate-400 whitespace-nowrap">' + _esc(u.email) + '</td>' +
                '<td class="px-3 py-2.5 whitespace-nowrap">' + rolBadge + '</td>' +
                '<td class="px-3 py-2.5 text-[11px] text-slate-400 whitespace-nowrap">' + _esc(u.cedula || '-') + '</td>' +
                '<td class="px-3 py-2.5 text-[11px] text-slate-400 whitespace-nowrap">' + _esc(u.celular || '-') + '</td>' +
                '<td class="px-3 py-2.5 whitespace-nowrap">' + estadoBadge + '</td>' +
                '<td class="px-3 py-2.5 whitespace-nowrap">' +
                    '<div class="flex items-center gap-1.5">' +
                    '<button onclick="abrirModalUsuario(\'' + _esc(u.id) + '\')" title="Editar" ' +
                        'class="w-7 h-7 rounded-lg bg-white/5 hover:bg-primary/20 border border-white/10 hover:border-primary/30 flex items-center justify-center transition-all">' +
                        '<span class="material-symbols-outlined text-sm text-slate-400 hover:text-primary">edit</span></button>' +
                    '<button onclick="abrirModalResetPassword(\'' + _esc(u.id) + '\',\'' + _esc(u.nombre) + '\')" title="Reset contrase√±a" ' +
                        'class="w-7 h-7 rounded-lg bg-white/5 hover:bg-amber-500/20 border border-white/10 hover:border-amber-500/30 flex items-center justify-center transition-all">' +
                        '<span class="material-symbols-outlined text-sm text-slate-400 hover:text-amber-400">key</span></button>' +
                    '<button onclick="toggleEstadoUsuario(\'' + _esc(u.id) + '\')" title="' + (esActivo ? 'Desactivar' : 'Activar') + '" ' +
                        'class="w-7 h-7 rounded-lg bg-white/5 hover:bg-' + (esActivo ? 'red' : 'green') + '-500/20 border border-white/10 flex items-center justify-center transition-all">' +
                        '<span class="material-symbols-outlined text-sm ' + (esActivo ? 'text-green-400 hover:text-red-400' : 'text-red-400 hover:text-green-400') + '">' + (esActivo ? 'toggle_on' : 'toggle_off') + '</span></button>' +
                    '</div>' +
                '</td>' +
                '</tr>';
        }).join('');
    }

    function _renderCardsUsuariosMobil(registros) {
        var lista = document.getElementById('usr-lista-mobile');
        if (!lista) return;

        if (!registros || registros.length === 0) {
            lista.innerHTML = '<div class="text-center py-8 text-slate-500 text-xs italic">Sin usuarios para mostrar</div>';
            return;
        }

        lista.innerHTML = registros.map(function(u) {
            var esActivo = u.estado === 'ACTIVO';
            var estadoBadge = esActivo
                ? '<span class="text-[9px] font-black text-green-400 bg-green-500/15 border border-green-500/30 px-2 py-0.5 rounded-lg">ACTIVO</span>'
                : '<span class="text-[9px] font-black text-red-400 bg-red-500/15 border border-red-500/30 px-2 py-0.5 rounded-lg">INACTIVO</span>';

            return '<div class="bg-white/5 border border-white/10 rounded-xl p-3 animate-fade-in">' +
                '<div class="flex items-start justify-between gap-2 mb-2">' +
                '<div><p class="text-[10px] font-black uppercase tracking-tight" style="color:var(--color-primario)">' + _esc(u.id) + '</p>' +
                '<p class="text-xs font-bold text-white">' + _esc(u.nombre) + '</p>' +
                '<p class="text-[10px] text-slate-500">' + _esc(u.email) + '</p></div>' +
                estadoBadge + '</div>' +
                '<div class="grid grid-cols-2 gap-x-3 gap-y-1 text-[10px] mb-2.5">' +
                '<span class="text-slate-500">Rol:</span><span class="text-primary font-bold">' + _esc(u.rol) + '</span>' +
                '<span class="text-slate-500">C√©dula:</span><span class="text-slate-300">' + _esc(u.cedula || '-') + '</span>' +
                '<span class="text-slate-500">Celular:</span><span class="text-slate-300">' + _esc(u.celular || '-') + '</span>' +
                '<span class="text-slate-500">Celular:</span><span class="text-slate-300">' + _esc(u.celular || '-') + '</span>' +
                '</div>' +
                '<div class="flex gap-2 border-t border-white/5 pt-2">' +
                '<button onclick="abrirModalUsuario(\'' + _esc(u.id) + '\')" ' +
                    'class="flex-1 py-1.5 text-[10px] font-black text-slate-300 bg-white/5 border border-white/10 rounded-lg flex items-center justify-center gap-1">' +
                    '<span class="material-symbols-outlined text-xs">edit</span>Editar</button>' +
                '<button onclick="abrirModalResetPassword(\'' + _esc(u.id) + '\',\'' + _esc(u.nombre) + '\')" ' +
                    'class="flex-1 py-1.5 text-[10px] font-black text-amber-400 bg-amber-500/10 border border-amber-500/20 rounded-lg flex items-center justify-center gap-1">' +
                    '<span class="material-symbols-outlined text-xs">key</span>Password</button>' +
                '<button onclick="toggleEstadoUsuario(\'' + _esc(u.id) + '\')" ' +
                    'class="flex-1 py-1.5 text-[10px] font-black ' + (esActivo ? 'text-red-400 bg-red-500/10 border-red-500/20' : 'text-green-400 bg-green-500/10 border-green-500/20') + ' border rounded-lg flex items-center justify-center gap-1">' +
                    '<span class="material-symbols-outlined text-xs">' + (esActivo ? 'toggle_off' : 'toggle_on') + '</span>' + (esActivo ? 'Desactivar' : 'Activar') + '</button>' +
                '</div></div>';
        }).join('');
    }

    // ‚îÄ‚îÄ Modal crear / editar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function abrirModalUsuario(id) {
        _usrEditandoId = id || null;
        var modal    = document.getElementById('usr-modal');
        var titulo   = document.getElementById('usr-modal-titulo');
        var subId    = document.getElementById('usr-modal-id');
        var fldPwd   = document.getElementById('usr-campo-password');
        var fldEst   = document.getElementById('usr-campo-estado');

        var fldEmpresa = document.getElementById('usr-campo-empresa');

        if (!id) {
            // NUEVO
            titulo.textContent = 'Nuevo Usuario';
            subId.textContent  = 'C√≥digo se asignar√° autom√°ticamente';
            document.getElementById('usr-inp-nombre').value    = '';
            document.getElementById('usr-inp-email').value     = '';
            document.getElementById('usr-inp-email').readOnly  = false;
            document.getElementById('usr-inp-email').style.opacity = '1';
            document.getElementById('usr-inp-rol').value       = '';
            document.getElementById('usr-inp-password').value  = '';
            document.getElementById('usr-inp-cedula').value    = '';
            document.getElementById('usr-inp-celular').value   = '';
            var selEmp = document.getElementById('usr-inp-empresa');
            if (selEmp) selEmp.value = '';
            fldPwd.classList.remove('hidden');
            fldEst.classList.add('hidden');
            if (fldEmpresa) fldEmpresa.classList.add('hidden'); // se mostrar√° al elegir CLI
        } else {
            // EDICI√ìN
            var u = _usuariosTotal.find(function(x) { return x.id === id; });
            if (!u) return;
            titulo.textContent = 'Editar Usuario';
            subId.textContent  = u.id;
            document.getElementById('usr-inp-nombre').value    = u.nombre;
            document.getElementById('usr-inp-email').value     = u.email;
            document.getElementById('usr-inp-email').readOnly  = true;
            document.getElementById('usr-inp-email').style.opacity = '0.5';
            document.getElementById('usr-inp-rol').value       = u.rol;
            document.getElementById('usr-inp-cedula').value    = u.cedula || '';
            document.getElementById('usr-inp-celular').value   = u.celular || '';
            document.getElementById('usr-inp-estado').value    = u.estado;
            fldPwd.classList.add('hidden');
            fldEst.classList.remove('hidden');
            // En edici√≥n nunca se muestra el selector de empresa (el c√≥digo ya est√° asignado)
            if (fldEmpresa) fldEmpresa.classList.add('hidden');
        }

        modal.classList.remove('hidden');
    }

    function cerrarModalUsuario() {
        var modal = document.getElementById('usr-modal');
        if (modal) modal.classList.add('hidden');
        _usrEditandoId = null;
    }

    // Muestra/oculta el selector de empresa seg√∫n el rol elegido
    function onCambioRolUsuario() {
        var rol          = ((document.getElementById('usr-inp-rol') || {}).value || '');
        var campoEmpresa = document.getElementById('usr-campo-empresa');
        if (!campoEmpresa) return;

        if (rol === 'CLI') {
            campoEmpresa.classList.remove('hidden');
            _cargarClientesParaModal(); // carga y puebla el select
        } else {
            campoEmpresa.classList.add('hidden');
            var sel = document.getElementById('usr-inp-empresa');
            if (sel) sel.value = '';
        }
    }

    // Carga DB_CLIENTES desde el backend (con cach√© en memoria)
    function _cargarClientesParaModal() {
        if (_clientesParaModal.length > 0) { _poblarSelectEmpresas(); return; }
        google.script.run
            .withSuccessHandler(function(res) {
                if (res && res.status === 'success') {
                    _clientesParaModal = res.data || [];
                    _poblarSelectEmpresas();
                } else {
                    mostrarNotificacion('‚ùå No se pudieron cargar las empresas.', 'error');
                }
            })
            .withFailureHandler(function(err) {
                mostrarNotificacion('‚ùå Error cargando empresas: ' + err.toString(), 'error');
            })
            .obtenerClientesParaUsuarios();
    }

    // Puebla el <select> de empresas con los datos de _clientesParaModal
    function _poblarSelectEmpresas() {
        var sel = document.getElementById('usr-inp-empresa');
        if (!sel) return;
        var valActual = sel.value;
        sel.innerHTML = '<option value="" style="background:#1a242f;">Seleccione una empresa...</option>';
        _clientesParaModal.forEach(function(c) {
            var opt             = document.createElement('option');
            opt.value           = c.id;
            opt.textContent     = c.id + ' ‚Äî ' + c.nombre;
            opt.style.background = '#1a242f';
            // Guardamos los datos del cliente como atributos para auto-completar
            opt.dataset.correo   = c.correo;
            opt.dataset.contacto = c.contacto;
            opt.dataset.celular  = c.celular;
            sel.appendChild(opt);
        });
        if (valActual) sel.value = valActual;
    }

    // Auto-completa email, nombre y celular al elegir un cliente en el selector
    function onSeleccionClienteUsuario() {
        var sel = document.getElementById('usr-inp-empresa');
        if (!sel || !sel.value) return;
        var opt     = sel.options[sel.selectedIndex];
        var correo  = opt.dataset.correo   || '';
        var contacto = opt.dataset.contacto || '';
        var celular = opt.dataset.celular  || '';

        var inpEmail   = document.getElementById('usr-inp-email');
        var inpNombre  = document.getElementById('usr-inp-nombre');
        var inpCelular = document.getElementById('usr-inp-celular');
        if (inpEmail  && !inpEmail.readOnly)  inpEmail.value   = correo;
        if (inpNombre && !inpNombre.readOnly) inpNombre.value  = contacto;
        if (inpCelular) inpCelular.value = celular;
    }

    function guardarUsuario() {
        var nombre   = (document.getElementById('usr-inp-nombre')   || {}).value || '';
        var email    = (document.getElementById('usr-inp-email')    || {}).value || '';
        var rol      = (document.getElementById('usr-inp-rol')      || {}).value || '';
        var password = (document.getElementById('usr-inp-password') || {}).value || '';
        var cedula   = (document.getElementById('usr-inp-cedula')   || {}).value || '';
        var celular  = (document.getElementById('usr-inp-celular')  || {}).value || '';
        var estado   = (document.getElementById('usr-inp-estado')   || {}).value || 'ACTIVO';

        if (!nombre.trim()) { mostrarNotificacion('‚ö†Ô∏è El nombre es obligatorio.', 'warning'); return; }
        if (!email.trim())  { mostrarNotificacion('‚ö†Ô∏è El email es obligatorio.', 'warning'); return; }
        if (!rol)           { mostrarNotificacion('‚ö†Ô∏è Seleccione un rol.', 'warning'); return; }
        if (!_usrEditandoId && !password.trim()) { mostrarNotificacion('‚ö†Ô∏è La contrase√±a es obligatoria.', 'warning'); return; }

        // Para CLI en creaci√≥n validar que se seleccion√≥ empresa
        var idClienteAsociado = '';
        if (!_usrEditandoId && rol === 'CLI') {
            var selEmpresa = document.getElementById('usr-inp-empresa');
            idClienteAsociado = selEmpresa ? selEmpresa.value : '';
            if (!idClienteAsociado) { mostrarNotificacion('‚ö†Ô∏è Seleccione la empresa para el usuario cliente.', 'warning'); return; }
        }

        var btn     = document.getElementById('usr-btn-guardar');
        var spinner = document.getElementById('usr-spinner-guardar');
        if (btn)     btn.disabled = true;
        if (spinner) spinner.classList.remove('hidden');

        var datos = { nombre: nombre.trim(), email: email.trim(), rol: rol.trim(),
                      cedula: cedula.trim(), celular: celular.trim(),
                      idClienteAsociado: idClienteAsociado };

        var fnExito = function(res) {
            if (btn)     btn.disabled = false;
            if (spinner) spinner.classList.add('hidden');
            if (res.status === 'success') {
                mostrarNotificacion('‚úÖ ' + res.message, 'success');
                cerrarModalUsuario();
                cargarUsuariosAdmin();
            } else {
                mostrarNotificacion('‚ùå ' + res.message, 'error');
            }
        };
        var fnError = function(err) {
            if (btn)     btn.disabled = false;
            if (spinner) spinner.classList.add('hidden');
            mostrarNotificacion('‚ùå Error: ' + err.toString(), 'error');
        };

        if (_usrEditandoId) {
            datos.id     = _usrEditandoId;
            datos.estado = estado;
            google.script.run.withSuccessHandler(fnExito).withFailureHandler(fnError).actualizarUsuario(datos);
        } else {
            datos.password = password.trim();
            google.script.run.withSuccessHandler(fnExito).withFailureHandler(fnError).crearUsuario(datos);
        }
    }

    // ‚îÄ‚îÄ Modal reset de contrase√±a ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function abrirModalResetPassword(id, nombre) {
        _usrResetId = id;
        var modal = document.getElementById('usr-reset-modal');
        var nomEl = document.getElementById('usr-reset-nombre');
        var inp   = document.getElementById('usr-reset-inp');
        if (nomEl) nomEl.textContent = nombre || id;
        if (inp)   inp.value = '';
        if (modal) modal.classList.remove('hidden');
    }

    function cerrarModalResetPassword() {
        var modal = document.getElementById('usr-reset-modal');
        if (modal) modal.classList.add('hidden');
        _usrResetId = null;
    }

    function confirmarResetPassword() {
        var newPass = ((document.getElementById('usr-reset-inp') || {}).value || '').trim();
        if (!newPass) { mostrarNotificacion('‚ö†Ô∏è Ingrese la nueva contrase√±a.', 'warning'); return; }
        if (newPass.length < 4) { mostrarNotificacion('‚ö†Ô∏è La contrase√±a debe tener al menos 4 caracteres.', 'warning'); return; }

        var btn     = document.getElementById('usr-btn-reset');
        var spinner = document.getElementById('usr-spinner-reset');
        if (btn)     btn.disabled = true;
        if (spinner) spinner.classList.remove('hidden');

        google.script.run
            .withSuccessHandler(function(res) {
                if (btn)     btn.disabled = false;
                if (spinner) spinner.classList.add('hidden');
                if (res.status === 'success') {
                    mostrarNotificacion('‚úÖ ' + res.message, 'success');
                    cerrarModalResetPassword();
                } else {
                    mostrarNotificacion('‚ùå ' + res.message, 'error');
                }
            })
            .withFailureHandler(function(err) {
                if (btn)     btn.disabled = false;
                if (spinner) spinner.classList.add('hidden');
                mostrarNotificacion('‚ùå Error: ' + err.toString(), 'error');
            })
            .resetPasswordUsuario(_usrResetId, newPass);
    }

    // ‚îÄ‚îÄ Toggle estado usuario ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function toggleEstadoUsuario(id) {
        var u = _usuariosTotal.find(function(x) { return x.id === id; });
        var accion = u && u.estado === 'ACTIVO' ? 'desactivar' : 'activar';
        if (!confirm('¬øDesea ' + accion + ' este usuario?')) return;

        google.script.run
            .withSuccessHandler(function(res) {
                if (res.status === 'success') {
                    mostrarNotificacion('‚úÖ ' + res.message, 'success');
                    cargarUsuariosAdmin();
                } else {
                    mostrarNotificacion('‚ùå ' + res.message, 'error');
                }
            })
            .withFailureHandler(function(err) {
                mostrarNotificacion('‚ùå Error: ' + err.toString(), 'error');
            })
            .toggleEstadoUsuario(id);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // M√ìDULO: GESTOR DE FORMATOS POR EMPRESA
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    let _formatosAdminTotal = []; // cache completo de LISTAS_FORMATOS
    let _fmtEditando        = null; // { id, empresa } del formato en edici√≥n, null = nuevo

    function cargarFormatosAdmin() {
        var loader = '<div class="flex flex-col items-center gap-2 py-8 text-slate-500 text-xs italic">' +
                     '<div class="animate-spin h-6 w-6 border-2 border-primary/30 border-t-primary rounded-full"></div>' +
                     '<span>Cargando formatos...</span></div>';
        var tbody = document.getElementById('fmt-tabla-body');
        var movil = document.getElementById('fmt-lista-mobile');
        if (tbody) tbody.innerHTML = '<tr><td colspan="5" class="py-10 text-center">' + loader + '</td></tr>';
        if (movil) movil.innerHTML = loader;

        google.script.run
            .withSuccessHandler(function(res) {
                if (res.status === 'success') {
                    _formatosAdminTotal = res.data || [];
                    _poblarFiltroEmpresasFormatos();
                    filtrarFormatos();
                } else {
                    mostrarNotificacion('‚ùå ' + res.message, 'error');
                }
            })
            .withFailureHandler(function(err) {
                mostrarNotificacion('‚ùå Error de conexi√≥n: ' + err.toString(), 'error');
            })
            .obtenerFormatosAdmin();
    }

    // Puebla el filtro de empresa din√°micamente desde los datos cargados
    function _poblarFiltroEmpresasFormatos() {
        var sel = document.getElementById('fmt-filtro-empresa');
        if (!sel) return;
        var valActual = sel.value;
        var empresas  = {};
        _formatosAdminTotal.forEach(function(f) { if (f.empresa) empresas[f.empresa] = true; });
        sel.innerHTML = '<option value="" style="background:#1a242f;">Todas las empresas</option>';
        Object.keys(empresas).sort().forEach(function(e) {
            var opt = document.createElement('option');
            opt.value = e; opt.textContent = e; opt.style.background = '#1a242f';
            sel.appendChild(opt);
        });
        if (valActual) sel.value = valActual;
    }

    function filtrarFormatos() {
        var q       = ((document.getElementById('fmt-filtro-texto')   || {}).value || '').trim().toLowerCase();
        var empresa = ((document.getElementById('fmt-filtro-empresa')  || {}).value || '').trim();
        var tipo    = ((document.getElementById('fmt-filtro-tipo')     || {}).value || '').trim();

        var filtrados = _formatosAdminTotal.filter(function(f) {
            var coincideTexto   = !q       || f.id.toLowerCase().includes(q) || f.descripcion.toLowerCase().includes(q);
            var coincideEmpresa = !empresa || f.empresa === empresa;
            var coincideTipo    = !tipo    || f.tipo === tipo;
            return coincideTexto && coincideEmpresa && coincideTipo;
        });

        _actualizarStatsFormatos(filtrados);
        _renderTablaFormatos(filtrados);
        _renderCardsFormatosMobil(filtrados);
    }

    function _actualizarStatsFormatos(registros) {
        var empresas     = {};
        var permisos     = 0;
        var inspecciones = 0;
        registros.forEach(function(f) {
            if (f.empresa) empresas[f.empresa] = true;
            if (f.tipo === 'Permiso')     permisos++;
            if (f.tipo === 'Inspeccion')  inspecciones++;
        });
        var elTot = document.getElementById('fmt-stat-total');
        var elEmp = document.getElementById('fmt-stat-empresas');
        var elPer = document.getElementById('fmt-stat-permisos');
        var elIns = document.getElementById('fmt-stat-inspecciones');
        if (elTot) elTot.querySelector('.stat-num').textContent = registros.length;
        if (elEmp) elEmp.querySelector('.stat-num').textContent = Object.keys(empresas).length;
        if (elPer) elPer.querySelector('.stat-num').textContent = permisos;
        if (elIns) elIns.querySelector('.stat-num').textContent = inspecciones;
    }

    // Colores por tipo de documento
    var _TIPO_BADGE = {
        'Registro':   { bg: 'bg-green-500/15',  text: 'text-green-400',  border: 'border-green-500/30'  },
        'Permiso':    { bg: 'bg-amber-500/15',   text: 'text-amber-400',  border: 'border-amber-500/30'  },
        'Inspeccion': { bg: 'bg-blue-500/15',    text: 'text-blue-400',   border: 'border-blue-500/30'   },
        'Ejecucion':  { bg: 'bg-purple-500/15',  text: 'text-purple-400', border: 'border-purple-500/30' }
    };

    function _tipoBadge(tipo) {
        var c = _TIPO_BADGE[tipo] || { bg: 'bg-white/10', text: 'text-slate-400', border: 'border-white/20' };
        return '<span class="inline-flex text-[9px] font-black px-2 py-0.5 rounded-lg border ' +
               c.bg + ' ' + c.text + ' ' + c.border + '">' + _esc(tipo || '-') + '</span>';
    }

    function _renderTablaFormatos(registros) {
        var tbody = document.getElementById('fmt-tabla-body');
        if (!tbody) return;
        if (!registros || registros.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-10 text-slate-500 text-xs italic">' +
                '<div class="flex flex-col items-center gap-2">' +
                '<span class="material-symbols-outlined text-3xl">search_off</span>' +
                '<span>Sin formatos para mostrar</span></div></td></tr>';
            return;
        }
        tbody.innerHTML = registros.map(function(f) {
            var idEscaped = encodeURIComponent(f.id);
            var empEscaped = encodeURIComponent(f.empresa);
            return '<tr class="border-b border-white/5 hover:bg-white/5 transition-colors">' +
                '<td class="px-3 py-3"><span class="text-xs font-black text-primary tracking-widest">' + _esc(f.id) + '</span></td>' +
                '<td class="px-3 py-3 text-xs text-slate-200 max-w-[280px]">' + _esc(f.descripcion) + '</td>' +
                '<td class="px-3 py-3">' + _tipoBadge(f.tipo) + '</td>' +
                '<td class="px-3 py-3 text-xs text-slate-300">' + _esc(f.empresa) + '</td>' +
                '<td class="px-3 py-3 text-right">' +
                '<div class="flex items-center justify-end gap-1">' +
                '<button onclick="abrirModalFormato(\'' + idEscaped + '\',\'' + empEscaped + '\')" ' +
                'class="w-7 h-7 flex items-center justify-center rounded-lg bg-white/5 hover:bg-primary/20 text-slate-400 hover:text-primary transition border border-white/10" title="Editar">' +
                '<span class="material-symbols-outlined text-sm">edit</span></button>' +
                '<button onclick="eliminarFormato(\'' + idEscaped + '\',\'' + empEscaped + '\')" ' +
                'class="w-7 h-7 flex items-center justify-center rounded-lg bg-white/5 hover:bg-red-500/20 text-slate-400 hover:text-red-400 transition border border-white/10" title="Eliminar">' +
                '<span class="material-symbols-outlined text-sm">delete</span></button>' +
                '</div></td></tr>';
        }).join('');
    }

    function _renderCardsFormatosMobil(registros) {
        var cont = document.getElementById('fmt-lista-mobile');
        if (!cont) return;
        if (!registros || registros.length === 0) {
            cont.innerHTML = '<div class="flex flex-col items-center gap-2 py-8 text-slate-500 text-xs italic">' +
                '<span class="material-symbols-outlined text-3xl">search_off</span><span>Sin formatos para mostrar</span></div>';
            return;
        }
        cont.innerHTML = registros.map(function(f) {
            var idEscaped  = encodeURIComponent(f.id);
            var empEscaped = encodeURIComponent(f.empresa);
            return '<div class="bg-white/5 rounded-xl border border-white/10 p-3 space-y-2">' +
                '<div class="flex items-start justify-between">' +
                '<div><p class="text-xs font-black text-primary tracking-widest">' + _esc(f.id) + '</p>' +
                '<p class="text-[10px] text-slate-300 mt-0.5">' + _esc(f.descripcion) + '</p></div>' +
                _tipoBadge(f.tipo) + '</div>' +
                '<div class="flex items-center justify-between">' +
                '<span class="text-[9px] text-slate-500">' + _esc(f.empresa) + '</span>' +
                '<div class="flex gap-1">' +
                '<button onclick="abrirModalFormato(\'' + idEscaped + '\',\'' + empEscaped + '\')" ' +
                'class="text-[9px] font-black px-2 py-1 rounded-lg bg-primary/10 text-primary border border-primary/20 hover:opacity-80 transition">Editar</button>' +
                '<button onclick="eliminarFormato(\'' + idEscaped + '\',\'' + empEscaped + '\')" ' +
                'class="text-[9px] font-black px-2 py-1 rounded-lg bg-red-500/10 text-red-400 border border-red-500/20 hover:opacity-80 transition">Eliminar</button>' +
                '</div></div></div>';
        }).join('');
    }

    // ‚îÄ‚îÄ Modal crear / editar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function abrirModalFormato(idEnc, empresaEnc) {
        var modal  = document.getElementById('fmt-modal');
        var titulo = document.getElementById('fmt-modal-titulo');
        var sub    = document.getElementById('fmt-modal-sub');
        var inpId  = document.getElementById('fmt-inp-id');
        var nota   = document.getElementById('fmt-nota-id');

        // Poblar el select de empresas desde _clientesParaModal (cache compartido con usuarios)
        _poblarSelectEmpresasFormatos();

        if (!idEnc) {
            // CREAR
            _fmtEditando = null;
            titulo.textContent = 'Nuevo Formato';
            sub.textContent    = 'Se vincular√° a la empresa seleccionada';
            inpId.value        = '';
            inpId.readOnly     = false;
            inpId.style.opacity = '1';
            if (nota) nota.classList.remove('hidden');
            document.getElementById('fmt-inp-descripcion').value = '';
            document.getElementById('fmt-inp-tipo').value        = '';
            document.getElementById('fmt-inp-empresa').value     = '';
        } else {
            // EDITAR
            var id      = decodeURIComponent(idEnc);
            var empresa = decodeURIComponent(empresaEnc);
            var f = _formatosAdminTotal.find(function(x) { return x.id === id && x.empresa === empresa; });
            if (!f) return;
            _fmtEditando = { id: f.id, empresa: f.empresa };
            titulo.textContent = 'Editar Formato';
            sub.textContent    = f.id + ' ¬∑ ' + f.empresa;
            inpId.value        = f.id;
            inpId.readOnly     = true;
            inpId.style.opacity = '0.5';
            if (nota) nota.classList.add('hidden');
            document.getElementById('fmt-inp-descripcion').value = f.descripcion;
            document.getElementById('fmt-inp-tipo').value        = f.tipo;
            document.getElementById('fmt-inp-empresa').value     = f.empresa;
            document.getElementById('fmt-inp-empresa').disabled  = true;
        }
        modal.classList.remove('hidden');
    }

    function cerrarModalFormato() {
        var modal = document.getElementById('fmt-modal');
        if (modal) modal.classList.add('hidden');
        var selEmp = document.getElementById('fmt-inp-empresa');
        if (selEmp) selEmp.disabled = false;
        _fmtEditando = null;
    }

    // Puebla el select de empresa del modal con los clientes de DB_CLIENTES
    function _poblarSelectEmpresasFormatos() {
        var sel = document.getElementById('fmt-inp-empresa');
        if (!sel) return;
        // Si ya tiene opciones cargadas (m√°s de 1), no repoblar
        if (sel.options.length > 1) return;

        if (_clientesParaModal.length > 0) {
            _llenarSelectEmpresasFormatos(sel);
        } else {
            // Cargar clientes y luego poblar
            google.script.run
                .withSuccessHandler(function(res) {
                    if (res && res.status === 'success') {
                        _clientesParaModal = res.data || [];
                        _llenarSelectEmpresasFormatos(sel);
                    }
                })
                .obtenerClientesParaUsuarios();
        }
    }

    function _llenarSelectEmpresasFormatos(sel) {
        sel.innerHTML = '<option value="" style="background:#1a242f;">Seleccione la empresa...</option>';
        _clientesParaModal.forEach(function(c) {
            var opt = document.createElement('option');
            opt.value = c.nombre; opt.textContent = c.nombre; opt.style.background = '#1a242f';
            sel.appendChild(opt);
        });
    }

    function guardarFormato() {
        var id          = ((document.getElementById('fmt-inp-id')          || {}).value || '').trim().toUpperCase();
        var descripcion = ((document.getElementById('fmt-inp-descripcion') || {}).value || '').trim();
        var tipo        = ((document.getElementById('fmt-inp-tipo')        || {}).value || '').trim();
        var empresa     = ((document.getElementById('fmt-inp-empresa')     || {}).value || '').trim();

        if (!id)          { mostrarNotificacion('‚ö†Ô∏è El c√≥digo del formato es obligatorio.', 'warning'); return; }
        if (!descripcion) { mostrarNotificacion('‚ö†Ô∏è La descripci√≥n es obligatoria.',        'warning'); return; }
        if (!tipo)        { mostrarNotificacion('‚ö†Ô∏è Seleccione el tipo de documento.',      'warning'); return; }
        if (!empresa)     { mostrarNotificacion('‚ö†Ô∏è Seleccione la empresa contratista.',    'warning'); return; }

        var btn     = document.getElementById('fmt-btn-guardar');
        var spinner = document.getElementById('fmt-spinner-guardar');
        if (btn)     btn.disabled = true;
        if (spinner) spinner.classList.remove('hidden');

        var fnExito = function(res) {
            if (btn)     btn.disabled = false;
            if (spinner) spinner.classList.add('hidden');
            if (res.status === 'success') {
                mostrarNotificacion('‚úÖ ' + res.message, 'success');
                cerrarModalFormato();
                cargarFormatosAdmin();
            } else {
                mostrarNotificacion('‚ùå ' + res.message, 'error');
            }
        };
        var fnError = function(err) {
            if (btn)     btn.disabled = false;
            if (spinner) spinner.classList.add('hidden');
            mostrarNotificacion('‚ùå Error: ' + err.toString(), 'error');
        };

        var datos = { id: id, descripcion: descripcion, tipo: tipo, empresa: empresa };
        if (_fmtEditando) {
            datos.empresa = _fmtEditando.empresa; // usar la empresa original como clave
            google.script.run.withSuccessHandler(fnExito).withFailureHandler(fnError).actualizarFormato(datos);
        } else {
            google.script.run.withSuccessHandler(fnExito).withFailureHandler(fnError).crearFormato(datos);
        }
    }

    function eliminarFormato(idEnc, empresaEnc) {
        var id      = decodeURIComponent(idEnc);
        var empresa = decodeURIComponent(empresaEnc);
        if (!confirm('¬øEliminar el formato ' + id + ' de ' + empresa + '?\nEsta acci√≥n no se puede deshacer.')) return;

        google.script.run
            .withSuccessHandler(function(res) {
                if (res.status === 'success') {
                    mostrarNotificacion('‚úÖ ' + res.message, 'success');
                    cargarFormatosAdmin();
                } else {
                    mostrarNotificacion('‚ùå ' + res.message, 'error');
                }
            })
            .withFailureHandler(function(err) {
                mostrarNotificacion('‚ùå Error: ' + err.toString(), 'error');
            })
            .eliminarFormato(id, empresa);
    }

    function onExito(response) {
        mostrarNotificacion('‚úÖ ' + response.message, 'success');
        archivoBase64 = null;
        const form = document.getElementById('sst-form');
        if (form) form.reset();
        const prev = document.getElementById('preview-container');
        if (prev) prev.classList.add('hidden');
        _intentarBloqueoEmpresa();
        const descCont = document.getElementById('formato-descripcion-container');
        if (descCont) descCont.classList.add('hidden');
    }

    function onError(message) {
        mostrarNotificacion('‚ùå Error: ' + message, 'error');
    }
</script>