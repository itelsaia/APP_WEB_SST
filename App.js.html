<script>
    /**
     * APP.JS.HTML ‚Äî v3.0
     * Manejador central de sesi√≥n y l√≥gica UI.
     * Session h√≠brida: URL params + localStorage para evadir
     * limitaciones del sandbox de Google Apps Script.
     */

    let currentUser = null;
    let archivoBase64 = null;
    let nombreArchivo = '';
    let _obraSeleccionada = ''; // Obra elegida en el formulario de jornada
    let _clientesCargados = false; // Flag: ¬øya se carg√≥ el select de clientes?
    let _formatosDisponibles = []; // Cache de formatos del cliente seleccionado

    window.addEventListener('load', function () {
        verificarSesion();
    });

    // ================================================================
    // GESTI√ìN DE SESI√ìN ‚Äî L√ìGICA ROBUSTA
    // ================================================================

    function verificarSesion() {
        console.log("[SST] Iniciando verificaci√≥n de sesi√≥n...");

        // 1. Prioridad absoluta: Si hay 'logout=true' en la URL o flag de salida reciente
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('logout') === 'true' || sessionStorage.getItem('justLoggedOut')) {
            console.log("[SST] Logout detectado. Bloqueando acceso autom√°tico.");
            sessionStorage.removeItem('justLoggedOut');
            localStorage.clear();
            mostrarErrorAcceso("Sesi√≥n cerrada correctamente.");
            return;
        }


        if (typeof SERVER_EMAIL !== 'undefined' && SERVER_EMAIL &&
            typeof SERVER_ROLE !== 'undefined' && SERVER_ROLE) {
            console.log("[SST] Datos del servidor detectados ‚Äî Email:", SERVER_EMAIL, "Rol:", SERVER_ROLE);
            recuperarSesionConEmail(decodeURIComponent(SERVER_EMAIL));
            return;
        }

        const storedUser = localStorage.getItem('userSST');
        if (storedUser) {
            try {
                currentUser = JSON.parse(storedUser);
                console.log("[SST] Sesi√≥n recuperada de localStorage:", currentUser.email);
            } catch (e) {
                localStorage.removeItem('userSST');
                currentUser = null;
            }
        }

        if (currentUser && currentUser.email && currentUser.rol) {
            inicializarAppConSesion();
            return;
        }

        console.log("[SST] Sin sesi√≥n en servidor ni localStorage, intentando URL...");

        try {
            if (typeof google !== 'undefined' && google.script && google.script.url) {
                google.script.url.getLocation(function (location) {
                    console.log("[SST] getLocation response:", JSON.stringify(location));
                    var emailParam = location.parameter ? location.parameter.email : null;
                    var roleParam = location.parameter ? location.parameter.role : null;

                    if (emailParam) {
                        recuperarSesionConEmail(decodeURIComponent(emailParam));
                    } else if (roleParam) {
                        recuperarSesionConServidor();
                    } else {
                        recuperarSesionConServidor();
                    }
                });
            } else {
                recuperarSesionConServidor();
            }
        } catch (e) {
            console.error("[SST] Error en getLocation:", e);
            recuperarSesionConServidor();
        }
    }

    function recuperarSesionConEmail(email) {
        google.script.run
            .withSuccessHandler(function (response) {
                if (response.status === 'success') {
                    currentUser = response.data;
                    localStorage.setItem('userSST', JSON.stringify(currentUser));
                    console.log("[SST] Sesi√≥n OK v√≠a email:", currentUser.email);
                    inicializarAppConSesion();
                } else {
                    mostrarErrorAcceso("No se pudo verificar la sesi√≥n. Por favor inicie sesi√≥n nuevamente.");
                }
            })
            .withFailureHandler(function (err) {
                mostrarErrorAcceso("Error de conexi√≥n. Por favor inicie sesi√≥n nuevamente.");
            })
            .obtenerDatosUsuario(email);
    }

    function recuperarSesionConServidor() {
        google.script.run
            .withSuccessHandler(function (response) {
                if (response.status === 'success') {
                    currentUser = response.data;
                    localStorage.setItem('userSST', JSON.stringify(currentUser));
                    inicializarAppConSesion();
                } else {
                    mostrarErrorAcceso("No se detect√≥ una sesi√≥n activa. Por favor inicie sesi√≥n.");
                }
            })
            .withFailureHandler(function (err) {
                mostrarErrorAcceso("Error de conexi√≥n. Por favor inicie sesi√≥n nuevamente.");
            })
            .obtenerUsuarioActivo();
    }

    /**
     * Orquesta la UI una vez que currentUser est√° disponible.
     */
    function inicializarAppConSesion() {
        inyectarDatosIdentidad();
        mostrarBienvenidaPersonalizada();

        if (currentUser && currentUser.rol === 'SUP-SST') {
            try {
                cargarObrasAsistencia();
                configurarAsistencia();
                cargarOtrasOpciones();
                verificarEstadoAsistencia();
            } catch (e) {
                console.error('[SST] Error en inicializaci√≥n SUP-SST:', e);
                switchModule('asistencia');
            }
        }

        ocultarLoader();
    }

    // ================================================================
    // IDENTIDAD Y BIENVENIDA
    // ================================================================

    function inyectarDatosIdentidad() {
        if (!currentUser) return;
        const elName = document.getElementById('user-name');
        const elEmail = document.getElementById('user-email');
        const elRole = document.getElementById('user-role-label');
        const elInfo = document.getElementById('user-info');
        if (elName) elName.textContent = currentUser.nombre || "Usuario";
        if (elEmail) elEmail.textContent = currentUser.email || "";
        if (elRole) elRole.textContent = currentUser.rol || "COLABORADOR";
        if (elInfo) elInfo.classList.remove('hidden');
    }

    function mostrarBienvenidaPersonalizada() {
        if (!currentUser) return;

        const welcomeSection = document.getElementById('welcome-section');
        const welcomeMsg = document.getElementById('welcome-message');
        const welcomeSub = document.getElementById('welcome-subtext');
        const welcomeIcon = document.getElementById('welcome-icon');

        if (!welcomeSection) return;

        const rol = currentUser.rol;
        const nombre = (currentUser.nombre || "Usuario").split(' ')[0];

        // Frases motivacionales para SST
        const quotes = [
            "La seguridad no es un eslogan, es un estilo de vida. üë∑",
            "Tu familia te espera, trabaja con seguridad. üë®‚Äçüë© family",
            "La mejor herramienta eres t√∫. ¬°Cu√≠date! üõ°Ô∏è",
            "Nada es tan importante que no pueda hacerse de forma segura. ‚úÖ",
            "Hoy es un gran d√≠a para prevenir accidentes. üöÄ",
            "Tu compromiso con la seguridad salva vidas. ü§ù",
            "Trabaja con pasi√≥n, pero siempre con precauci√≥n. ‚ú®",
            "La prevenci√≥n es la clave del √©xito. üîë"
        ];
        const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];

        let config = {
            msg: `¬°Hola, ${nombre}! üëã`,
            sub: randomQuote,
            icon: "sentiment_satisfied"
        };

        if (rol === 'SUP-SST') {
            config.msg = `¬°Bienvenido/a, ${nombre}! üë∑`;
            config.icon = "engineering";
        } else if (rol === 'ADMIN') {
            config.msg = `Bienvenido/a: ${nombre} üëî`;
            config.icon = "query_stats";
        }

        if (welcomeMsg) welcomeMsg.textContent = config.msg;
        if (welcomeSub) welcomeSub.textContent = config.sub;
        if (welcomeIcon) welcomeIcon.textContent = config.icon;
        const mobileGreet = document.getElementById('welcome-message-mobile');
        if (mobileGreet) mobileGreet.textContent = '¬°Hola, ' + nombre + '!';

        welcomeSection.classList.remove('hidden');
    }

    function mostrarErrorAcceso(msj) {
        const content = document.getElementById('main-content');
        if (!content) return;
        const scriptUrl = window.location.href.split('?')[0];
        content.innerHTML = `
            <div class="flex flex-col items-center justify-center py-12 px-4 animate-fade-in">
                <div class="bg-white/5 backdrop-blur-xl rounded-3xl p-10 border border-white/10 shadow-2xl max-w-sm w-full text-center">
                    <div class="w-20 h-20 bg-red-500/10 rounded-2xl flex items-center justify-center mx-auto mb-6 border border-red-500/20">
                        <span class="material-symbols-outlined text-5xl text-red-500">lock</span>
                    </div>
                    <h3 class="text-2xl font-black text-white tracking-tight mb-2 uppercase">Acceso Restringido</h3>
                    <p class="text-slate-400 font-medium mb-8 leading-relaxed">${msj}</p>
                    <a href="${scriptUrl}" 
                       class="block w-full bg-primary text-black py-4 rounded-xl font-black uppercase tracking-widest shadow-lg shadow-primary/20 hover:opacity-90 transition-all active:scale-95">
                        Ir al Login
                    </a>
                </div>
            </div>
        `;
        content.classList.remove('hidden');
        ocultarLoader();
    }

    function ocultarLoader() {
        const loader = document.getElementById('initial-loader');
        if (loader) {
            loader.classList.add('opacity-0');
            setTimeout(() => loader.remove(), 500);
        }
    }

    // Helper: navega al Login usando anchor target="_top" (m√©todo oficial en GAS iframes)
    function _irAlLogin(urlBase) {
        var url = urlBase.split('?')[0] + '?page=login';
        console.log("[SST] Navegando al Login:", url);
        var a = document.createElement('a');
        a.href = url;
        a.target = '_top';
        document.body.appendChild(a);
        a.click();
    }

    // Bot√≥n "Cerrar Sesi√≥n" del header
    function cerrarSesion() {
        console.log("[SST] Cerrando sesi√≥n (header)...");
        localStorage.clear();
        sessionStorage.clear();

        // SERVER_URL est√° inyectado por el servidor ‚Äî es la fuente m√°s confiable.
        // Si por alguna raz√≥n est√° vac√≠o, caemos al API de GAS como respaldo.
        if (typeof SERVER_URL !== 'undefined' && SERVER_URL) {
            _irAlLogin(SERVER_URL);
        } else {
            google.script.run
                .withSuccessHandler(_irAlLogin)
                .withFailureHandler(function () {
                    alert("No se pudo obtener la URL de sesi√≥n. Recargue la p√°gina.");
                })
                .getScriptUrl();
        }
    }

    // ================================================================
    // M√ìDULO: ASISTENCIA
    // ================================================================

    /**
     * Cambia entre la vista de asistencia y el panel de trabajo.
     */
    function switchModule(target) {
        const asisCont = document.getElementById('asistencia-content');
        const mainCont = document.getElementById('main-content');

        console.log("[SST] switchModule llamado con:", target);

        if (target === 'asistencia') {
            if (asisCont) asisCont.classList.remove('hidden');
            if (mainCont) mainCont.classList.add('hidden');
        } else {
            // 'inspeccion' o cualquier otro -> mostrar panel principal
            if (asisCont) asisCont.classList.add('hidden');
            if (mainCont) mainCont.classList.remove('hidden');
        }
    }

    /**
     * Verifica el estado de asistencia en el servidor.
     * Si tiene jornada activa -> panel de trabajo + bot√≥n salida.
     * Si no -> pantalla de registro de entrada.
     */
    function verificarEstadoAsistencia() {
        if (!currentUser || !currentUser.email) return;
        console.log('[SST] Verificando estado de asistencia para:', currentUser.email);

        google.script.run
            .withSuccessHandler(function (response) {
                console.log('[SST] Respuesta de obtenerEstadoAsistencia:', JSON.stringify(response));
                const exitSection = document.getElementById('exit-section');

                if (response.status === 'success' && response.data && response.data.activo) {
                    console.log('[SST] ‚úÖ Jornada ACTIVA detectada ‚Äî mostrando panel de trabajo');
                    // Recuperar la obra activa para bloquear el formulario de inspecci√≥n
                    if (response.data.obra) {
                        _obraSeleccionada = response.data.obra;
                        console.log('[SST] Obra activa recuperada del servidor:', _obraSeleccionada);
                    }
                    switchModule('inspeccion');
                    if (exitSection) exitSection.classList.remove('hidden');
                    // Intentar bloquear (puede que los clientes ya hayan cargado)
                    _intentarBloqueoEmpresa();
                } else {
                    console.log('[SST] ‚è≥ Sin jornada activa ‚Äî mostrando registro de entrada');
                    switchModule('asistencia');
                    if (exitSection) exitSection.classList.add('hidden');
                }
            })
            .withFailureHandler(function (err) {
                console.error('[SST] Error verificando asistencia:', err);
                switchModule('asistencia');
            })
            .obtenerEstadoAsistencia(currentUser.email);
    }

    function previewAsistencia(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                archivoBase64 = e.target.result;
                const prev = document.getElementById('asis-img-preview');
                const cont = document.getElementById('asis-preview-container');
                const label = document.getElementById('asis-foto-label');
                if (prev) prev.src = e.target.result;
                if (cont) cont.classList.remove('hidden');
                // Ocultar bot√≥n de captura para evitar duplicados
                if (label) label.classList.add('hidden');
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    /**
     * Configura el formulario de asistencia (solo ENTRADA).
     * FIX PRINCIPAL: Despu√©s de registrar exitosamente, se redirige
     * DIRECTAMENTE al panel de trabajo sin esperar otra llamada al servidor.
     */
    function configurarAsistencia() {
        const form = document.getElementById('attendance-form');
        if (!form) return;

        form.addEventListener('submit', function (e) {
            e.preventDefault();

            const obraSelect = document.getElementById('idObraAsistencia');

            if (obraSelect && (obraSelect.value === '' || obraSelect.selectedIndex === 0)) {
                alert("‚ö†Ô∏è Por favor seleccione la Obra / Proyecto.");
                return;
            }

            if (!archivoBase64) {
                alert("‚ö†Ô∏è Debe capturar la foto de ingreso.");
                return;
            }

            const btn = document.getElementById('btn-asistencia');
            const spinner = document.getElementById('asis-spinner');
            const btnText = document.getElementById('asis-btn-text');
            const btnIcon = document.getElementById('asis-btn-icon');

            if (btn) btn.disabled = true;
            if (spinner) spinner.classList.remove('hidden');
            if (btnText) btnText.textContent = "REGISTRANDO...";
            if (btnIcon) btnIcon.classList.add('hidden');

            const payload = {
                userEmail: currentUser.email,
                obra: obraSelect ? obraSelect.options[obraSelect.selectedIndex].text : "Gen√©rica",
                archivoBase64: archivoBase64
            };

            google.script.run
                .withSuccessHandler(function (res) {
                    console.log('[SST] Respuesta registrarIngreso:', JSON.stringify(res));

                    if (res.status === 'success') {
                        // Guardar la obra seleccionada para pre-rellenar el formulario de inspecci√≥n
                        _obraSeleccionada = obraSelect
                            ? obraSelect.options[obraSelect.selectedIndex].text
                            : '';
                        console.log('[SST] Obra guardada:', _obraSeleccionada);

                        // Limpiar formulario
                        archivoBase64 = null;
                        const cont = document.getElementById('asis-preview-container');
                        if (cont) cont.classList.add('hidden');

                        // Mostrar el panel de trabajo DIRECTAMENTE
                        switchModule('inspeccion');

                        // Mostrar el bot√≥n de salida
                        const exitSection = document.getElementById('exit-section');
                        if (exitSection) exitSection.classList.remove('hidden');

                        // Bloquear el campo empresa con la obra seleccionada
                        _intentarBloqueoEmpresa();

                        // Notificaci√≥n amigable (no bloqueante)
                        mostrarNotificacion('‚úÖ ' + res.message, 'success');
                    } else {
                        alert("‚ö†Ô∏è " + res.message);
                    }

                    // Restaurar bot√≥n
                    if (btn) btn.disabled = false;
                    if (spinner) spinner.classList.add('hidden');
                    if (btnText) btnText.textContent = "INICIAR JORNADA";
                    if (btnIcon) btnIcon.classList.remove('hidden');
                })
                .withFailureHandler(function (err) {
                    console.error("[SST] Error en registrarIngreso:", err);
                    alert("‚ùå Error: " + err.toString());
                    if (btn) btn.disabled = false;
                    if (spinner) spinner.classList.add('hidden');
                    if (btnText) btnText.textContent = "INICIAR JORNADA";
                    if (btnIcon) btnIcon.classList.remove('hidden');
                }).registrarIngreso(payload);
        });
    }

    /**
     * Muestra una notificaci√≥n tipo toast no-bloqueante
     */
    function mostrarNotificacion(mensaje, tipo) {
        const toast = document.createElement('div');
        toast.className = `fixed bottom-8 left-1/2 -translate-x-1/2 z-[100] px-6 py-4 rounded-2xl shadow-2xl backdrop-blur-xl border font-bold text-xs uppercase tracking-widest animate-slide-up flex items-center space-x-3 min-w-[300px] justify-center ${tipo === 'success'
            ? 'bg-green-500/10 border-green-500/20 text-green-400'
            : 'bg-red-500/10 border-red-500/20 text-red-400'
            }`;

        const icon = tipo === 'success' ? 'check_circle' : 'error';
        toast.innerHTML = `<span class="material-symbols-outlined text-lg">${icon}</span><span>${mensaje}</span>`;

        document.body.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translate(-50%, 20px)';
            toast.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
            setTimeout(() => toast.remove(), 500);
        }, 3500);
    }

    // ================================================================
    // GESTI√ìN DE SALIDA (MODAL)
    // ================================================================

    function openExitModal() {
        document.getElementById('exit-modal').classList.remove('hidden');
    }

    function closeExitModal() {
        document.getElementById('exit-modal').classList.add('hidden');
        const prev = document.getElementById('exit-preview-container');
        const label = document.getElementById('exit-foto-label');
        if (prev) prev.classList.add('hidden');
        // Mostrar el label de nuevo por si cancel√≥ para volver a intentar
        if (label) label.classList.remove('hidden');
        archivoBase64 = null;
    }

    function previewSalida(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                archivoBase64 = e.target.result;
                const prev = document.getElementById('exit-img-preview');
                const cont = document.getElementById('exit-preview-container');
                const label = document.getElementById('exit-foto-label');
                if (prev) prev.src = e.target.result;
                if (cont) cont.classList.remove('hidden');
                // Ocultar bot√≥n de captura
                if (label) label.classList.add('hidden');
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function submitSalida() {
        if (!archivoBase64) {
            alert("‚ö†Ô∏è Debe capturar la foto de salida.");
            return;
        }

        const btn = document.getElementById('btn-submit-salida');
        const spinner = document.getElementById('exit-spinner');
        if (btn) btn.disabled = true;
        if (spinner) spinner.classList.remove('hidden');

        // ‚îÄ‚îÄ PASO 1: Registrar salida en el backend (fire-and-forget) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // No esperamos la respuesta del servidor para cerrar sesi√≥n.
        // La sesi√≥n se cierra SIEMPRE, independientemente del resultado del backend.
        google.script.run
            .withSuccessHandler(function (r) { console.log("[SST] registrarSalida:", r.status); })
            .withFailureHandler(function (e) { console.warn("[SST] registrarSalida error:", e); })
            .registrarSalida({
                userEmail: currentUser ? currentUser.email : '',
                archivoBase64: archivoBase64
            });

        // ‚îÄ‚îÄ PASO 2: Cerrar modal, notificar y limpiar almacenamiento ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        closeExitModal();
        if (btn) btn.disabled = false;
        if (spinner) spinner.classList.add('hidden');
        mostrarNotificacion("üëã Jornada finalizada. Cerrando sesi√≥n...", "success");
        localStorage.clear();
        sessionStorage.clear();

        // ‚îÄ‚îÄ PASO 3: Obtener URL real del script y navegar al Login ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Usamos getScriptUrl() porque es la fuente m√°s confiable en GAS.
        // SERVER_URL puede quedar vac√≠o si el bloque try{} de Index.html falla.
        google.script.run
            .withSuccessHandler(_irAlLogin)
            .withFailureHandler(function () {
                // Fallback: SERVER_URL si el API falla
                if (typeof SERVER_URL !== 'undefined' && SERVER_URL) {
                    _irAlLogin(SERVER_URL);
                } else {
                    alert("Error al cerrar sesi√≥n. Cierre la pesta√±a manualmente.");
                }
            })
            .getScriptUrl();
    }

    // ================================================================
    // CARGA DE DATOS
    // ================================================================

    function cargarObrasAsistencia() {
        google.script.run
            .withSuccessHandler(function (response) {
                const select = document.getElementById('idObraAsistencia');
                if (!select) return;
                if (response.status === "success" && response.data && response.data.length > 0) {
                    select.innerHTML = '<option value="">Seleccione la obra...</option>';
                    response.data.forEach(clie => {
                        const opt = document.createElement('option');
                        opt.value = clie.id;
                        opt.textContent = clie.nombre;
                        select.appendChild(opt);
                    });
                } else {
                    select.innerHTML = '<option value="">No hay obras registradas</option>';
                }
            })
            .withFailureHandler(function () {
                const select = document.getElementById('idObraAsistencia');
                if (select) select.innerHTML = '<option value="">Error al cargar obras</option>';
            })
            .obtenerClientesRegistrados();
    }

    function cargarOtrasOpciones() {
        google.script.run.withSuccessHandler(llenarClientes).obtenerClientesRegistrados();
        configurarFormulario();
    }

    // ================================================================
    // M√ìDULO: INSPECCI√ìN
    // ================================================================

    function cargarClientes() {
        google.script.run.withSuccessHandler(llenarClientes).obtenerClientesRegistrados();
    }

    function llenarClientes(response) {
        const select = document.getElementById('idCliente');
        if (!select) return;
        if (response.status === 'success') {
            select.innerHTML = '<option value="">Seleccione la empresa...</option>';
            response.data.forEach(function (clie) {
                const opt = document.createElement('option');
                opt.value = clie.id;
                opt.textContent = clie.nombre;
                select.appendChild(opt);
            });
            _clientesCargados = true;
            // Intentar bloquear (puede que la obra ya se haya detectado)
            _intentarBloqueoEmpresa();
        } else {
            select.innerHTML = '<option value="">Error al cargar clientes</option>';
        }
    }

    /**
     * Carga los formatos espec√≠ficos de una empresa/obra.
     */
    function cargarFormatos(nombreObra) {
        const selectFmt = document.getElementById('idFormato');
        if (!selectFmt) return;
        selectFmt.innerHTML = '<option value="">Cargando formatos...</option>';

        google.script.run
            .withSuccessHandler(function (res) {
                if (res.status === 'success') {
                    _formatosDisponibles = res.data;
                    selectFmt.innerHTML = '<option value="">Seleccione un formato...</option>';
                    if (_formatosDisponibles.length === 0) {
                        selectFmt.innerHTML = '<option value="">Sin formatos registrados</option>';
                    }
                    _formatosDisponibles.forEach(function (f) {
                        const op = document.createElement('option');
                        op.value = f.id;
                        op.textContent = f.id + ' - ' + f.descripcion;
                        selectFmt.appendChild(op);
                    });
                } else {
                    selectFmt.innerHTML = '<option value="">Error al cargar formatos</option>';
                }
            })
            .obtenerFormatosPorEmpresa(nombreObra);

        // Cargar tambi√©n los pendientes para cierre
        cargarPendientes();
    }

    /**
     * Se dispara al seleccionar un formato en el combo.
     */
    function onCambioFormato(select) {
        const descCont = document.getElementById('formato-descripcion-container');
        const descText = document.getElementById('formato-descripcion-text');
        if (!descCont || !descText) return;

        const fmtId = select.value;
        const fmtData = _formatosDisponibles.find(f => f.id === fmtId);

        if (fmtData) {
            descText.textContent = fmtData.descripcion;
            descCont.classList.remove('hidden');
        } else {
            descCont.classList.add('hidden');
        }
    }

    /**
     * Coordinador: bloquea el campo empresa SOLO cuando ya se
     * cargaron los clientes Y se conoce la obra de la jornada activa.
     * Resuelve la race-condition entre llenarClientes() y verificarEstadoAsistencia().
     */
    function _intentarBloqueoEmpresa() {
        if (!_obraSeleccionada || !_clientesCargados) return;
        var select = document.getElementById('idCliente');
        if (!select) return;

        // Primero auto-seleccionar la opci√≥n correcta
        var obraLower = _obraSeleccionada.trim().toLowerCase();
        for (var i = 0; i < select.options.length; i++) {
            if (select.options[i].text.trim().toLowerCase() === obraLower) {
                select.selectedIndex = i;
                console.log('[SST] Obra auto-seleccionada:', _obraSeleccionada);
                break;
            }
        }
        // Ahora bloquear visualmente
        bloquearCampoEmpresa(select);

        // DISPARAR CARGA DE FORMATOS PARA ESTA OBRA
        cargarFormatos(_obraSeleccionada);
    }

    /**
     * Reemplaza el select de empresa/proyecto por un campo bloqueado.
     * Garantiza que cada hallazgo quede vinculado a la obra de la jornada activa.
     */
    function bloquearCampoEmpresa(select) {
        if (!select) select = document.getElementById('idCliente');
        if (!select) return;

        var id = select.value;
        var texto = select.options[select.selectedIndex]
            ? select.options[select.selectedIndex].text
            : _obraSeleccionada;

        // Contenedor padre del select
        var wrapper = select.parentNode;

        // Ocultar el select original (no disabled, para que siga siendo accesible por JS)
        select.style.display = 'none';

        // Ocultar bot√≥n "Actualizar" (innecesario cuando est√° bloqueado)
        var btnActualizar = wrapper.parentNode
            ? wrapper.parentNode.querySelector('[onclick="cargarClientes()"]')
            : null;
        if (btnActualizar) btnActualizar.style.display = 'none';

        // Insertar campo visual bloqueado (si no existe)
        var bloqueado = document.getElementById('idCliente-bloqueado');
        if (!bloqueado) {
            bloqueado = document.createElement('div');
            bloqueado.id = 'idCliente-bloqueado';
            bloqueado.style.cssText = [
                'display:flex', 'align-items:center', 'gap:.6rem',
                'background:rgba(197,160,72,.07)',
                'border:1px solid rgba(197,160,72,.3)',
                'border-radius:.75rem',
                'padding:.75rem 1rem',
                'cursor:not-allowed'
            ].join(';');
            bloqueado.innerHTML =
                '<span class="material-symbols-outlined" style="font-size:18px;color:var(--color-primario);flex-shrink:0;">lock</span>' +
                '<div style="flex:1;min-width:0;">' +
                '<p id="idCliente-bloqueado-texto" style="font-size:.9rem;font-weight:700;color:#f8fafc;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + texto + '</p>' +
                '<p style="font-size:.65rem;text-transform:uppercase;letter-spacing:.07em;color:rgba(197,160,72,.65);font-weight:700;margin-top:2px;">Fija para esta jornada</p>' +
                '</div>';
            wrapper.insertBefore(bloqueado, select);
        } else {
            // Actualizar texto si ya exist√≠a
            var t = document.getElementById('idCliente-bloqueado-texto');
            if (t) t.textContent = texto;
        }

        // Asegurar que el hidden input exista y tenga el valor correcto
        var hidden = document.getElementById('idCliente-hidden');
        if (!hidden) {
            hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.id = 'idCliente-hidden';
            hidden.name = 'idCliente-backup';
            wrapper.appendChild(hidden);
        }
        hidden.value = id;

        // Redirigir la lectura del ID al hidden input desde configurarFormulario()
        // actualizando el value del select oculto tambi√©n para que el c√≥digo existente funcione
        // (configurarFormulario() lee selectCliente.value que sigue accesible)
        console.log('[SST] Campo empresa BLOQUEADO. ID:', id, '| Obra:', texto);
    }


    function previewImagen(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            nombreArchivo = input.files[0].name;
            reader.onload = function (e) {
                archivoBase64 = e.target.result;
                const previewCont = document.getElementById('preview-container');
                const imgP = document.getElementById('img-preview');
                if (imgP) imgP.src = e.target.result;
                if (previewCont) previewCont.classList.remove('hidden');
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function configurarFormulario() {
        const form = document.getElementById('sst-form');
        if (!form) return;
        form.addEventListener('submit', function (e) {
            e.preventDefault();
            const btn = document.getElementById('btn-enviar');
            const spinner = document.getElementById('spinner');
            const btnText = document.getElementById('btn-text');
            if (btn) btn.disabled = true;
            if (spinner) spinner.classList.remove('hidden');
            if (btnText) btnText.textContent = "REGISTRANDO...";

            const selectCliente = document.getElementById('idCliente');
            const selectFormato = document.getElementById('idFormato');
            const fmtData = _formatosDisponibles.find(f => f.id === selectFormato.value);

            const formData = {
                userCode: currentUser.codigo || '',
                nombreCliente: selectCliente ? selectCliente.options[selectCliente.selectedIndex].text : _obraSeleccionada,
                idFormato: selectFormato ? selectFormato.value : '',
                descripcionRegistro: fmtData ? fmtData.descripcion : '',
                archivoBase64: archivoBase64
            };

            if (!formData.idFormato || !formData.archivoBase64) {
                mostrarNotificacion('‚ö†Ô∏è Por favor seleccione un formato y capture la foto.', 'warning');
                if (btn) btn.disabled = false;
                if (spinner) spinner.classList.add('hidden');
                if (btnText) btnText.textContent = "REGISTRAR PENDIENTE";
                return;
            }

            google.script.run
                .withSuccessHandler(function (res) {
                    if (res.status === 'success') {
                        onExito(res);
                        cargarPendientes();
                    } else {
                        onError(res.message);
                    }
                })
                .withFailureHandler(function (err) {
                    onError(err.toString());
                })
                .guardarRegistroFormato(formData);
        });
    }
    /**
     * Gesti√≥n de registros pendientes
     */
    function cargarPendientes() {
        if (!currentUser || !currentUser.email) return;
        const cont = document.getElementById('pendientes-container');
        const list = document.getElementById('lista-pendientes');
        if (!list) return;

        google.script.run
            .withSuccessHandler(function (res) {
                if (res.status === 'success' && res.data.length > 0) {
                    if (cont) cont.classList.remove('hidden');
                    renderizarPendientes(res.data);
                } else {
                    if (cont) cont.classList.add('hidden');
                }
            })
            .obtenerRegistrosPendientes(currentUser.email);
    }

    // Cache para filtrado
    let _registrosPendientes = [];

    function renderizarPendientes(registros) {
        _registrosPendientes = registros;
        const badge = document.getElementById('badge-pendientes');
        if (badge) badge.textContent = registros.length + ' pendiente' + (registros.length !== 1 ? 's' : '');
        _renderCards(registros);
    }

    function _renderCards(registros) {
        const list = document.getElementById('lista-pendientes');
        if (!list) return;
        list.innerHTML = '';

        if (registros.length === 0) {
            list.innerHTML = '<p class="text-center text-xs text-slate-600 italic py-4">Sin resultados</p>';
            return;
        }

        registros.forEach(function (reg) {
            const card = document.createElement('div');
            card.className = 'pendiente-card bg-white/5 border border-amber-500/20 rounded-xl p-3 animate-fade-in';
            card.dataset.id  = reg.id;
            card.dataset.fmt = (reg.formato + ' ' + reg.descripcion).toLowerCase();

            card.innerHTML = `
                <div class="flex items-start justify-between gap-2">
                    <div style="min-width:0; flex:1;">
                        <div class="flex items-center gap-1.5 mb-1">
                            <span class="inline-block w-2 h-2 rounded-full bg-amber-400 shrink-0"></span>
                            <p class="text-[10px] font-black text-amber-400 uppercase tracking-tight">${reg.id}</p>
                        </div>
                        <p class="text-xs font-bold text-white truncate leading-tight">${reg.formato}</p>
                        <p class="text-[10px] text-slate-400 truncate leading-tight">${reg.descripcion}</p>
                        <p class="text-[9px] text-slate-600 font-bold mt-1 flex items-center gap-1">
                            <span class="material-symbols-outlined text-[10px]">schedule</span>${reg.fecha}
                        </p>
                    </div>
                    <button onclick="abrirModalFirma('${reg.id}')"
                        class="shrink-0 flex items-center gap-1 bg-green-600/15 hover:bg-green-600/30 text-green-400 border border-green-500/30 px-3 py-2 rounded-lg text-[9px] font-black uppercase tracking-widest transition-all active:scale-95">
                        <span class="material-symbols-outlined text-sm">verified</span>Firmar
                    </button>
                </div>
            `;
            list.appendChild(card);
        });
    }

    /**
     * Filtra las tarjetas de pendientes en tiempo real (client-side).
     */
    function filtrarPendientes(query) {
        if (!query || query.trim() === '') {
            _renderCards(_registrosPendientes);
            return;
        }
        const q = query.trim().toLowerCase();
        const filtrados = _registrosPendientes.filter(function (r) {
            return r.id.toLowerCase().includes(q)
                || r.formato.toLowerCase().includes(q)
                || r.descripcion.toLowerCase().includes(q);
        });
        _renderCards(filtrados);
    }

    // ‚îÄ‚îÄ Estado interno del modal de firma ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let _firmaBase64 = null;
    let _firmaIdRegistro = '';

    /**
     * Abre el modal de captura de firma para un registro pendiente.
     */
    function abrirModalFirma(idRegistro) {
        _firmaBase64 = null;
        _firmaIdRegistro = idRegistro;

        // Reset visual del modal
        const preview = document.getElementById('firma-preview-container');
        const label   = document.getElementById('firma-foto-label');
        const input   = document.getElementById('firma-foto');
        const idLabel = document.getElementById('firma-modal-id');
        if (preview) preview.classList.add('hidden');
        if (label)   label.classList.remove('hidden');
        if (input)   input.value = '';
        if (idLabel) idLabel.textContent = 'Registro: ' + idRegistro;

        const modal = document.getElementById('firma-modal');
        if (modal) modal.classList.remove('hidden');
    }

    function cerrarModalFirma() {
        _firmaBase64 = null;
        _firmaIdRegistro = '';
        const modal = document.getElementById('firma-modal');
        if (modal) modal.classList.add('hidden');
    }

    /**
     * Muestra la preview de la foto de firma.
     */
    function previewFirma(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                _firmaBase64 = e.target.result;
                const prev  = document.getElementById('firma-img-preview');
                const cont  = document.getElementById('firma-preview-container');
                const label = document.getElementById('firma-foto-label');
                if (prev)  prev.src = e.target.result;
                if (cont)  cont.classList.remove('hidden');
                if (label) label.classList.add('hidden');
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    /**
     * Env√≠a el cierre con firma al backend.
     */
    function submitFirma() {
        if (!_firmaBase64) {
            mostrarNotificacion('‚ö†Ô∏è Capture la foto del formato firmado antes de confirmar.', 'error');
            return;
        }

        const btn     = document.getElementById('btn-submit-firma');
        const spinner = document.getElementById('firma-spinner');
        if (btn)     btn.disabled = true;
        if (spinner) spinner.classList.remove('hidden');

        google.script.run
            .withSuccessHandler(function (res) {
                if (btn)     btn.disabled = false;
                if (spinner) spinner.classList.add('hidden');
                cerrarModalFirma();
                if (res.status === 'success') {
                    mostrarNotificacion('‚úÖ ' + res.message, 'success');
                    cargarPendientes();
                } else {
                    mostrarNotificacion('‚ùå ' + res.message, 'error');
                }
            })
            .withFailureHandler(function (err) {
                if (btn)     btn.disabled = false;
                if (spinner) spinner.classList.add('hidden');
                mostrarNotificacion('‚ùå Error: ' + err.toString(), 'error');
            })
            .cerrarRegistroFormato(_firmaIdRegistro, _firmaBase64);
    }

    /** @deprecated ‚Äî reemplazado por abrirModalFirma */
    function confirmarCierrePendiente(id) {
        abrirModalFirma(id);
    }

    function onExito(response) {
        mostrarNotificacion('‚úÖ ' + response.message, 'success');
        const form = document.getElementById('sst-form');
        if (form) form.reset();

        archivoBase64 = null;
        const prev = document.getElementById('preview-container');
        if (prev) prev.classList.add('hidden');

        // Re-bloquear empresa e intentar cargar formatos de nuevo (por si acaso)
        _intentarBloqueoEmpresa();

        const descCont = document.getElementById('formato-descripcion-container');
        if (descCont) descCont.classList.add('hidden');

        const btn = document.getElementById('btn-enviar');
        const spinner = document.getElementById('spinner');
        const btnText = document.getElementById('btn-text');
        if (btn) btn.disabled = false;
        if (spinner) spinner.classList.add('hidden');
        if (btnText) btnText.textContent = "REGISTRAR PENDIENTE";
    }

    function onError(message) {
        mostrarNotificacion('‚ùå Error: ' + message, 'error');
        const btn = document.getElementById('btn-enviar');
        const spinner = document.getElementById('spinner');
        const btnText = document.getElementById('btn-text');
        if (btn) btn.disabled = false;
        if (spinner) spinner.classList.add('hidden');
        if (btnText) btnText.textContent = "REGISTRAR PENDIENTE";
    }
</script>