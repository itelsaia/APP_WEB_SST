<script>
    /**
     * APP.JS.HTML ‚Äî v3.0
     * Manejador central de sesi√≥n y l√≥gica UI.
     * Session h√≠brida: URL params + localStorage para evadir
     * limitaciones del sandbox de Google Apps Script.
     */

    let currentUser = null;
    let archivoBase64 = null;
    let nombreArchivo = '';
    let _obraSeleccionada = ''; // Obra elegida en el formulario de jornada
    let _clientesCargados = false; // Flag: ¬øya se carg√≥ el select de clientes?
    let _formatosDisponibles = []; // Cache de formatos del cliente seleccionado
    let _clientesCompletos = []; // Cache de clientes con contacto y celular (para hallazgos)
    let _rhArchivoBase64 = null; // Foto de evidencia del formulario de hallazgo

    window.addEventListener('load', function () {
        verificarSesion();
    });

    // ================================================================
    // GESTI√ìN DE SESI√ìN ‚Äî L√ìGICA ROBUSTA
    // ================================================================

    function verificarSesion() {
        console.log("[SST] Iniciando verificaci√≥n de sesi√≥n...");

        // 1. Prioridad absoluta: Si hay 'logout=true' en la URL o flag de salida reciente
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('logout') === 'true' || sessionStorage.getItem('justLoggedOut')) {
            console.log("[SST] Logout detectado. Bloqueando acceso autom√°tico.");
            sessionStorage.removeItem('justLoggedOut');
            localStorage.clear();
            mostrarErrorAcceso("Sesi√≥n cerrada correctamente.");
            return;
        }


        if (typeof SERVER_EMAIL !== 'undefined' && SERVER_EMAIL &&
            typeof SERVER_ROLE !== 'undefined' && SERVER_ROLE) {
            console.log("[SST] Datos del servidor detectados ‚Äî Email:", SERVER_EMAIL, "Rol:", SERVER_ROLE);
            recuperarSesionConEmail(decodeURIComponent(SERVER_EMAIL));
            return;
        }

        const storedUser = localStorage.getItem('userSST');
        if (storedUser) {
            try {
                currentUser = JSON.parse(storedUser);
                console.log("[SST] Sesi√≥n recuperada de localStorage:", currentUser.email);
            } catch (e) {
                localStorage.removeItem('userSST');
                currentUser = null;
            }
        }

        if (currentUser && currentUser.email && currentUser.rol) {
            inicializarAppConSesion();
            return;
        }

        console.log("[SST] Sin sesi√≥n en servidor ni localStorage, intentando URL...");

        try {
            if (typeof google !== 'undefined' && google.script && google.script.url) {
                google.script.url.getLocation(function (location) {
                    console.log("[SST] getLocation response:", JSON.stringify(location));
                    var emailParam = location.parameter ? location.parameter.email : null;
                    var roleParam = location.parameter ? location.parameter.role : null;

                    if (emailParam) {
                        recuperarSesionConEmail(decodeURIComponent(emailParam));
                    } else if (roleParam) {
                        recuperarSesionConServidor();
                    } else {
                        recuperarSesionConServidor();
                    }
                });
            } else {
                recuperarSesionConServidor();
            }
        } catch (e) {
            console.error("[SST] Error en getLocation:", e);
            recuperarSesionConServidor();
        }
    }

    function recuperarSesionConEmail(email) {
        google.script.run
            .withSuccessHandler(function (response) {
                if (response.status === 'success') {
                    currentUser = response.data;
                    localStorage.setItem('userSST', JSON.stringify(currentUser));
                    console.log("[SST] Sesi√≥n OK v√≠a email:", currentUser.email);
                    inicializarAppConSesion();
                } else {
                    mostrarErrorAcceso("No se pudo verificar la sesi√≥n. Por favor inicie sesi√≥n nuevamente.");
                }
            })
            .withFailureHandler(function (err) {
                mostrarErrorAcceso("Error de conexi√≥n. Por favor inicie sesi√≥n nuevamente.");
            })
            .obtenerDatosUsuario(email);
    }

    function recuperarSesionConServidor() {
        google.script.run
            .withSuccessHandler(function (response) {
                if (response.status === 'success') {
                    currentUser = response.data;
                    localStorage.setItem('userSST', JSON.stringify(currentUser));
                    inicializarAppConSesion();
                } else {
                    mostrarErrorAcceso("No se detect√≥ una sesi√≥n activa. Por favor inicie sesi√≥n.");
                }
            })
            .withFailureHandler(function (err) {
                mostrarErrorAcceso("Error de conexi√≥n. Por favor inicie sesi√≥n nuevamente.");
            })
            .obtenerUsuarioActivo();
    }

    /**
     * Orquesta la UI una vez que currentUser est√° disponible.
     */
    function inicializarAppConSesion() {
        inyectarDatosIdentidad();
        mostrarBienvenidaPersonalizada();

        if (currentUser && currentUser.rol === 'SUP-SST') {
            try {
                cargarObrasAsistencia();
                configurarAsistencia();
                cargarOtrasOpciones();
                verificarEstadoAsistencia();
            } catch (e) {
                console.error('[SST] Error en inicializaci√≥n SUP-SST:', e);
                switchModule('asistencia');
            }
        } else if (currentUser && currentUser.rol === 'ADMIN') {
            // Ampliar contenedor principal para pantalla completa
            var mainEl = document.querySelector('main');
            if (mainEl) {
                mainEl.classList.remove('max-w-2xl');
                mainEl.classList.add('max-w-6xl');
            }
            // Etiquetar el m√≥dulo activo en el header
            actualizarModuloHeader('Administraci√≥n');
            switchModule('admin');
        }

        ocultarLoader();
    }

    // ================================================================
    // IDENTIDAD Y BIENVENIDA
    // ================================================================

    function inyectarDatosIdentidad() {
        if (!currentUser) return;
        const elName = document.getElementById('user-name');
        const elEmail = document.getElementById('user-email');
        const elRole = document.getElementById('user-role-label');
        const elInfo = document.getElementById('user-info');
        if (elName) elName.textContent = currentUser.nombre || "Usuario";
        if (elEmail) elEmail.textContent = currentUser.email || "";
        if (elRole) elRole.textContent = currentUser.rol || "COLABORADOR";
        if (elInfo) elInfo.classList.remove('hidden');
    }

    function mostrarBienvenidaPersonalizada() {
        if (!currentUser) return;

        const welcomeSection = document.getElementById('welcome-section');
        const welcomeMsg = document.getElementById('welcome-message');
        const welcomeSub = document.getElementById('welcome-subtext');
        const welcomeIcon = document.getElementById('welcome-icon');

        if (!welcomeSection) return;

        const rol = currentUser.rol;
        const nombre = (currentUser.nombre || "Usuario").split(' ')[0];

        // Frases motivacionales para SST
        const quotes = [
            "La seguridad no es un eslogan, es un estilo de vida. üë∑",
            "Tu familia te espera, trabaja con seguridad. üë®‚Äçüë© family",
            "La mejor herramienta eres t√∫. ¬°Cu√≠date! üõ°Ô∏è",
            "Nada es tan importante que no pueda hacerse de forma segura. ‚úÖ",
            "Hoy es un gran d√≠a para prevenir accidentes. üöÄ",
            "Tu compromiso con la seguridad salva vidas. ü§ù",
            "Trabaja con pasi√≥n, pero siempre con precauci√≥n. ‚ú®",
            "La prevenci√≥n es la clave del √©xito. üîë"
        ];
        const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];

        let config = {
            msg: `¬°Hola, ${nombre}! üëã`,
            sub: randomQuote,
            icon: "sentiment_satisfied"
        };

        if (rol === 'SUP-SST') {
            config.msg = `¬°Bienvenido/a, ${nombre}! üë∑`;
            config.icon = "engineering";
        } else if (rol === 'ADMIN') {
            const adminQuotes = [
                "Una buena gesti√≥n es la base de una empresa segura.",
                "El liderazgo administrativo impulsa la cultura SST.",
                "Gestionar con datos, prevenir con conocimiento.",
                "La excelencia operativa comienza desde la administraci√≥n."
            ];
            config.msg = `¬°Hola, ${nombre}! Es un gusto saludarte. üëî`;
            config.sub = adminQuotes[Math.floor(Math.random() * adminQuotes.length)];
            config.icon = "admin_panel_settings";
        }

        if (rol === 'ADMIN') {
            // Para admin: poblar la bienvenida inline del portal (no la secci√≥n flotante)
            var inlineMsg  = document.getElementById('admin-welcome-msg');
            var inlineSub  = document.getElementById('admin-welcome-sub');
            var inlineIcon = document.getElementById('admin-welcome-icon');
            if (inlineMsg)  inlineMsg.textContent  = config.msg;
            if (inlineSub)  inlineSub.textContent  = config.sub;
            if (inlineIcon) inlineIcon.textContent = config.icon;
            // welcome-section permanece oculta para evitar solapamiento con el modal
        } else {
            if (welcomeMsg)  welcomeMsg.textContent  = config.msg;
            if (welcomeSub)  welcomeSub.textContent  = config.sub;
            if (welcomeIcon) welcomeIcon.textContent = config.icon;
            const mobileGreet = document.getElementById('welcome-message-mobile');
            if (mobileGreet) mobileGreet.textContent = '¬°Hola, ' + nombre + '!';
            welcomeSection.classList.remove('hidden');
        }
    }

    /**
     * Actualiza el subt√≠tulo del m√≥dulo en el header principal.
     * @param {string} texto Nombre del m√≥dulo activo (ej: 'Gesti√≥n de Empresas')
     */
    function actualizarModuloHeader(texto) {
        var el = document.getElementById('header-modulo-label');
        if (el) el.textContent = texto;
    }

    function mostrarErrorAcceso(msj) {
        const content = document.getElementById('main-content');
        if (!content) return;
        const scriptUrl = window.location.href.split('?')[0];
        content.innerHTML = `
            <div class="flex flex-col items-center justify-center py-12 px-4 animate-fade-in">
                <div class="bg-white/5 backdrop-blur-xl rounded-3xl p-10 border border-white/10 shadow-2xl max-w-sm w-full text-center">
                    <div class="w-20 h-20 bg-red-500/10 rounded-2xl flex items-center justify-center mx-auto mb-6 border border-red-500/20">
                        <span class="material-symbols-outlined text-5xl text-red-500">lock</span>
                    </div>
                    <h3 class="text-2xl font-black text-white tracking-tight mb-2 uppercase">Acceso Restringido</h3>
                    <p class="text-slate-400 font-medium mb-8 leading-relaxed">${msj}</p>
                    <a href="${scriptUrl}" 
                       class="block w-full bg-primary text-black py-4 rounded-xl font-black uppercase tracking-widest shadow-lg shadow-primary/20 hover:opacity-90 transition-all active:scale-95">
                        Ir al Login
                    </a>
                </div>
            </div>
        `;
        content.classList.remove('hidden');
        ocultarLoader();
    }

    function ocultarLoader() {
        const loader = document.getElementById('initial-loader');
        if (loader) {
            loader.classList.add('opacity-0');
            setTimeout(() => loader.remove(), 500);
        }
    }

    // Helper: navega al Login usando anchor target="_top" (m√©todo oficial en GAS iframes)
    function _irAlLogin(urlBase) {
        var url = urlBase.split('?')[0] + '?page=login';
        console.log("[SST] Navegando al Login:", url);
        var a = document.createElement('a');
        a.href = url;
        a.target = '_top';
        document.body.appendChild(a);
        a.click();
    }

    // Bot√≥n "Cerrar Sesi√≥n" del header
    function cerrarSesion() {
        console.log("[SST] Cerrando sesi√≥n (header)...");
        localStorage.clear();
        sessionStorage.clear();

        // SERVER_URL est√° inyectado por el servidor ‚Äî es la fuente m√°s confiable.
        // Si por alguna raz√≥n est√° vac√≠o, caemos al API de GAS como respaldo.
        if (typeof SERVER_URL !== 'undefined' && SERVER_URL) {
            _irAlLogin(SERVER_URL);
        } else {
            google.script.run
                .withSuccessHandler(_irAlLogin)
                .withFailureHandler(function () {
                    alert("No se pudo obtener la URL de sesi√≥n. Recargue la p√°gina.");
                })
                .getScriptUrl();
        }
    }

    // ================================================================
    // M√ìDULO: ASISTENCIA
    // ================================================================

    /**
     * Cambia entre la vista de asistencia y el panel de trabajo.
     */
    function switchModule(target) {
        const asisCont = document.getElementById('asistencia-content');
        const mainCont = document.getElementById('main-content');

        console.log("[SST] switchModule llamado con:", target);

        if (target === 'asistencia') {
            if (asisCont) asisCont.classList.remove('hidden');
            if (mainCont) mainCont.classList.add('hidden');
        } else {
            // 'inspeccion' o cualquier otro -> mostrar panel principal
            if (asisCont) asisCont.classList.add('hidden');
            if (mainCont) mainCont.classList.remove('hidden');
        }
    }

    /**
     * Verifica el estado de asistencia en el servidor.
     * Si tiene jornada activa -> panel de trabajo + bot√≥n salida.
     * Si no -> pantalla de registro de entrada.
     */
    function verificarEstadoAsistencia() {
        if (!currentUser || !currentUser.email) return;
        console.log('[SST] Verificando estado de asistencia para:', currentUser.email);

        google.script.run
            .withSuccessHandler(function (response) {
                console.log('[SST] Respuesta de obtenerEstadoAsistencia:', JSON.stringify(response));
                const exitSection = document.getElementById('exit-section');

                if (response.status === 'success' && response.data && response.data.activo) {
                    console.log('[SST] ‚úÖ Jornada ACTIVA detectada ‚Äî mostrando panel de trabajo');
                    // Recuperar la obra activa para bloquear el formulario de inspecci√≥n
                    if (response.data.obra) {
                        _obraSeleccionada = response.data.obra;
                        console.log('[SST] Obra activa recuperada del servidor:', _obraSeleccionada);
                    }
                    switchModule('inspeccion');
                    if (exitSection) exitSection.classList.remove('hidden');
                    // Intentar bloquear (puede que los clientes ya hayan cargado)
                    _intentarBloqueoEmpresa();
                } else {
                    console.log('[SST] ‚è≥ Sin jornada activa ‚Äî mostrando registro de entrada');
                    switchModule('asistencia');
                    if (exitSection) exitSection.classList.add('hidden');
                }
            })
            .withFailureHandler(function (err) {
                console.error('[SST] Error verificando asistencia:', err);
                switchModule('asistencia');
            })
            .obtenerEstadoAsistencia(currentUser.email);
    }

    function previewAsistencia(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                archivoBase64 = e.target.result;
                const prev = document.getElementById('asis-img-preview');
                const cont = document.getElementById('asis-preview-container');
                const label = document.getElementById('asis-foto-label');
                if (prev) prev.src = e.target.result;
                if (cont) cont.classList.remove('hidden');
                // Ocultar bot√≥n de captura para evitar duplicados
                if (label) label.classList.add('hidden');
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    /**
     * Configura el formulario de asistencia (solo ENTRADA).
     * FIX PRINCIPAL: Despu√©s de registrar exitosamente, se redirige
     * DIRECTAMENTE al panel de trabajo sin esperar otra llamada al servidor.
     */
    function configurarAsistencia() {
        const form = document.getElementById('attendance-form');
        if (!form) return;

        form.addEventListener('submit', function (e) {
            e.preventDefault();

            const obraSelect = document.getElementById('idObraAsistencia');

            if (obraSelect && (obraSelect.value === '' || obraSelect.selectedIndex === 0)) {
                alert("‚ö†Ô∏è Por favor seleccione la Obra / Proyecto.");
                return;
            }

            if (!archivoBase64) {
                alert("‚ö†Ô∏è Debe capturar la foto de ingreso.");
                return;
            }

            const btn = document.getElementById('btn-asistencia');
            const spinner = document.getElementById('asis-spinner');
            const btnText = document.getElementById('asis-btn-text');
            const btnIcon = document.getElementById('asis-btn-icon');

            if (btn) btn.disabled = true;
            if (spinner) spinner.classList.remove('hidden');
            if (btnText) btnText.textContent = "REGISTRANDO...";
            if (btnIcon) btnIcon.classList.add('hidden');

            const payload = {
                userEmail: currentUser.email,
                obra: obraSelect ? obraSelect.options[obraSelect.selectedIndex].text : "Gen√©rica",
                archivoBase64: archivoBase64
            };

            google.script.run
                .withSuccessHandler(function (res) {
                    console.log('[SST] Respuesta registrarIngreso:', JSON.stringify(res));

                    if (res.status === 'success') {
                        // Guardar la obra seleccionada para pre-rellenar el formulario de inspecci√≥n
                        _obraSeleccionada = obraSelect
                            ? obraSelect.options[obraSelect.selectedIndex].text
                            : '';
                        console.log('[SST] Obra guardada:', _obraSeleccionada);

                        // Limpiar formulario
                        archivoBase64 = null;
                        const cont = document.getElementById('asis-preview-container');
                        if (cont) cont.classList.add('hidden');

                        // Mostrar el panel de trabajo DIRECTAMENTE
                        switchModule('inspeccion');

                        // Mostrar el bot√≥n de salida
                        const exitSection = document.getElementById('exit-section');
                        if (exitSection) exitSection.classList.remove('hidden');

                        // Bloquear el campo empresa con la obra seleccionada
                        _intentarBloqueoEmpresa();

                        // Notificaci√≥n amigable (no bloqueante)
                        mostrarNotificacion('‚úÖ ' + res.message, 'success');
                    } else {
                        alert("‚ö†Ô∏è " + res.message);
                    }

                    // Restaurar bot√≥n
                    if (btn) btn.disabled = false;
                    if (spinner) spinner.classList.add('hidden');
                    if (btnText) btnText.textContent = "INICIAR JORNADA";
                    if (btnIcon) btnIcon.classList.remove('hidden');
                })
                .withFailureHandler(function (err) {
                    console.error("[SST] Error en registrarIngreso:", err);
                    alert("‚ùå Error: " + err.toString());
                    if (btn) btn.disabled = false;
                    if (spinner) spinner.classList.add('hidden');
                    if (btnText) btnText.textContent = "INICIAR JORNADA";
                    if (btnIcon) btnIcon.classList.remove('hidden');
                }).registrarIngreso(payload);
        });
    }

    /**
     * Muestra una notificaci√≥n tipo toast no-bloqueante
     */
    function mostrarNotificacion(mensaje, tipo) {
        const toast = document.createElement('div');
        toast.className = `fixed bottom-8 left-1/2 -translate-x-1/2 z-[100] px-6 py-4 rounded-2xl shadow-2xl backdrop-blur-xl border font-bold text-xs uppercase tracking-widest animate-slide-up flex items-center space-x-3 min-w-[300px] justify-center ${tipo === 'success'
            ? 'bg-green-500/10 border-green-500/20 text-green-400'
            : 'bg-red-500/10 border-red-500/20 text-red-400'
            }`;

        const icon = tipo === 'success' ? 'check_circle' : 'error';
        toast.innerHTML = `<span class="material-symbols-outlined text-lg">${icon}</span><span>${mensaje}</span>`;

        document.body.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translate(-50%, 20px)';
            toast.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
            setTimeout(() => toast.remove(), 500);
        }, 3500);
    }

    // ================================================================
    // GESTI√ìN DE SALIDA (MODAL)
    // ================================================================

    function openExitModal() {
        document.getElementById('exit-modal').classList.remove('hidden');
    }

    function closeExitModal() {
        document.getElementById('exit-modal').classList.add('hidden');
        const prev = document.getElementById('exit-preview-container');
        const label = document.getElementById('exit-foto-label');
        if (prev) prev.classList.add('hidden');
        // Mostrar el label de nuevo por si cancel√≥ para volver a intentar
        if (label) label.classList.remove('hidden');
        archivoBase64 = null;
    }

    function previewSalida(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                archivoBase64 = e.target.result;
                const prev = document.getElementById('exit-img-preview');
                const cont = document.getElementById('exit-preview-container');
                const label = document.getElementById('exit-foto-label');
                if (prev) prev.src = e.target.result;
                if (cont) cont.classList.remove('hidden');
                // Ocultar bot√≥n de captura
                if (label) label.classList.add('hidden');
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function submitSalida() {
        if (!archivoBase64) {
            alert("‚ö†Ô∏è Debe capturar la foto de salida.");
            return;
        }

        const btn = document.getElementById('btn-submit-salida');
        const spinner = document.getElementById('exit-spinner');
        if (btn) btn.disabled = true;
        if (spinner) spinner.classList.remove('hidden');

        // ‚îÄ‚îÄ PASO 1: Registrar salida en el backend (fire-and-forget) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // No esperamos la respuesta del servidor para cerrar sesi√≥n.
        // La sesi√≥n se cierra SIEMPRE, independientemente del resultado del backend.
        google.script.run
            .withSuccessHandler(function (r) { console.log("[SST] registrarSalida:", r.status); })
            .withFailureHandler(function (e) { console.warn("[SST] registrarSalida error:", e); })
            .registrarSalida({
                userEmail: currentUser ? currentUser.email : '',
                archivoBase64: archivoBase64
            });

        // ‚îÄ‚îÄ PASO 2: Cerrar modal, notificar y limpiar almacenamiento ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        closeExitModal();
        if (btn) btn.disabled = false;
        if (spinner) spinner.classList.add('hidden');
        mostrarNotificacion("üëã Jornada finalizada. Cerrando sesi√≥n...", "success");
        localStorage.clear();
        sessionStorage.clear();

        // ‚îÄ‚îÄ PASO 3: Obtener URL real del script y navegar al Login ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Usamos getScriptUrl() porque es la fuente m√°s confiable en GAS.
        // SERVER_URL puede quedar vac√≠o si el bloque try{} de Index.html falla.
        google.script.run
            .withSuccessHandler(_irAlLogin)
            .withFailureHandler(function () {
                // Fallback: SERVER_URL si el API falla
                if (typeof SERVER_URL !== 'undefined' && SERVER_URL) {
                    _irAlLogin(SERVER_URL);
                } else {
                    alert("Error al cerrar sesi√≥n. Cierre la pesta√±a manualmente.");
                }
            })
            .getScriptUrl();
    }

    // ================================================================
    // CARGA DE DATOS
    // ================================================================

    function cargarObrasAsistencia() {
        google.script.run
            .withSuccessHandler(function (response) {
                const select = document.getElementById('idObraAsistencia');
                if (!select) return;
                if (response.status === "success" && response.data && response.data.length > 0) {
                    select.innerHTML = '<option value="">Seleccione la obra...</option>';
                    response.data.forEach(clie => {
                        const opt = document.createElement('option');
                        opt.value = clie.id;
                        opt.textContent = clie.nombre;
                        select.appendChild(opt);
                    });
                } else {
                    select.innerHTML = '<option value="">No hay obras registradas</option>';
                }
            })
            .withFailureHandler(function () {
                const select = document.getElementById('idObraAsistencia');
                if (select) select.innerHTML = '<option value="">Error al cargar obras</option>';
            })
            .obtenerClientesRegistrados();
    }

    function cargarOtrasOpciones() {
        google.script.run.withSuccessHandler(llenarClientes).obtenerClientesRegistrados();
        configurarFormulario();
    }

    // ================================================================
    // M√ìDULO: INSPECCI√ìN
    // ================================================================

    function cargarClientes() {
        google.script.run.withSuccessHandler(llenarClientes).obtenerClientesRegistrados();
    }

    function llenarClientes(response) {
        const select = document.getElementById('idCliente');
        if (!select) return;
        if (response.status === 'success') {
            _clientesCompletos = response.data; // Cache con contacto y celular para hallazgos
            select.innerHTML = '<option value="">Seleccione la empresa...</option>';
            response.data.forEach(function (clie) {
                const opt = document.createElement('option');
                opt.value = clie.id;
                opt.textContent = clie.nombre;
                select.appendChild(opt);
            });
            _clientesCargados = true;
            // Intentar bloquear (puede que la obra ya se haya detectado)
            _intentarBloqueoEmpresa();
        } else {
            select.innerHTML = '<option value="">Error al cargar clientes</option>';
        }
    }

    /**
     * Carga los formatos espec√≠ficos de una empresa/obra.
     */
    function cargarFormatos(nombreObra) {
        const selectFmt = document.getElementById('idFormato');
        if (!selectFmt) return;
        selectFmt.innerHTML = '<option value="">Cargando formatos...</option>';

        google.script.run
            .withSuccessHandler(function (res) {
                if (res.status === 'success') {
                    _formatosDisponibles = res.data;
                    selectFmt.innerHTML = '<option value="">Seleccione un formato...</option>';
                    if (_formatosDisponibles.length === 0) {
                        selectFmt.innerHTML = '<option value="">Sin formatos registrados</option>';
                    }
                    _formatosDisponibles.forEach(function (f) {
                        const op = document.createElement('option');
                        op.value = f.id;
                        op.textContent = f.id + ' - ' + f.descripcion;
                        selectFmt.appendChild(op);
                    });
                } else {
                    selectFmt.innerHTML = '<option value="">Error al cargar formatos</option>';
                }
            })
            .obtenerFormatosPorEmpresa(nombreObra);

        // Cargar tambi√©n los pendientes para cierre
        cargarPendientes();
    }

    /**
     * Se dispara al seleccionar un formato en el combo.
     * Si el Id_Formato empieza con 'RH', carga el formulario de hallazgo.
     * De lo contrario, muestra el formulario est√°ndar de inspecci√≥n.
     */
    function onCambioFormato(select) {
        const fmtId   = select.value;
        const fmtData = _formatosDisponibles.find(f => f.id === fmtId);

        // Detectar formato RH ‚Üí Reporte de Hallazgo
        if (fmtId && fmtId.toUpperCase().startsWith('RH')) {
            mostrarFormularioHallazgo(fmtData);
            return;
        }

        // Formulario est√°ndar de inspecci√≥n
        mostrarFormularioEstandar();

        const descCont = document.getElementById('formato-descripcion-container');
        const descText = document.getElementById('formato-descripcion-text');
        if (!descCont || !descText) return;
        if (fmtData) {
            descText.textContent = fmtData.descripcion;
            descCont.classList.remove('hidden');
        } else {
            descCont.classList.add('hidden');
        }
    }

    /**
     * Muestra el formulario de Reporte de Hallazgo y oculta el formulario est√°ndar.
     * Auto-rellena empresa, contacto y celular desde el contexto de la jornada activa.
     */
    function mostrarFormularioHallazgo(fmtData) {
        // Ocultar partes del formulario est√°ndar que no aplican
        const sstBody = document.getElementById('sst-form');
        if (sstBody) {
            // Ocultar foto + botones del formulario est√°ndar (mantener selects visibles)
            ['fotoEvidencia', 'preview-container', 'btn-pendiente', 'btn-con-firma',
             'formato-descripcion-container'].forEach(function(id) {
                const el = document.querySelector('[id="' + id + '"]') ||
                           document.querySelector('label[for="' + id + '"]');
                // Ocultar la secci√≥n de foto y botones envolvi√©ndola
            });
            // Ocultar todo el form excepto los selects
            sstBody.classList.add('hidden');
        }
        // Ocultar descripci√≥n del formato est√°ndar
        const descCont = document.getElementById('formato-descripcion-container');
        if (descCont) descCont.classList.add('hidden');

        // Mostrar formulario de hallazgo
        const formRH = document.getElementById('form-hallazgo-container');
        if (!formRH) return;
        formRH.classList.remove('hidden');

        // Actualizar descripci√≥n del formato RH
        const rhDesc = document.getElementById('rh-fmt-desc');
        if (rhDesc && fmtData) rhDesc.textContent = fmtData.descripcion || 'Reporte de Hallazgo SST';

        // Auto-rellenar empresa desde la jornada activa
        const empresa = _obraSeleccionada || '';
        const rhNombre = document.getElementById('rh-empresa-nombre');
        const rhValor  = document.getElementById('rh-empresa-valor');
        if (rhNombre) rhNombre.textContent = empresa || 'No detectada';
        if (rhValor)  rhValor.value = empresa;

        // Auto-rellenar contacto y celular desde el cache de clientes
        const clienteData = _clientesCompletos.find(function(c) {
            return c.nombre.toLowerCase().trim() === empresa.toLowerCase().trim();
        });
        if (clienteData) {
            const rhA   = document.getElementById('rh-reportado-a');
            const rhTel = document.getElementById('rh-telefono');
            if (rhA   && clienteData.contacto) rhA.value   = clienteData.contacto;
            if (rhTel && clienteData.celular)  rhTel.value = clienteData.celular;
        }

        // Limpiar foto previa
        _rhArchivoBase64 = null;
        const prev = document.getElementById('rh-preview-container');
        if (prev) prev.classList.add('hidden');
    }

    /**
     * Muestra el formulario est√°ndar de inspecci√≥n y oculta el de hallazgo.
     */
    function mostrarFormularioEstandar() {
        const sstBody = document.getElementById('sst-form');
        if (sstBody) sstBody.classList.remove('hidden');
        const formRH = document.getElementById('form-hallazgo-container');
        if (formRH) formRH.classList.add('hidden');
    }

    /**
     * Preview de la foto de evidencia del hallazgo.
     */
    function previewHallazgo(input) {
        if (!input.files || !input.files[0]) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            _rhArchivoBase64 = e.target.result;
            const prev = document.getElementById('rh-preview-container');
            const img  = document.getElementById('rh-img-preview');
            if (prev) prev.classList.remove('hidden');
            if (img)  img.src = _rhArchivoBase64;
        };
        reader.readAsDataURL(input.files[0]);
    }

    /**
     * Valida y env√≠a el Reporte de Hallazgo al backend.
     * Al tener √©xito construye el enlace wa.me y lo abre autom√°ticamente.
     */
    function reportarHallazgo() {
        const ubicacion  = (document.getElementById('rh-ubicacion')  || {}).value || '';
        const descripcion= (document.getElementById('rh-descripcion') || {}).value || '';
        const reportadoA = (document.getElementById('rh-reportado-a')|| {}).value || '';
        const telefono   = (document.getElementById('rh-telefono')   || {}).value || '';

        if (!ubicacion.trim()) {
            mostrarNotificacion('‚ö†Ô∏è Ingrese la ubicaci√≥n del hallazgo.', 'warning'); return;
        }
        if (!descripcion.trim()) {
            mostrarNotificacion('‚ö†Ô∏è Ingrese la descripci√≥n del hallazgo.', 'warning'); return;
        }
        if (!_rhArchivoBase64) {
            mostrarNotificacion('‚ö†Ô∏è Capture la foto de evidencia.', 'warning'); return;
        }

        const btn = document.getElementById('btn-reportar-hallazgo');
        const sp  = document.getElementById('rh-spinner');
        if (btn) btn.disabled = true;
        if (sp)  sp.classList.remove('hidden');

        const empresa = (document.getElementById('rh-empresa-valor') || {}).value
                        || _obraSeleccionada || '';

        google.script.run
            .withSuccessHandler(function(res) {
                if (sp)  sp.classList.add('hidden');
                if (btn) btn.disabled = false;

                if (res.status === 'success') {
                    const d = res.data;
                    mostrarNotificacion('‚úÖ Hallazgo ' + d.idHallazgo + ' reportado.', 'success');

                    // Construir y abrir enlace WhatsApp
                    const mensaje = [
                        'üö® *HALLAZGO SST ‚Äî ' + d.idHallazgo + '*',
                        'üìç Ubicaci√≥n: ' + ubicacion,
                        'üìã Descripci√≥n: ' + descripcion,
                        'üë∑ Reportado por: ' + (currentUser ? currentUser.nombre : ''),
                        'üîó Para gestionar y cerrar el hallazgo: ' + d.urlCierre
                    ].join('\n');

                    const numLimpio = telefono.replace(/\D/g, '');
                    if (numLimpio) {
                        const waUrl = 'https://wa.me/57' + numLimpio + '?text=' + encodeURIComponent(mensaje);
                        mostrarModalWhatsApp(waUrl, reportadoA);
                    } else {
                        mostrarNotificacion('‚úÖ Hallazgo guardado. Agregue el n√∫mero para enviar WhatsApp.', 'success');
                    }

                    // Limpiar formulario de hallazgo y volver al est√°ndar
                    ['rh-ubicacion', 'rh-descripcion', 'rh-reportado-a', 'rh-telefono'].forEach(function(id) {
                        const el = document.getElementById(id);
                        if (el) el.value = '';
                    });
                    _rhArchivoBase64 = null;
                    const prev = document.getElementById('rh-preview-container');
                    if (prev) prev.classList.add('hidden');
                    const fotoInput = document.getElementById('rh-foto');
                    if (fotoInput) fotoInput.value = '';

                    // Resetear selector de formato y volver al form est√°ndar
                    const selectFmt = document.getElementById('idFormato');
                    if (selectFmt) selectFmt.value = '';
                    mostrarFormularioEstandar();

                } else {
                    mostrarNotificacion('‚ùå ' + res.message, 'error');
                }
            })
            .withFailureHandler(function(err) {
                if (sp)  sp.classList.add('hidden');
                if (btn) btn.disabled = false;
                mostrarNotificacion('‚ùå Error: ' + err.toString(), 'error');
            })
            .guardarHallazgo({
                ubicacion:          ubicacion.trim(),
                descripcion:        descripcion.trim(),
                empresaContratista: empresa,
                reportadoPor:       currentUser ? (currentUser.codigo || currentUser.nombre) : '',
                reportadoA:         reportadoA.trim(),
                numeroContacto:     telefono.trim(),
                fotoBase64:         _rhArchivoBase64
            });
    }

    /**
     * Modal de WhatsApp: muestra un bottom-sheet con un enlace wa.me tappable.
     * Soluci√≥n al bloqueo de window.open() dentro de callbacks async de GAS.
     */
    function mostrarModalWhatsApp(waUrl, nombre) {
        // Evitar duplicados
        var existing = document.getElementById('modal-whatsapp-hallazgo');
        if (existing) existing.remove();

        var overlay = document.createElement('div');
        overlay.id = 'modal-whatsapp-hallazgo';
        overlay.style.cssText = [
            'position:fixed', 'inset:0', 'z-index:9999',
            'background:rgba(0,0,0,0.7)', 'backdrop-filter:blur(4px)',
            'display:flex', 'align-items:flex-end', 'justify-content:center',
            'padding:16px', 'animation:fadeIn 0.25s ease-out'
        ].join(';');

        overlay.innerHTML = [
            '<div style="width:100%;max-width:420px;background:#101922;border:1px solid rgba(255,255,255,0.1);',
            'border-radius:24px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.6);">',

            // Cabecera
            '<div style="background:rgba(37,211,102,0.08);border-bottom:1px solid rgba(37,211,102,0.2);',
            'padding:16px;display:flex;align-items:center;gap:12px;">',
            '<div style="width:40px;height:40px;background:rgba(37,211,102,0.15);border:1px solid rgba(37,211,102,0.3);',
            'border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0;">',
            '<svg viewBox="0 0 24 24" width="22" height="22" fill="#25d366">',
            '<path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/><path d="M12 0C5.373 0 0 5.373 0 12c0 2.126.553 4.116 1.521 5.851L.057 23.941l6.264-1.438A11.94 11.94 0 0012 24c6.627 0 12-5.373 12-12S18.627 0 12 0zm0 21.818a9.807 9.807 0 01-5.004-1.367l-.36-.213-3.72.854.895-3.617-.235-.372A9.801 9.801 0 012.182 12C2.182 6.57 6.57 2.182 12 2.182S21.818 6.57 21.818 12 17.43 21.818 12 21.818z"/>',
            '</svg></div>',
            '<div>',
            '<p style="font-size:13px;font-weight:900;color:#fff;line-height:1;">Notificar por WhatsApp</p>',
            '<p style="font-size:10px;color:rgba(37,211,102,0.7);font-weight:700;margin-top:2px;">Hallazgo reportado exitosamente</p>',
            '</div></div>',

            // Cuerpo
            '<div style="padding:20px;display:flex;flex-direction:column;gap:12px;">',
            '<p style="font-size:12px;color:#94a3b8;line-height:1.5;">',
            'Toca el bot√≥n para abrir WhatsApp y enviar el aviso a <strong style="color:#fff;">' + (nombre || 'el responsable') + '</strong>.',
            '</p>',

            // Bot√≥n WhatsApp ‚Äî anchor real, no window.open
            '<a href="' + waUrl + '" target="_blank" rel="noopener noreferrer"',
            ' style="display:flex;align-items:center;justify-content:center;gap:10px;',
            'background:linear-gradient(135deg,#25d366,#128c7e);',
            'color:#fff;font-size:12px;font-weight:900;text-transform:uppercase;letter-spacing:.1em;',
            'text-decoration:none;padding:16px;border-radius:14px;',
            'box-shadow:0 6px 20px rgba(37,211,102,0.35);',
            'border:none;cursor:pointer;" onclick="document.getElementById(\'modal-whatsapp-hallazgo\').remove();">',
            '<svg viewBox="0 0 24 24" width="20" height="20" fill="#fff">',
            '<path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/><path d="M12 0C5.373 0 0 5.373 0 12c0 2.126.553 4.116 1.521 5.851L.057 23.941l6.264-1.438A11.94 11.94 0 0012 24c6.627 0 12-5.373 12-12S18.627 0 12 0zm0 21.818a9.807 9.807 0 01-5.004-1.367l-.36-.213-3.72.854.895-3.617-.235-.372A9.801 9.801 0 012.182 12C2.182 6.57 6.57 2.182 12 2.182S21.818 6.57 21.818 12 17.43 21.818 12 21.818z"/>',
            '</svg>',
            'Abrir WhatsApp',
            '</a>',

            // Bot√≥n cerrar
            '<button onclick="document.getElementById(\'modal-whatsapp-hallazgo\').remove()"',
            ' style="background:transparent;border:1px solid rgba(255,255,255,0.1);color:#64748b;',
            'font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;',
            'padding:12px;border-radius:12px;cursor:pointer;">',
            'Cerrar',
            '</button>',
            '</div></div>'
        ].join('');

        // Cerrar al tocar el fondo
        overlay.addEventListener('click', function(e) {
            if (e.target === overlay) overlay.remove();
        });

        document.body.appendChild(overlay);
    }

    /**
     * Coordinador: bloquea el campo empresa SOLO cuando ya se
     * cargaron los clientes Y se conoce la obra de la jornada activa.
     * Resuelve la race-condition entre llenarClientes() y verificarEstadoAsistencia().
     */
    function _intentarBloqueoEmpresa() {
        if (!_obraSeleccionada || !_clientesCargados) return;
        var select = document.getElementById('idCliente');
        if (!select) return;

        // Primero auto-seleccionar la opci√≥n correcta
        var obraLower = _obraSeleccionada.trim().toLowerCase();
        for (var i = 0; i < select.options.length; i++) {
            if (select.options[i].text.trim().toLowerCase() === obraLower) {
                select.selectedIndex = i;
                console.log('[SST] Obra auto-seleccionada:', _obraSeleccionada);
                break;
            }
        }
        // Ahora bloquear visualmente
        bloquearCampoEmpresa(select);

        // DISPARAR CARGA DE FORMATOS PARA ESTA OBRA
        cargarFormatos(_obraSeleccionada);
    }

    /**
     * Reemplaza el select de empresa/proyecto por un campo bloqueado.
     * Garantiza que cada hallazgo quede vinculado a la obra de la jornada activa.
     */
    function bloquearCampoEmpresa(select) {
        if (!select) select = document.getElementById('idCliente');
        if (!select) return;

        var id = select.value;
        var texto = select.options[select.selectedIndex]
            ? select.options[select.selectedIndex].text
            : _obraSeleccionada;

        // Contenedor padre del select
        var wrapper = select.parentNode;

        // Ocultar el select original (no disabled, para que siga siendo accesible por JS)
        select.style.display = 'none';

        // Ocultar bot√≥n "Actualizar" (innecesario cuando est√° bloqueado)
        var btnActualizar = wrapper.parentNode
            ? wrapper.parentNode.querySelector('[onclick="cargarClientes()"]')
            : null;
        if (btnActualizar) btnActualizar.style.display = 'none';

        // Insertar campo visual bloqueado (si no existe)
        var bloqueado = document.getElementById('idCliente-bloqueado');
        if (!bloqueado) {
            bloqueado = document.createElement('div');
            bloqueado.id = 'idCliente-bloqueado';
            bloqueado.style.cssText = [
                'display:flex', 'align-items:center', 'gap:.6rem',
                'background:rgba(197,160,72,.07)',
                'border:1px solid rgba(197,160,72,.3)',
                'border-radius:.75rem',
                'padding:.75rem 1rem',
                'cursor:not-allowed'
            ].join(';');
            bloqueado.innerHTML =
                '<span class="material-symbols-outlined" style="font-size:18px;color:var(--color-primario);flex-shrink:0;">lock</span>' +
                '<div style="flex:1;min-width:0;">' +
                '<p id="idCliente-bloqueado-texto" style="font-size:.9rem;font-weight:700;color:#f8fafc;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + texto + '</p>' +
                '<p style="font-size:.65rem;text-transform:uppercase;letter-spacing:.07em;color:rgba(197,160,72,.65);font-weight:700;margin-top:2px;">Fija para esta jornada</p>' +
                '</div>';
            wrapper.insertBefore(bloqueado, select);
        } else {
            // Actualizar texto si ya exist√≠a
            var t = document.getElementById('idCliente-bloqueado-texto');
            if (t) t.textContent = texto;
        }

        // Asegurar que el hidden input exista y tenga el valor correcto
        var hidden = document.getElementById('idCliente-hidden');
        if (!hidden) {
            hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.id = 'idCliente-hidden';
            hidden.name = 'idCliente-backup';
            wrapper.appendChild(hidden);
        }
        hidden.value = id;

        // Redirigir la lectura del ID al hidden input desde configurarFormulario()
        // actualizando el value del select oculto tambi√©n para que el c√≥digo existente funcione
        // (configurarFormulario() lee selectCliente.value que sigue accesible)
        console.log('[SST] Campo empresa BLOQUEADO. ID:', id, '| Obra:', texto);
    }


    function previewImagen(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            nombreArchivo = input.files[0].name;
            reader.onload = function (e) {
                archivoBase64 = e.target.result;
                const previewCont = document.getElementById('preview-container');
                const imgP = document.getElementById('img-preview');
                if (imgP) imgP.src = e.target.result;
                if (previewCont) previewCont.classList.remove('hidden');
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function configurarFormulario() {
        // Los botones de acci√≥n llaman directamente a enviarInspeccion(modo)
        // mediante onclick ‚Äî no se usa el evento submit del form.
    }

    /**
     * Env√≠a el formulario de inspecci√≥n.
     * @param {'pendiente'|'firma'} modo
     *   'pendiente' ‚Üí guarda con estado PENDIENTE y recarga la lista de pendientes.
     *   'firma'     ‚Üí guarda con estado PENDIENTE y abre el modal de firma
     *                 para capturar la firma inmediatamente.
     */
    function enviarInspeccion(modo) {
        const btnP = document.getElementById('btn-pendiente');
        const btnF = document.getElementById('btn-con-firma');
        const spP  = document.getElementById('spinner-pendiente');
        const spF  = document.getElementById('spinner-firma');

        const selectCliente = document.getElementById('idCliente');
        const selectFormato = document.getElementById('idFormato');
        const fmtData = _formatosDisponibles.find(
            function(f) { return f.id === (selectFormato ? selectFormato.value : ''); }
        );

        // Validar campos m√≠nimos
        if (!selectFormato || !selectFormato.value || !archivoBase64) {
            mostrarNotificacion('‚ö†Ô∏è Por favor seleccione un formato y capture la foto.', 'warning');
            return;
        }

        // Deshabilitar ambos botones y mostrar spinner del bot√≥n presionado
        if (btnP) btnP.disabled = true;
        if (btnF) btnF.disabled = true;
        if (modo === 'pendiente' && spP) spP.classList.remove('hidden');
        if (modo === 'firma'     && spF) spF.classList.remove('hidden');

        const formData = {
            userCode:            currentUser.codigo || '',
            nombreCliente:       selectCliente
                                    ? selectCliente.options[selectCliente.selectedIndex].text
                                    : _obraSeleccionada,
            idFormato:           selectFormato.value,
            descripcionRegistro: fmtData ? fmtData.descripcion : '',
            archivoBase64:       archivoBase64
        };

        function _resetBotones() {
            if (btnP) btnP.disabled = false;
            if (btnF) btnF.disabled = false;
            if (spP)  spP.classList.add('hidden');
            if (spF)  spF.classList.add('hidden');
        }

        function _resetFormulario() {
            archivoBase64 = null;
            const form = document.getElementById('sst-form');
            if (form) form.reset();
            const prev = document.getElementById('preview-container');
            if (prev) prev.classList.add('hidden');
            const descCont = document.getElementById('formato-descripcion-container');
            if (descCont) descCont.classList.add('hidden');
            _intentarBloqueoEmpresa();
        }

        google.script.run
            .withSuccessHandler(function(res) {
                _resetBotones();
                if (res.status === 'success') {
                    _resetFormulario();
                    if (modo === 'firma') {
                        mostrarNotificacion('‚úÖ Formato guardado. Capture la firma del jefe SST.', 'success');
                        abrirModalFirma(res.data.id);
                    } else {
                        mostrarNotificacion('‚úÖ ' + res.message, 'success');
                        cargarPendientes();
                    }
                } else {
                    mostrarNotificacion('‚ùå ' + res.message, 'error');
                }
            })
            .withFailureHandler(function(err) {
                _resetBotones();
                mostrarNotificacion('‚ùå Error: ' + err.toString(), 'error');
            })
            .guardarRegistroFormato(formData);
    }
    /**
     * Gesti√≥n de registros pendientes
     */
    function cargarPendientes() {
        if (!currentUser || !currentUser.email) return;
        const cont = document.getElementById('pendientes-container');
        const list = document.getElementById('lista-pendientes');
        if (!list) return;

        google.script.run
            .withSuccessHandler(function (res) {
                if (res.status === 'success' && res.data.length > 0) {
                    if (cont) cont.classList.remove('hidden');
                    renderizarPendientes(res.data);
                } else {
                    if (cont) cont.classList.add('hidden');
                }
            })
            .obtenerRegistrosPendientes(currentUser.email);
    }

    // Cache para filtrado
    let _registrosPendientes = [];

    function renderizarPendientes(registros) {
        _registrosPendientes = registros;
        const badge = document.getElementById('badge-pendientes');
        if (badge) badge.textContent = registros.length + ' pendiente' + (registros.length !== 1 ? 's' : '');
        _renderCards(registros);
    }

    function _renderCards(registros) {
        const list = document.getElementById('lista-pendientes');
        if (!list) return;
        list.innerHTML = '';

        if (registros.length === 0) {
            list.innerHTML = '<p class="text-center text-xs text-slate-600 italic py-4">Sin resultados</p>';
            return;
        }

        registros.forEach(function (reg) {
            const card = document.createElement('div');
            card.className = 'pendiente-card bg-white/5 border border-amber-500/20 rounded-xl p-3 animate-fade-in';
            card.dataset.id  = reg.id;
            card.dataset.fmt = (reg.formato + ' ' + reg.descripcion).toLowerCase();

            card.innerHTML = `
                <div class="flex items-start justify-between gap-2">
                    <div style="min-width:0; flex:1;">
                        <div class="flex items-center gap-1.5 mb-1">
                            <span class="inline-block w-2 h-2 rounded-full bg-amber-400 shrink-0"></span>
                            <p class="text-[10px] font-black text-amber-400 uppercase tracking-tight">${reg.id}</p>
                        </div>
                        <p class="text-xs font-bold text-white truncate leading-tight">${reg.formato}</p>
                        <p class="text-[10px] text-slate-400 truncate leading-tight">${reg.descripcion}</p>
                        <p class="text-[9px] text-slate-600 font-bold mt-1 flex items-center gap-1">
                            <span class="material-symbols-outlined text-[10px]">schedule</span>${reg.fecha}
                        </p>
                    </div>
                    <button onclick="abrirModalFirma('${reg.id}')"
                        class="shrink-0 flex items-center gap-1 bg-green-600/15 hover:bg-green-600/30 text-green-400 border border-green-500/30 px-3 py-2 rounded-lg text-[9px] font-black uppercase tracking-widest transition-all active:scale-95">
                        <span class="material-symbols-outlined text-sm">verified</span>Firmar
                    </button>
                </div>
            `;
            list.appendChild(card);
        });
    }

    /**
     * Filtra las tarjetas de pendientes en tiempo real (client-side).
     */
    function filtrarPendientes(query) {
        if (!query || query.trim() === '') {
            _renderCards(_registrosPendientes);
            return;
        }
        const q = query.trim().toLowerCase();
        const filtrados = _registrosPendientes.filter(function (r) {
            return r.id.toLowerCase().includes(q)
                || r.formato.toLowerCase().includes(q)
                || r.descripcion.toLowerCase().includes(q);
        });
        _renderCards(filtrados);
    }

    // ‚îÄ‚îÄ Estado interno del modal de firma ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let _firmaBase64 = null;
    let _firmaIdRegistro = '';

    /**
     * Abre el modal de captura de firma para un registro pendiente.
     */
    function abrirModalFirma(idRegistro) {
        _firmaBase64 = null;
        _firmaIdRegistro = idRegistro;

        // Reset visual del modal
        const preview = document.getElementById('firma-preview-container');
        const label   = document.getElementById('firma-foto-label');
        const input   = document.getElementById('firma-foto');
        const idLabel = document.getElementById('firma-modal-id');
        if (preview) preview.classList.add('hidden');
        if (label)   label.classList.remove('hidden');
        if (input)   input.value = '';
        if (idLabel) idLabel.textContent = 'Registro: ' + idRegistro;

        const modal = document.getElementById('firma-modal');
        if (modal) modal.classList.remove('hidden');
    }

    function cerrarModalFirma() {
        _firmaBase64 = null;
        _firmaIdRegistro = '';
        const modal = document.getElementById('firma-modal');
        if (modal) modal.classList.add('hidden');
    }

    /**
     * Muestra la preview de la foto de firma.
     */
    function previewFirma(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                _firmaBase64 = e.target.result;
                const prev  = document.getElementById('firma-img-preview');
                const cont  = document.getElementById('firma-preview-container');
                const label = document.getElementById('firma-foto-label');
                if (prev)  prev.src = e.target.result;
                if (cont)  cont.classList.remove('hidden');
                if (label) label.classList.add('hidden');
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    /**
     * Env√≠a el cierre con firma al backend.
     */
    function submitFirma() {
        if (!_firmaBase64) {
            mostrarNotificacion('‚ö†Ô∏è Capture la foto del formato firmado antes de confirmar.', 'error');
            return;
        }

        const btn     = document.getElementById('btn-submit-firma');
        const spinner = document.getElementById('firma-spinner');
        if (btn)     btn.disabled = true;
        if (spinner) spinner.classList.remove('hidden');

        google.script.run
            .withSuccessHandler(function (res) {
                if (btn)     btn.disabled = false;
                if (spinner) spinner.classList.add('hidden');
                cerrarModalFirma();
                if (res.status === 'success') {
                    mostrarNotificacion('‚úÖ ' + res.message, 'success');
                    cargarPendientes();
                } else {
                    mostrarNotificacion('‚ùå ' + res.message, 'error');
                }
            })
            .withFailureHandler(function (err) {
                if (btn)     btn.disabled = false;
                if (spinner) spinner.classList.add('hidden');
                mostrarNotificacion('‚ùå Error: ' + err.toString(), 'error');
            })
            .cerrarRegistroFormato(_firmaIdRegistro, _firmaBase64);
    }

    /** @deprecated ‚Äî reemplazado por abrirModalFirma */
    function confirmarCierrePendiente(id) {
        abrirModalFirma(id);
    }

    // ================================================================
    // M√ìDULO: ADMINISTRACI√ìN DE CLIENTES/EMPRESAS
    // ================================================================

    let _clientesAdmin   = [];   // Cache completo de clientes
    let _filtroAdmin     = 'todas'; // Filtro activo actual
    let _clienteEditando = null; // Cliente en edici√≥n (null = nuevo)

    /**
     * Muestra el workspace del m√≥dulo admin seleccionado y oculta el portal.
     */
    function abrirModuloAdmin(modulo) {
        const portal = document.getElementById('admin-portal');
        if (portal) portal.classList.add('hidden');

        if (modulo === 'clientes') {
            const workspace = document.getElementById('admin-workspace-clientes');
            if (workspace) workspace.classList.remove('hidden');
            actualizarModuloHeader('Gesti√≥n de Empresas');
            cargarClientesAdmin();
        } else if (modulo === 'asistencia') {
            const workspace = document.getElementById('admin-workspace-asistencia');
            if (workspace) workspace.classList.remove('hidden');
            actualizarModuloHeader('Control de Asistencia');
            cargarAsistenciaAdmin();
        } else if (modulo === 'usuarios') {
            const workspace = document.getElementById('admin-workspace-usuarios');
            if (workspace) workspace.classList.remove('hidden');
            actualizarModuloHeader('Gesti√≥n de Usuarios');
            cargarUsuariosAdmin();
        } else if (modulo === 'formatos') {
            const workspace = document.getElementById('admin-workspace-formatos');
            if (workspace) workspace.classList.remove('hidden');
            actualizarModuloHeader('Gestor de Formatos');
            cargarFormatosAdmin();
        } else if (modulo === 'supervisor-stt') {
            const workspace = document.getElementById('admin-workspace-supervisor-stt');
            if (workspace) workspace.classList.remove('hidden');
            actualizarModuloHeader('Gesti√≥n Supervisor SST');
            cargarSupervisorSTT();
        } else if (modulo === 'hallazgos') {
            const workspace = document.getElementById('admin-workspace-hallazgos');
            if (workspace) workspace.classList.remove('hidden');
            actualizarModuloHeader('Gesti√≥n Hallazgos');
            cargarGaleriaHallazgos();
        }
    }

    /**
     * Regresa al portal principal de m√≥dulos del administrador.
     */
    function volverAlPortalAdmin() {
        const portal = document.getElementById('admin-portal');
        if (portal) portal.classList.remove('hidden');

        // Ocultar todos los workspaces
        ['admin-workspace-clientes', 'admin-workspace-asistencia', 'admin-workspace-usuarios', 'admin-workspace-formatos', 'admin-workspace-supervisor-stt', 'admin-workspace-hallazgos'].forEach(function(id) {
            var ws = document.getElementById(id);
            if (ws) ws.classList.add('hidden');
        });

        actualizarModuloHeader('Administraci√≥n');
        _filtroAdmin = 'todas';
    }

    /**
     * Carga todos los clientes desde el servidor y actualiza ambas vistas (tabla y tarjetas).
     */
    function cargarClientesAdmin() {
        // Estado de carga ‚Äî tabla (escritorio)
        var tbody = document.getElementById('tabla-clientes-body');
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="10" class="text-center py-10 text-slate-500 text-xs italic">' +
                '<div class="flex flex-col items-center gap-2">' +
                '<div class="animate-spin h-6 w-6 border-2 border-primary/30 border-t-primary rounded-full"></div>' +
                '<span>Cargando empresas...</span></div></td></tr>';
        }
        // Estado de carga ‚Äî tarjetas (m√≥vil)
        var listaMov = document.getElementById('lista-clientes-mobile');
        if (listaMov) {
            listaMov.innerHTML = '<div class="flex flex-col items-center gap-2 py-8 text-slate-500 text-xs italic">' +
                '<div class="animate-spin h-6 w-6 border-2 border-primary/30 border-t-primary rounded-full"></div>' +
                '<span>Cargando...</span></div>';
        }

        google.script.run
            .withSuccessHandler(function (res) {
                if (res.status === 'success') {
                    _clientesAdmin = res.data || [];
                    actualizarStatsClientes();
                    filtrarClientes(_filtroAdmin);
                } else {
                    mostrarNotificacion('‚ùå ' + res.message, 'error');
                    if (tbody) tbody.innerHTML = '<tr><td colspan="10" class="text-center py-8 text-red-400 text-xs">Error al cargar datos</td></tr>';
                    if (listaMov) listaMov.innerHTML = '<div class="text-center py-6 text-red-400 text-xs">Error al cargar datos</div>';
                }
            })
            .withFailureHandler(function (err) {
                mostrarNotificacion('‚ùå Error de conexi√≥n: ' + err.toString(), 'error');
            })
            .obtenerListaClientesAdmin();
    }

    /**
     * Actualiza los contadores en las tarjetas de estad√≠sticas.
     */
    function actualizarStatsClientes() {
        const total     = _clientesAdmin.length;
        const activas   = _clientesAdmin.filter(function(c) { return c.estado === 'ACTIVO'; }).length;
        const inactivas = _clientesAdmin.filter(function(c) { return c.estado === 'INACTIVO'; }).length;

        var elTotal     = document.getElementById('stat-total');
        var elActivas   = document.getElementById('stat-activas');
        var elInactivas = document.getElementById('stat-inactivas');

        if (elTotal)     elTotal.querySelector('.stat-num').textContent     = total;
        if (elActivas)   elActivas.querySelector('.stat-num').textContent   = activas;
        if (elInactivas) elInactivas.querySelector('.stat-num').textContent = inactivas;
    }

    /**
     * Filtra la lista de clientes seg√∫n el tipo y actualiza los pills.
     * @param {string} tipo 'todas' | 'activas' | 'inactivas'
     */
    function filtrarClientes(tipo) {
        _filtroAdmin = tipo;

        // Actualizar estilos de los pills
        document.querySelectorAll('[data-filtro]').forEach(function (btn) {
            const isActive = btn.dataset.filtro === tipo;
            btn.style.backgroundColor = isActive ? 'rgba(197,160,72,0.18)' : 'rgba(255,255,255,0.05)';
            btn.style.borderColor     = isActive ? 'rgba(197,160,72,0.40)' : 'rgba(255,255,255,0.10)';
            btn.style.color           = isActive ? 'var(--color-primario)'  : 'rgb(148,163,184)';
        });

        // Filtrar y renderizar
        var filtrados = _clientesAdmin;
        if (tipo === 'activas')   filtrados = _clientesAdmin.filter(function(c) { return c.estado === 'ACTIVO'; });
        if (tipo === 'inactivas') filtrados = _clientesAdmin.filter(function(c) { return c.estado === 'INACTIVO'; });

        renderizarTablaClientes(filtrados);
    }

    /**
     * Genera filas de la tabla (escritorio) y tarjetas (m√≥vil) con la lista de clientes.
     * @param {Array} clientes Lista filtrada de clientes.
     */
    function renderizarTablaClientes(clientes) {
        // Renderizar vista m√≥vil primero (siempre)
        _renderCardsMovil(clientes);

        const tbody = document.getElementById('tabla-clientes-body');
        if (!tbody) return;

        if (!clientes || clientes.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" class="text-center py-10 text-slate-500 text-xs italic">' +
                '<div class="flex flex-col items-center gap-2">' +
                '<span class="material-symbols-outlined text-3xl">search_off</span>' +
                '<span>Sin registros para mostrar</span></div></td></tr>';
            return;
        }

        tbody.innerHTML = clientes.map(function (c) {
            const esActivo    = c.estado === 'ACTIVO';
            const badgeClases = esActivo
                ? 'bg-green-500/15 text-green-400 border border-green-500/30'
                : 'bg-red-500/15 text-red-400 border border-red-500/30';
            const toggleIcon  = esActivo ? 'toggle_on' : 'toggle_off';
            const toggleTip   = esActivo ? 'Desactivar' : 'Activar';
            const toggleClase = esActivo
                ? 'bg-amber-500/10 hover:bg-amber-500/20 text-amber-400 border border-amber-500/20'
                : 'bg-green-500/10 hover:bg-green-500/20 text-green-400 border border-green-500/20';

            return '<tr class="border-b border-white/5 hover:bg-white/5 transition-colors' + (esActivo ? '' : ' opacity-55') + '">' +
                '<td class="px-3 py-3 text-[11px] font-black whitespace-nowrap" style="color:var(--color-primario)">' + _esc(c.id) + '</td>' +
                '<td class="px-3 py-3 text-xs font-bold text-white whitespace-nowrap">' + _esc(c.nombre) + '</td>' +
                '<td class="px-3 py-3 text-[11px] text-slate-400 whitespace-nowrap">' + (c.nit || '<span class="text-slate-600">-</span>') + '</td>' +
                '<td class="px-3 py-3 text-[11px] text-slate-400 whitespace-nowrap">' + (c.correo || '<span class="text-slate-600">-</span>') + '</td>' +
                '<td class="px-3 py-3 text-[11px] text-slate-400 whitespace-nowrap">' + (c.direccion || '<span class="text-slate-600">-</span>') + '</td>' +
                '<td class="px-3 py-3 text-[11px] text-slate-400 whitespace-nowrap">' + (c.contacto || '<span class="text-slate-600">-</span>') + '</td>' +
                '<td class="px-3 py-3 text-[11px] text-slate-400 whitespace-nowrap">' + (c.celular || '<span class="text-slate-600">-</span>') + '</td>' +
                '<td class="px-3 py-3 text-[11px] text-slate-400 whitespace-nowrap">' + (c.obra || '<span class="text-slate-600">-</span>') + '</td>' +
                '<td class="px-3 py-3 whitespace-nowrap">' +
                    '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[9px] font-black uppercase tracking-widest ' + badgeClases + '">' + c.estado + '</span>' +
                '</td>' +
                '<td class="px-3 py-3 whitespace-nowrap">' +
                    '<div class="flex items-center gap-1">' +
                        (c.carpeta
                          ? '<a href="' + c.carpeta + '" target="_blank" rel="noopener" ' +
                              'class="p-1.5 rounded-lg bg-blue-500/10 hover:bg-blue-500/20 text-blue-400 border border-blue-500/20 transition-all" title="Carpeta Drive">' +
                              '<span class="material-symbols-outlined text-sm">folder_open</span>' +
                            '</a>'
                          : '') +
                        '<button onclick="abrirModalClientePorId(\'' + _esc(c.id) + '\')" ' +
                            'class="p-1.5 rounded-lg bg-primary/10 hover:bg-primary/20 text-primary border border-primary/20 transition-all" title="Editar">' +
                            '<span class="material-symbols-outlined text-sm">edit</span>' +
                        '</button>' +
                        '<button onclick="toggleEstadoCliente(\'' + _esc(c.id) + '\',\'' + c.estado + '\')" ' +
                            'class="p-1.5 rounded-lg ' + toggleClase + ' transition-all" title="' + toggleTip + '">' +
                            '<span class="material-symbols-outlined text-sm">' + toggleIcon + '</span>' +
                        '</button>' +
                        '<button onclick="confirmarEliminarCliente(\'' + _esc(c.id) + '\',\'' + _escAttr(c.nombre) + '\')" ' +
                            'class="p-1.5 rounded-lg bg-red-500/10 hover:bg-red-500/20 text-red-400 border border-red-500/20 transition-all" title="Eliminar">' +
                            '<span class="material-symbols-outlined text-sm">delete</span>' +
                        '</button>' +
                    '</div>' +
                '</td>' +
            '</tr>';
        }).join('');
    }

    /** Escapa texto para insertar en contenido HTML */
    function _esc(str) {
        return (str || '').toString()
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
    }

    /** Escapa texto para insertar en atributo onclick (comillas simples ya usadas) */
    function _escAttr(str) {
        return (str || '').toString()
            .replace(/\\/g, '\\\\')
            .replace(/'/g, "\\'");
    }

    /**
     * Renderiza la vista de tarjetas para pantallas m√≥viles (sm:hidden).
     * Muestra los campos clave + acciones en formato compacto y legible.
     * @param {Array} clientes Lista filtrada de clientes.
     */
    function _renderCardsMovil(clientes) {
        var lista = document.getElementById('lista-clientes-mobile');
        if (!lista) return;

        if (!clientes || clientes.length === 0) {
            lista.innerHTML = '<div class="flex flex-col items-center gap-2 py-8 text-slate-500 text-xs italic">' +
                '<span class="material-symbols-outlined text-3xl">search_off</span>' +
                '<span>Sin registros para mostrar</span></div>';
            return;
        }

        lista.innerHTML = clientes.map(function (c) {
            var esActivo    = c.estado === 'ACTIVO';
            var badgeClases = esActivo
                ? 'bg-green-500/15 text-green-400 border border-green-500/30'
                : 'bg-red-500/15 text-red-400 border border-red-500/30';
            var toggleIcon  = esActivo ? 'toggle_on' : 'toggle_off';
            var toggleLabel = esActivo ? 'Desactivar' : 'Activar';
            var toggleClase = esActivo
                ? 'bg-amber-500/10 text-amber-400 border border-amber-500/20'
                : 'bg-green-500/10 text-green-400 border border-green-500/20';

            // Campos secundarios visibles en tarjeta
            var extras = '';
            if (c.nit)     extras += '<div><span class="text-slate-600">NIT</span><br><span class="text-slate-300 font-medium">' + _esc(c.nit) + '</span></div>';
            if (c.celular) extras += '<div><span class="text-slate-600">Celular</span><br><span class="text-slate-300 font-medium">' + _esc(c.celular) + '</span></div>';
            if (c.correo)  extras += '<div class="col-span-2"><span class="text-slate-600">Correo</span><br><span class="text-slate-300 font-medium break-all">' + _esc(c.correo) + '</span></div>';

            return '<div class="bg-white/5 border border-white/10 rounded-xl p-3.5 animate-fade-in' + (esActivo ? '' : ' opacity-60') + '">' +
                // Cabecera tarjeta: ID + Nombre + Badge estado
                '<div class="flex items-start justify-between gap-2 mb-2.5">' +
                    '<div class="min-w-0 flex-1">' +
                        '<p class="text-[9px] font-black uppercase tracking-widest mb-0.5" style="color:var(--color-primario)">' + _esc(c.id) + '</p>' +
                        '<p class="text-sm font-black text-white leading-tight">' + _esc(c.nombre) + '</p>' +
                        (c.obra ? '<p class="text-[10px] text-slate-500 font-medium mt-0.5 leading-tight">' + _esc(c.obra) + '</p>' : '') +
                    '</div>' +
                    '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[9px] font-black uppercase tracking-widest shrink-0 ' + badgeClases + '">' + c.estado + '</span>' +
                '</div>' +
                // Campos secundarios
                (extras ? '<div class="grid grid-cols-2 gap-x-4 gap-y-1.5 text-[10px] mb-3 pb-3 border-b border-white/5">' + extras + '</div>' : '') +
                // Acciones
                '<div class="flex gap-2">' +
                    (c.carpeta
                      ? '<a href="' + c.carpeta + '" target="_blank" rel="noopener" ' +
                          'class="w-10 flex items-center justify-center rounded-xl bg-blue-500/10 text-blue-400 border border-blue-500/20 transition-all active:scale-95" title="Carpeta Drive">' +
                          '<span class="material-symbols-outlined text-sm">folder_open</span>' +
                        '</a>'
                      : '') +
                    '<button onclick="abrirModalClientePorId(\'' + _esc(c.id) + '\')" ' +
                        'class="flex-1 flex items-center justify-center gap-1.5 py-2.5 rounded-xl bg-primary/10 text-primary border border-primary/20 text-[10px] font-black uppercase tracking-widest transition-all active:scale-95">' +
                        '<span class="material-symbols-outlined text-sm">edit</span>Editar' +
                    '</button>' +
                    '<button onclick="toggleEstadoCliente(\'' + _esc(c.id) + '\',\'' + c.estado + '\')" ' +
                        'class="flex-1 flex items-center justify-center gap-1.5 py-2.5 rounded-xl ' + toggleClase + ' border text-[10px] font-black uppercase tracking-widest transition-all active:scale-95">' +
                        '<span class="material-symbols-outlined text-sm">' + toggleIcon + '</span>' + toggleLabel +
                    '</button>' +
                    '<button onclick="confirmarEliminarCliente(\'' + _esc(c.id) + '\',\'' + _escAttr(c.nombre) + '\')" ' +
                        'class="w-10 flex items-center justify-center rounded-xl bg-red-500/10 text-red-400 border border-red-500/20 transition-all active:scale-95" title="Eliminar">' +
                        '<span class="material-symbols-outlined text-sm">delete</span>' +
                    '</button>' +
                '</div>' +
            '</div>';
        }).join('');
    }

    /**
     * Abre el modal de creaci√≥n/edici√≥n buscando el cliente por ID en el cach√©.
     */
    function abrirModalClientePorId(id) {
        var cliente = _clientesAdmin.find(function(c) { return c.id === id; }) || null;
        abrirModalCliente(cliente);
    }

    /**
     * Abre el modal de cliente.
     * @param {Object|null} cliente null = modo creaci√≥n, objeto = modo edici√≥n
     */
    function abrirModalCliente(cliente) {
        _clienteEditando = cliente;
        var modal  = document.getElementById('modal-cliente');
        var titulo = document.getElementById('modal-cliente-titulo');
        var estadoWrapper = document.getElementById('mc-estado-wrapper');
        if (!modal) return;

        // Poblar campos
        document.getElementById('mc-id').value        = cliente ? cliente.id        : '';
        document.getElementById('mc-nombre').value    = cliente ? cliente.nombre    : '';
        document.getElementById('mc-direccion').value = cliente ? cliente.direccion : '';
        document.getElementById('mc-nit').value       = cliente ? cliente.nit       : '';
        document.getElementById('mc-correo').value    = cliente ? cliente.correo    : '';
        document.getElementById('mc-contacto').value  = cliente ? cliente.contacto  : '';
        document.getElementById('mc-celular').value   = cliente ? cliente.celular   : '';
        document.getElementById('mc-obra').value      = cliente ? cliente.obra      : '';
        var selectEstado = document.getElementById('mc-estado');
        if (selectEstado) selectEstado.value = cliente ? cliente.estado : 'ACTIVO';

        if (titulo) titulo.textContent = cliente ? 'Editar Empresa' : 'Nueva Empresa';

        // El campo Estado solo es editable al editar (no al crear)
        if (estadoWrapper) estadoWrapper.classList.toggle('hidden', !cliente);

        modal.classList.remove('hidden');
    }

    /**
     * Cierra el modal de cliente y limpia el estado.
     */
    function cerrarModalCliente() {
        var modal = document.getElementById('modal-cliente');
        if (modal) modal.classList.add('hidden');
        _clienteEditando = null;
    }

    /**
     * Env√≠a el formulario de creaci√≥n/edici√≥n al servidor.
     */
    function guardarClienteAdmin() {
        var nombre = (document.getElementById('mc-nombre').value || '').trim();
        if (!nombre) {
            mostrarNotificacion('‚ö†Ô∏è El nombre de la empresa es obligatorio.', 'error');
            return;
        }

        var data = {
            id:        (document.getElementById('mc-id').value || '').trim(),
            nombre:    nombre,
            direccion: (document.getElementById('mc-direccion').value || '').trim(),
            nit:       (document.getElementById('mc-nit').value || '').trim(),
            correo:    (document.getElementById('mc-correo').value || '').trim(),
            contacto:  (document.getElementById('mc-contacto').value || '').trim(),
            celular:   (document.getElementById('mc-celular').value || '').trim(),
            obra:      (document.getElementById('mc-obra').value || '').trim(),
            estado:    (document.getElementById('mc-estado') ? document.getElementById('mc-estado').value : 'ACTIVO')
        };

        var btn     = document.getElementById('btn-guardar-cliente');
        var spinner = document.getElementById('spinner-guardar-cliente');
        if (btn)     btn.disabled = true;
        if (spinner) spinner.classList.remove('hidden');

        google.script.run
            .withSuccessHandler(function (res) {
                if (btn)     btn.disabled = false;
                if (spinner) spinner.classList.add('hidden');
                if (res.status === 'success') {
                    cerrarModalCliente();
                    mostrarNotificacion('‚úÖ ' + res.message, 'success');
                    cargarClientesAdmin();
                } else {
                    mostrarNotificacion('‚ùå ' + res.message, 'error');
                }
            })
            .withFailureHandler(function (err) {
                if (btn)     btn.disabled = false;
                if (spinner) spinner.classList.add('hidden');
                mostrarNotificacion('‚ùå Error: ' + err.toString(), 'error');
            })
            .guardarCliente(data);
    }

    /**
     * Solicita confirmaci√≥n antes de eliminar un cliente.
     */
    function confirmarEliminarCliente(id, nombre) {
        if (!confirm('¬øEst√° seguro de eliminar la empresa "' + nombre + '"?\nEsta acci√≥n no se puede deshacer.')) return;
        google.script.run
            .withSuccessHandler(function (res) {
                if (res.status === 'success') {
                    mostrarNotificacion('‚úÖ ' + res.message, 'success');
                    cargarClientesAdmin();
                } else {
                    mostrarNotificacion('‚ùå ' + res.message, 'error');
                }
            })
            .withFailureHandler(function (err) {
                mostrarNotificacion('‚ùå Error: ' + err.toString(), 'error');
            })
            .eliminarCliente(id);
    }

    /**
     * Alterna el estado ACTIVO/INACTIVO de una empresa.
     * Si se desactiva, ya no aparecer√° en el selector de supervisores.
     */
    function toggleEstadoCliente(id, estadoActual) {
        var nuevoEstado = estadoActual === 'ACTIVO' ? 'INACTIVO' : 'ACTIVO';
        var msg = nuevoEstado === 'INACTIVO'
            ? '¬øDesactivar esta empresa?\nLos supervisores ya no podr√°n iniciar jornadas para ella.'
            : '¬øReactivar esta empresa?';
        if (!confirm(msg)) return;

        google.script.run
            .withSuccessHandler(function (res) {
                if (res.status === 'success') {
                    mostrarNotificacion('‚úÖ ' + res.message, 'success');
                    cargarClientesAdmin();
                } else {
                    mostrarNotificacion('‚ùå ' + res.message, 'error');
                }
            })
            .withFailureHandler(function (err) {
                mostrarNotificacion('‚ùå Error: ' + err.toString(), 'error');
            })
            .cambiarEstadoCliente(id, nuevoEstado);
    }

    // ================================================================
    // M√ìDULO: CONTROL DE ASISTENCIA (PERSONAL / SUPERVISORES)
    // ================================================================

    let _asistenciaTotal    = [];    // Cache completo de registros
    let _filtroEstadoAsist  = 'todos'; // Filtro de estado activo

    /**
     * Carga todos los registros desde el servidor.
     */
    function cargarAsistenciaAdmin() {
        var tbody  = document.getElementById('asis-tabla-body');
        var movil  = document.getElementById('asis-lista-mobile');
        var loader = '<div class="flex flex-col items-center gap-2 py-8 text-slate-500 text-xs italic">' +
                     '<div class="animate-spin h-6 w-6 border-2 border-primary/30 border-t-primary rounded-full"></div>' +
                     '<span>Cargando asistencia...</span></div>';

        if (tbody)  tbody.innerHTML  = '<tr><td colspan="10" class="py-10 text-center">' + loader + '</td></tr>';
        if (movil)  movil.innerHTML  = loader;

        // Reiniciar selects de filtro
        var selEst = document.getElementById('asis-filtro-estado');
        if (selEst) selEst.value = '';

        google.script.run
            .withSuccessHandler(function(res) {
                if (res.status === 'success') {
                    _asistenciaTotal = res.data || [];
                    _poblarSelectsAsistencia(_asistenciaTotal);
                    filtrarAsistencia();
                } else {
                    mostrarNotificacion('‚ùå ' + res.message, 'error');
                    if (tbody) tbody.innerHTML = '<tr><td colspan="10" class="text-center py-8 text-red-400 text-xs">Error al cargar datos</td></tr>';
                }
            })
            .withFailureHandler(function(err) {
                mostrarNotificacion('‚ùå Error de conexi√≥n: ' + err.toString(), 'error');
            })
            .obtenerAsistenciaAdmin();
    }

    /**
     * Puebla los <select> de supervisores y obras con los valores √∫nicos del dataset.
     * Preserva la selecci√≥n actual si el valor sigue existiendo.
     */
    function _poblarSelectsAsistencia(registros) {
        var selNombre = document.getElementById('asis-filtro-nombre');
        var selObra   = document.getElementById('asis-filtro-obra');
        if (!selNombre || !selObra) return;

        var valNombre = selNombre.value;
        var valObra   = selObra.value;

        // Supervisores √∫nicos ordenados por nombre
        var supervisores = {};
        registros.forEach(function(r) {
            if (r.email) supervisores[r.email] = r.nombre || r.email;
        });
        selNombre.innerHTML = '<option value="" style="background:#1a242f;">Todos los supervisores...</option>';
        Object.keys(supervisores).sort(function(a, b) {
            return supervisores[a].localeCompare(supervisores[b]);
        }).forEach(function(email) {
            var opt = document.createElement('option');
            opt.value = email;
            opt.textContent = supervisores[email];
            opt.style.background = '#1a242f';
            selNombre.appendChild(opt);
        });

        // Obras √∫nicas ordenadas alfab√©ticamente
        var obras = {};
        registros.forEach(function(r) { if (r.obra) obras[r.obra] = true; });
        selObra.innerHTML = '<option value="" style="background:#1a242f;">Todas las obras...</option>';
        Object.keys(obras).sort(function(a, b) { return a.localeCompare(b); }).forEach(function(obra) {
            var opt = document.createElement('option');
            opt.value = obra;
            opt.textContent = obra;
            opt.style.background = '#1a242f';
            selObra.appendChild(opt);
        });

        // Restaurar selecci√≥n previa si a√∫n existe
        if (valNombre) selNombre.value = valNombre;
        if (valObra)   selObra.value   = valObra;
    }

    /**
     * Aplica los filtros de supervisor + obra + estado y actualiza la vista.
     */
    function filtrarAsistencia() {
        var emailSel  = ((document.getElementById('asis-filtro-nombre')  || {}).value || '').trim();
        var obraSel   = ((document.getElementById('asis-filtro-obra')    || {}).value || '').trim();
        var estadoSel = ((document.getElementById('asis-filtro-estado')  || {}).value || '').trim();

        var filtrados = _asistenciaTotal.filter(function(r) {
            var coincideNombre = !emailSel  || r.email === emailSel;
            var coincideObra   = !obraSel   || (r.obra || '') === obraSel;
            var coincideEstado = !estadoSel || r.estado === estadoSel;
            return coincideNombre && coincideObra && coincideEstado;
        });

        actualizarStatsAsistencia(filtrados);
        _renderTablaAsistencia(filtrados);
        _renderCardsAsistenciaMovil(filtrados);
    }


    /**
     * Actualiza las tarjetas de estad√≠sticas seg√∫n los registros visibles.
     */
    function actualizarStatsAsistencia(registros) {
        var emailsUnicos = {};
        registros.forEach(function(r) { if (r.email) emailsUnicos[r.email] = true; });
        var supervisores = Object.keys(emailsUnicos).length;
        var activas      = registros.filter(function(r) { return r.estado === 'ACTIVO'; }).length;
        var cerradas     = registros.filter(function(r) { return r.estado === 'CERRADO'; }).length;

        var elSup  = document.getElementById('asis-stat-supervisores');
        var elTot  = document.getElementById('asis-stat-total');
        var elAct  = document.getElementById('asis-stat-activas');
        var elCer  = document.getElementById('asis-stat-cerradas');

        if (elSup) elSup.querySelector('.stat-num').textContent = supervisores;
        if (elTot) elTot.querySelector('.stat-num').textContent = registros.length;
        if (elAct) elAct.querySelector('.stat-num').textContent = activas;
        if (elCer) elCer.querySelector('.stat-num').textContent = cerradas;
    }

    /**
     * Renderiza la tabla de escritorio.
     */
    function _renderTablaAsistencia(registros) {
        var tbody = document.getElementById('asis-tabla-body');
        if (!tbody) return;

        if (!registros || registros.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-10 text-slate-500 text-xs italic">' +
                '<div class="flex flex-col items-center gap-2">' +
                '<span class="material-symbols-outlined text-3xl">search_off</span>' +
                '<span>Sin registros para mostrar</span></div></td></tr>';
            return;
        }

        tbody.innerHTML = registros.map(function(r) {
            var esActiva = r.estado === 'ACTIVO';
            var badge = esActiva
                ? '<span class="inline-flex items-center gap-1 text-[9px] font-black uppercase bg-amber-500/15 text-amber-400 border border-amber-500/30 px-2 py-0.5 rounded-lg">' +
                  '<span class="w-1.5 h-1.5 rounded-full bg-amber-400 animate-pulse"></span>ACTIVA</span>'
                : '<span class="inline-flex items-center gap-1 text-[9px] font-black uppercase bg-green-500/15 text-green-400 border border-green-500/30 px-2 py-0.5 rounded-lg">' +
                  '<span class="w-1.5 h-1.5 rounded-full bg-green-400"></span>CERRADA</span>';

            var tipoBadge = r.tipoDia === 'HABIL'
                ? '<span class="text-slate-400 text-[10px]">' + _esc(r.tipoDia) + '</span>'
                : '<span class="text-amber-400 font-bold text-[10px]">' + _esc(r.tipoDia) + '</span>';

            return '<tr class="border-b border-white/5 hover:bg-white/5 transition-colors' + (esActiva ? ' bg-amber-500/3' : '') + '">' +
                '<td class="px-3 py-2.5 text-xs font-bold text-white whitespace-nowrap">' + _esc(r.nombre) + '</td>' +
                '<td class="px-3 py-2.5 text-[11px] text-slate-300 whitespace-nowrap">' + _esc(r.fecha) + '</td>' +
                '<td class="px-3 py-2.5 text-[11px] text-green-400 font-bold whitespace-nowrap">' + (_esc(r.horaEntrada) || '-') + '</td>' +
                '<td class="px-3 py-2.5 text-[11px] whitespace-nowrap">' + (r.horaSalida ? _esc(r.horaSalida) : '<span class="text-amber-400 font-bold">En curso</span>') + '</td>' +
                '<td class="px-3 py-2.5 whitespace-nowrap">' + tipoBadge + '</td>' +
                '<td class="px-3 py-2.5 text-[11px] text-slate-300 whitespace-nowrap max-w-[160px] truncate" title="' + _escAttr(r.obra) + '">' + _esc(r.obra || '-') + '</td>' +
                '<td class="px-3 py-2.5 whitespace-nowrap">' + badge + '</td>' +
                '</tr>';
        }).join('');
    }

    /**
     * Renderiza tarjetas para la vista m√≥vil.
     */
    function _renderCardsAsistenciaMovil(registros) {
        var lista = document.getElementById('asis-lista-mobile');
        if (!lista) return;

        if (!registros || registros.length === 0) {
            lista.innerHTML = '<div class="text-center py-8 text-slate-500 text-xs italic">Sin registros para mostrar</div>';
            return;
        }

        lista.innerHTML = registros.map(function(r) {
            var esActiva = r.estado === 'ACTIVO';
            var borderClass = esActiva ? 'border-amber-500/30' : 'border-green-500/20';
            var estadoBadge = esActiva
                ? '<span class="text-[9px] font-black text-amber-400 bg-amber-500/15 border border-amber-500/30 px-2 py-0.5 rounded-lg flex items-center gap-1">' +
                  '<span class="w-1.5 h-1.5 rounded-full bg-amber-400 animate-pulse"></span>ACTIVA</span>'
                : '<span class="text-[9px] font-black text-green-400 bg-green-500/15 border border-green-500/30 px-2 py-0.5 rounded-lg flex items-center gap-1">' +
                  '<span class="w-1.5 h-1.5 rounded-full bg-green-400"></span>CERRADA</span>';

            return '<div class="bg-white/5 border ' + borderClass + ' rounded-xl p-3 animate-fade-in">' +
                '<div class="flex items-start justify-between gap-2 mb-2">' +
                '<p class="text-xs font-bold text-white">' + _esc(r.nombre) + '</p>' +
                estadoBadge + '</div>' +
                '<div class="grid grid-cols-2 gap-x-3 gap-y-1 text-[10px]">' +
                '<span class="text-slate-500">Fecha:</span><span class="text-slate-300">' + _esc(r.fecha) + '</span>' +
                '<span class="text-slate-500">Tipo d√≠a:</span><span class="' + (r.tipoDia === 'HABIL' ? 'text-slate-300' : 'text-amber-400 font-bold') + '">' + _esc(r.tipoDia || '-') + '</span>' +
                '<span class="text-slate-500">Entrada:</span><span class="text-green-400 font-bold">' + (_esc(r.horaEntrada) || '-') + '</span>' +
                '<span class="text-slate-500">Salida:</span><span class="' + (r.horaSalida ? 'text-slate-300' : 'text-amber-400 font-bold') + '">' + (r.horaSalida ? _esc(r.horaSalida) : 'En curso') + '</span>' +
                '<span class="text-slate-500">Cliente:</span><span class="text-slate-300 truncate">' + _esc(r.obra || '-') + '</span>' +
                '</div></div>';
        }).join('');
    }

    /**
     * Genera y descarga un archivo CSV con los datos de asistencia visibles.
     */
    function exportarCSVAsistencia() {
        if (!_asistenciaTotal || _asistenciaTotal.length === 0) {
            mostrarNotificacion('‚ö†Ô∏è No hay datos de asistencia para exportar.', 'warning');
            return;
        }

        var encabezado = ['Nombre_Supervisor', 'Email', 'Fecha', 'Hora_Entrada', 'Hora_Salida',
                          'Tipo_Dia', 'Cliente_Empresa', 'Estado'];

        // Usar los datos actualmente filtrados (iguales a lo visible en pantalla)
        var emailSel  = ((document.getElementById('asis-filtro-nombre')  || {}).value || '').trim();
        var obraSel   = ((document.getElementById('asis-filtro-obra')    || {}).value || '').trim();
        var estadoSel = ((document.getElementById('asis-filtro-estado')  || {}).value || '').trim();
        var datos = _asistenciaTotal.filter(function(r) {
            var n = !emailSel  || r.email === emailSel;
            var o = !obraSel   || (r.obra || '') === obraSel;
            var e = !estadoSel || r.estado === estadoSel;
            return n && o && e;
        });

        var csv = encabezado.join(',') + '\n';
        csv += datos.map(function(r) {
            return [r.nombre, r.email, r.fecha, r.horaEntrada, r.horaSalida,
                    r.tipoDia, r.obra, r.estado]
                .map(function(v) {
                    var s = (v || '').toString().replace(/"/g, '""');
                    return '"' + s + '"';
                }).join(',');
        }).join('\n');

        var blob     = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
        var url      = URL.createObjectURL(blob);
        var link     = document.createElement('a');
        var fecha    = new Date().toISOString().slice(0, 10);
        link.href    = url;
        link.download = 'Asistencia_SST_' + fecha + '.csv';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        mostrarNotificacion('‚úÖ CSV exportado con ' + datos.length + ' registros.', 'success');
    }

    // ================================================================
    // M√ìDULO: GESTI√ìN DE USUARIOS
    // ================================================================

    let _usuariosTotal   = [];   // Cache completo
    let _usrEditandoId    = null; // ID del usuario en edici√≥n (null = nuevo)
    let _usrResetId       = null; // ID del usuario en reset de contrase√±a
    let _clientesParaModal = [];  // Cache de clientes DB_CLIENTES para el selector CLI

    function cargarUsuariosAdmin() {
        var loader = '<div class="flex flex-col items-center gap-2 py-8 text-slate-500 text-xs italic">' +
                     '<div class="animate-spin h-6 w-6 border-2 border-primary/30 border-t-primary rounded-full"></div>' +
                     '<span>Cargando usuarios...</span></div>';
        var tbody = document.getElementById('usr-tabla-body');
        var movil = document.getElementById('usr-lista-mobile');
        if (tbody) tbody.innerHTML = '<tr><td colspan="8" class="py-10 text-center">' + loader + '</td></tr>';
        if (movil) movil.innerHTML = loader;

        google.script.run
            .withSuccessHandler(function(res) {
                if (res.status === 'success') {
                    _usuariosTotal = res.data || [];
                    _poblarSelectRoles();
                    filtrarUsuarios();
                } else {
                    mostrarNotificacion('‚ùå ' + res.message, 'error');
                }
            })
            .withFailureHandler(function(err) {
                mostrarNotificacion('‚ùå Error de conexi√≥n: ' + err.toString(), 'error');
            })
            .obtenerUsuariosAdmin();
    }

    function _poblarSelectRoles() {
        var sel = document.getElementById('usr-filtro-rol');
        if (!sel) return;
        var valActual = sel.value;
        var roles = {};
        _usuariosTotal.forEach(function(u) { if (u.rol) roles[u.rol] = true; });
        sel.innerHTML = '<option value="" style="background:#1a242f;">Todos los roles</option>';
        Object.keys(roles).sort().forEach(function(r) {
            var opt = document.createElement('option');
            opt.value = r; opt.textContent = r; opt.style.background = '#1a242f';
            sel.appendChild(opt);
        });
        if (valActual) sel.value = valActual;
    }

    function filtrarUsuarios() {
        var q      = ((document.getElementById('usr-filtro-texto')  || {}).value || '').trim().toLowerCase();
        var rol    = ((document.getElementById('usr-filtro-rol')    || {}).value || '').trim();
        var estado = ((document.getElementById('usr-filtro-estado') || {}).value || '').trim();

        var filtrados = _usuariosTotal.filter(function(u) {
            var coincideTexto  = !q      || u.nombre.toLowerCase().includes(q) || u.email.toLowerCase().includes(q);
            var coincideRol    = !rol    || u.rol === rol;
            var coincideEstado = !estado || u.estado === estado;
            return coincideTexto && coincideRol && coincideEstado;
        });

        _actualizarStatsUsuarios(filtrados);
        _renderTablaUsuarios(filtrados);
        _renderCardsUsuariosMobil(filtrados);
    }

    function _actualizarStatsUsuarios(registros) {
        var activos   = registros.filter(function(u) { return u.estado === 'ACTIVO'; }).length;
        var inactivos = registros.filter(function(u) { return u.estado === 'INACTIVO'; }).length;
        var roles     = {};
        registros.forEach(function(u) { if (u.rol) roles[u.rol] = true; });

        var elTot = document.getElementById('usr-stat-total');
        var elAct = document.getElementById('usr-stat-activos');
        var elIna = document.getElementById('usr-stat-inactivos');
        var elRol = document.getElementById('usr-stat-roles');
        if (elTot) elTot.querySelector('.stat-num').textContent = registros.length;
        if (elAct) elAct.querySelector('.stat-num').textContent = activos;
        if (elIna) elIna.querySelector('.stat-num').textContent = inactivos;
        if (elRol) elRol.querySelector('.stat-num').textContent = Object.keys(roles).length;
    }

    function _renderTablaUsuarios(registros) {
        var tbody = document.getElementById('usr-tabla-body');
        if (!tbody) return;

        if (!registros || registros.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center py-10 text-slate-500 text-xs italic">' +
                '<div class="flex flex-col items-center gap-2">' +
                '<span class="material-symbols-outlined text-3xl">search_off</span>' +
                '<span>Sin usuarios para mostrar</span></div></td></tr>';
            return;
        }

        tbody.innerHTML = registros.map(function(u) {
            var esActivo = u.estado === 'ACTIVO';
            var estadoBadge = esActivo
                ? '<span class="inline-flex items-center gap-1 text-[9px] font-black bg-green-500/15 text-green-400 border border-green-500/30 px-2 py-0.5 rounded-lg">' +
                  '<span class="w-1.5 h-1.5 rounded-full bg-green-400"></span>ACTIVO</span>'
                : '<span class="inline-flex items-center gap-1 text-[9px] font-black bg-red-500/15 text-red-400 border border-red-500/30 px-2 py-0.5 rounded-lg">' +
                  '<span class="w-1.5 h-1.5 rounded-full bg-red-400"></span>INACTIVO</span>';

            var rolBadge = '<span class="text-[9px] font-black px-2 py-0.5 rounded-lg" style="background:rgba(197,160,72,0.12);color:var(--color-primario);border:1px solid rgba(197,160,72,0.3)">' +
                _esc(u.rol) + '</span>';

            return '<tr class="border-b border-white/5 hover:bg-white/5 transition-colors">' +
                '<td class="px-3 py-2.5 text-[10px] font-mono whitespace-nowrap" style="color:var(--color-primario)">' + _esc(u.id) + '</td>' +
                '<td class="px-3 py-2.5 text-xs font-bold text-white whitespace-nowrap">' + _esc(u.nombre) + '</td>' +
                '<td class="px-3 py-2.5 text-[11px] text-slate-400 whitespace-nowrap">' + _esc(u.email) + '</td>' +
                '<td class="px-3 py-2.5 whitespace-nowrap">' + rolBadge + '</td>' +
                '<td class="px-3 py-2.5 text-[11px] text-slate-400 whitespace-nowrap">' + _esc(u.cedula || '-') + '</td>' +
                '<td class="px-3 py-2.5 text-[11px] text-slate-400 whitespace-nowrap">' + _esc(u.celular || '-') + '</td>' +
                '<td class="px-3 py-2.5 whitespace-nowrap">' + estadoBadge + '</td>' +
                '<td class="px-3 py-2.5 whitespace-nowrap">' +
                    '<div class="flex items-center gap-1.5">' +
                    '<button onclick="abrirModalUsuario(\'' + _esc(u.id) + '\')" title="Editar" ' +
                        'class="w-7 h-7 rounded-lg bg-white/5 hover:bg-primary/20 border border-white/10 hover:border-primary/30 flex items-center justify-center transition-all">' +
                        '<span class="material-symbols-outlined text-sm text-slate-400 hover:text-primary">edit</span></button>' +
                    '<button onclick="abrirModalResetPassword(\'' + _esc(u.id) + '\',\'' + _esc(u.nombre) + '\')" title="Reset contrase√±a" ' +
                        'class="w-7 h-7 rounded-lg bg-white/5 hover:bg-amber-500/20 border border-white/10 hover:border-amber-500/30 flex items-center justify-center transition-all">' +
                        '<span class="material-symbols-outlined text-sm text-slate-400 hover:text-amber-400">key</span></button>' +
                    '<button onclick="toggleEstadoUsuario(\'' + _esc(u.id) + '\')" title="' + (esActivo ? 'Desactivar' : 'Activar') + '" ' +
                        'class="w-7 h-7 rounded-lg bg-white/5 hover:bg-' + (esActivo ? 'red' : 'green') + '-500/20 border border-white/10 flex items-center justify-center transition-all">' +
                        '<span class="material-symbols-outlined text-sm ' + (esActivo ? 'text-green-400 hover:text-red-400' : 'text-red-400 hover:text-green-400') + '">' + (esActivo ? 'toggle_on' : 'toggle_off') + '</span></button>' +
                    '</div>' +
                '</td>' +
                '</tr>';
        }).join('');
    }

    function _renderCardsUsuariosMobil(registros) {
        var lista = document.getElementById('usr-lista-mobile');
        if (!lista) return;

        if (!registros || registros.length === 0) {
            lista.innerHTML = '<div class="text-center py-8 text-slate-500 text-xs italic">Sin usuarios para mostrar</div>';
            return;
        }

        lista.innerHTML = registros.map(function(u) {
            var esActivo = u.estado === 'ACTIVO';
            var estadoBadge = esActivo
                ? '<span class="text-[9px] font-black text-green-400 bg-green-500/15 border border-green-500/30 px-2 py-0.5 rounded-lg">ACTIVO</span>'
                : '<span class="text-[9px] font-black text-red-400 bg-red-500/15 border border-red-500/30 px-2 py-0.5 rounded-lg">INACTIVO</span>';

            return '<div class="bg-white/5 border border-white/10 rounded-xl p-3 animate-fade-in">' +
                '<div class="flex items-start justify-between gap-2 mb-2">' +
                '<div><p class="text-[10px] font-black uppercase tracking-tight" style="color:var(--color-primario)">' + _esc(u.id) + '</p>' +
                '<p class="text-xs font-bold text-white">' + _esc(u.nombre) + '</p>' +
                '<p class="text-[10px] text-slate-500">' + _esc(u.email) + '</p></div>' +
                estadoBadge + '</div>' +
                '<div class="grid grid-cols-2 gap-x-3 gap-y-1 text-[10px] mb-2.5">' +
                '<span class="text-slate-500">Rol:</span><span class="text-primary font-bold">' + _esc(u.rol) + '</span>' +
                '<span class="text-slate-500">C√©dula:</span><span class="text-slate-300">' + _esc(u.cedula || '-') + '</span>' +
                '<span class="text-slate-500">Celular:</span><span class="text-slate-300">' + _esc(u.celular || '-') + '</span>' +
                '<span class="text-slate-500">Celular:</span><span class="text-slate-300">' + _esc(u.celular || '-') + '</span>' +
                '</div>' +
                '<div class="flex gap-2 border-t border-white/5 pt-2">' +
                '<button onclick="abrirModalUsuario(\'' + _esc(u.id) + '\')" ' +
                    'class="flex-1 py-1.5 text-[10px] font-black text-slate-300 bg-white/5 border border-white/10 rounded-lg flex items-center justify-center gap-1">' +
                    '<span class="material-symbols-outlined text-xs">edit</span>Editar</button>' +
                '<button onclick="abrirModalResetPassword(\'' + _esc(u.id) + '\',\'' + _esc(u.nombre) + '\')" ' +
                    'class="flex-1 py-1.5 text-[10px] font-black text-amber-400 bg-amber-500/10 border border-amber-500/20 rounded-lg flex items-center justify-center gap-1">' +
                    '<span class="material-symbols-outlined text-xs">key</span>Password</button>' +
                '<button onclick="toggleEstadoUsuario(\'' + _esc(u.id) + '\')" ' +
                    'class="flex-1 py-1.5 text-[10px] font-black ' + (esActivo ? 'text-red-400 bg-red-500/10 border-red-500/20' : 'text-green-400 bg-green-500/10 border-green-500/20') + ' border rounded-lg flex items-center justify-center gap-1">' +
                    '<span class="material-symbols-outlined text-xs">' + (esActivo ? 'toggle_off' : 'toggle_on') + '</span>' + (esActivo ? 'Desactivar' : 'Activar') + '</button>' +
                '</div></div>';
        }).join('');
    }

    // ‚îÄ‚îÄ Modal crear / editar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function abrirModalUsuario(id) {
        _usrEditandoId = id || null;
        var modal    = document.getElementById('usr-modal');
        var titulo   = document.getElementById('usr-modal-titulo');
        var subId    = document.getElementById('usr-modal-id');
        var fldPwd   = document.getElementById('usr-campo-password');
        var fldEst   = document.getElementById('usr-campo-estado');

        var fldEmpresa = document.getElementById('usr-campo-empresa');

        if (!id) {
            // NUEVO
            titulo.textContent = 'Nuevo Usuario';
            subId.textContent  = 'C√≥digo se asignar√° autom√°ticamente';
            document.getElementById('usr-inp-nombre').value    = '';
            document.getElementById('usr-inp-email').value     = '';
            document.getElementById('usr-inp-email').readOnly  = false;
            document.getElementById('usr-inp-email').style.opacity = '1';
            document.getElementById('usr-inp-rol').value       = '';
            document.getElementById('usr-inp-password').value  = '';
            document.getElementById('usr-inp-cedula').value    = '';
            document.getElementById('usr-inp-celular').value   = '';
            var selEmp = document.getElementById('usr-inp-empresa');
            if (selEmp) selEmp.value = '';
            fldPwd.classList.remove('hidden');
            fldEst.classList.add('hidden');
            if (fldEmpresa) fldEmpresa.classList.add('hidden'); // se mostrar√° al elegir CLI
        } else {
            // EDICI√ìN
            var u = _usuariosTotal.find(function(x) { return x.id === id; });
            if (!u) return;
            titulo.textContent = 'Editar Usuario';
            subId.textContent  = u.id;
            document.getElementById('usr-inp-nombre').value    = u.nombre;
            document.getElementById('usr-inp-email').value     = u.email;
            document.getElementById('usr-inp-email').readOnly  = true;
            document.getElementById('usr-inp-email').style.opacity = '0.5';
            document.getElementById('usr-inp-rol').value       = u.rol;
            document.getElementById('usr-inp-cedula').value    = u.cedula || '';
            document.getElementById('usr-inp-celular').value   = u.celular || '';
            document.getElementById('usr-inp-estado').value    = u.estado;
            fldPwd.classList.add('hidden');
            fldEst.classList.remove('hidden');
            // En edici√≥n nunca se muestra el selector de empresa (el c√≥digo ya est√° asignado)
            if (fldEmpresa) fldEmpresa.classList.add('hidden');
        }

        modal.classList.remove('hidden');
    }

    function cerrarModalUsuario() {
        var modal = document.getElementById('usr-modal');
        if (modal) modal.classList.add('hidden');
        _usrEditandoId = null;
    }

    // Muestra/oculta el selector de empresa seg√∫n el rol elegido
    function onCambioRolUsuario() {
        var rol          = ((document.getElementById('usr-inp-rol') || {}).value || '');
        var campoEmpresa = document.getElementById('usr-campo-empresa');
        if (!campoEmpresa) return;

        if (rol === 'CLI') {
            campoEmpresa.classList.remove('hidden');
            _cargarClientesParaModal(); // carga y puebla el select
        } else {
            campoEmpresa.classList.add('hidden');
            var sel = document.getElementById('usr-inp-empresa');
            if (sel) sel.value = '';
        }
    }

    // Carga DB_CLIENTES desde el backend (con cach√© en memoria)
    function _cargarClientesParaModal() {
        if (_clientesParaModal.length > 0) { _poblarSelectEmpresas(); return; }
        google.script.run
            .withSuccessHandler(function(res) {
                if (res && res.status === 'success') {
                    _clientesParaModal = res.data || [];
                    _poblarSelectEmpresas();
                } else {
                    mostrarNotificacion('‚ùå No se pudieron cargar las empresas.', 'error');
                }
            })
            .withFailureHandler(function(err) {
                mostrarNotificacion('‚ùå Error cargando empresas: ' + err.toString(), 'error');
            })
            .obtenerClientesParaUsuarios();
    }

    // Puebla el <select> de empresas con los datos de _clientesParaModal
    function _poblarSelectEmpresas() {
        var sel = document.getElementById('usr-inp-empresa');
        if (!sel) return;
        var valActual = sel.value;
        sel.innerHTML = '<option value="" style="background:#1a242f;">Seleccione una empresa...</option>';
        _clientesParaModal.forEach(function(c) {
            var opt             = document.createElement('option');
            opt.value           = c.id;
            opt.textContent     = c.id + ' ‚Äî ' + c.nombre;
            opt.style.background = '#1a242f';
            // Guardamos los datos del cliente como atributos para auto-completar
            opt.dataset.correo   = c.correo;
            opt.dataset.contacto = c.contacto;
            opt.dataset.celular  = c.celular;
            sel.appendChild(opt);
        });
        if (valActual) sel.value = valActual;
    }

    // Auto-completa email, nombre y celular al elegir un cliente en el selector
    function onSeleccionClienteUsuario() {
        var sel = document.getElementById('usr-inp-empresa');
        if (!sel || !sel.value) return;
        var opt     = sel.options[sel.selectedIndex];
        var correo  = opt.dataset.correo   || '';
        var contacto = opt.dataset.contacto || '';
        var celular = opt.dataset.celular  || '';

        var inpEmail   = document.getElementById('usr-inp-email');
        var inpNombre  = document.getElementById('usr-inp-nombre');
        var inpCelular = document.getElementById('usr-inp-celular');
        if (inpEmail  && !inpEmail.readOnly)  inpEmail.value   = correo;
        if (inpNombre && !inpNombre.readOnly) inpNombre.value  = contacto;
        if (inpCelular) inpCelular.value = celular;
    }

    function guardarUsuario() {
        var nombre   = (document.getElementById('usr-inp-nombre')   || {}).value || '';
        var email    = (document.getElementById('usr-inp-email')    || {}).value || '';
        var rol      = (document.getElementById('usr-inp-rol')      || {}).value || '';
        var password = (document.getElementById('usr-inp-password') || {}).value || '';
        var cedula   = (document.getElementById('usr-inp-cedula')   || {}).value || '';
        var celular  = (document.getElementById('usr-inp-celular')  || {}).value || '';
        var estado   = (document.getElementById('usr-inp-estado')   || {}).value || 'ACTIVO';

        if (!nombre.trim()) { mostrarNotificacion('‚ö†Ô∏è El nombre es obligatorio.', 'warning'); return; }
        if (!email.trim())  { mostrarNotificacion('‚ö†Ô∏è El email es obligatorio.', 'warning'); return; }
        if (!rol)           { mostrarNotificacion('‚ö†Ô∏è Seleccione un rol.', 'warning'); return; }
        if (!_usrEditandoId && !password.trim()) { mostrarNotificacion('‚ö†Ô∏è La contrase√±a es obligatoria.', 'warning'); return; }

        // Para CLI en creaci√≥n validar que se seleccion√≥ empresa
        var idClienteAsociado = '';
        if (!_usrEditandoId && rol === 'CLI') {
            var selEmpresa = document.getElementById('usr-inp-empresa');
            idClienteAsociado = selEmpresa ? selEmpresa.value : '';
            if (!idClienteAsociado) { mostrarNotificacion('‚ö†Ô∏è Seleccione la empresa para el usuario cliente.', 'warning'); return; }
        }

        var btn     = document.getElementById('usr-btn-guardar');
        var spinner = document.getElementById('usr-spinner-guardar');
        if (btn)     btn.disabled = true;
        if (spinner) spinner.classList.remove('hidden');

        var datos = { nombre: nombre.trim(), email: email.trim(), rol: rol.trim(),
                      cedula: cedula.trim(), celular: celular.trim(),
                      idClienteAsociado: idClienteAsociado };

        var fnExito = function(res) {
            if (btn)     btn.disabled = false;
            if (spinner) spinner.classList.add('hidden');
            if (res.status === 'success') {
                mostrarNotificacion('‚úÖ ' + res.message, 'success');
                cerrarModalUsuario();
                cargarUsuariosAdmin();
            } else {
                mostrarNotificacion('‚ùå ' + res.message, 'error');
            }
        };
        var fnError = function(err) {
            if (btn)     btn.disabled = false;
            if (spinner) spinner.classList.add('hidden');
            mostrarNotificacion('‚ùå Error: ' + err.toString(), 'error');
        };

        if (_usrEditandoId) {
            datos.id     = _usrEditandoId;
            datos.estado = estado;
            google.script.run.withSuccessHandler(fnExito).withFailureHandler(fnError).actualizarUsuario(datos);
        } else {
            datos.password = password.trim();
            google.script.run.withSuccessHandler(fnExito).withFailureHandler(fnError).crearUsuario(datos);
        }
    }

    // ‚îÄ‚îÄ Modal reset de contrase√±a ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function abrirModalResetPassword(id, nombre) {
        _usrResetId = id;
        var modal = document.getElementById('usr-reset-modal');
        var nomEl = document.getElementById('usr-reset-nombre');
        var inp   = document.getElementById('usr-reset-inp');
        if (nomEl) nomEl.textContent = nombre || id;
        if (inp)   inp.value = '';
        if (modal) modal.classList.remove('hidden');
    }

    function cerrarModalResetPassword() {
        var modal = document.getElementById('usr-reset-modal');
        if (modal) modal.classList.add('hidden');
        _usrResetId = null;
    }

    function confirmarResetPassword() {
        var newPass = ((document.getElementById('usr-reset-inp') || {}).value || '').trim();
        if (!newPass) { mostrarNotificacion('‚ö†Ô∏è Ingrese la nueva contrase√±a.', 'warning'); return; }
        if (newPass.length < 4) { mostrarNotificacion('‚ö†Ô∏è La contrase√±a debe tener al menos 4 caracteres.', 'warning'); return; }

        var btn     = document.getElementById('usr-btn-reset');
        var spinner = document.getElementById('usr-spinner-reset');
        if (btn)     btn.disabled = true;
        if (spinner) spinner.classList.remove('hidden');

        google.script.run
            .withSuccessHandler(function(res) {
                if (btn)     btn.disabled = false;
                if (spinner) spinner.classList.add('hidden');
                if (res.status === 'success') {
                    mostrarNotificacion('‚úÖ ' + res.message, 'success');
                    cerrarModalResetPassword();
                } else {
                    mostrarNotificacion('‚ùå ' + res.message, 'error');
                }
            })
            .withFailureHandler(function(err) {
                if (btn)     btn.disabled = false;
                if (spinner) spinner.classList.add('hidden');
                mostrarNotificacion('‚ùå Error: ' + err.toString(), 'error');
            })
            .resetPasswordUsuario(_usrResetId, newPass);
    }

    // ‚îÄ‚îÄ Toggle estado usuario ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function toggleEstadoUsuario(id) {
        var u = _usuariosTotal.find(function(x) { return x.id === id; });
        var accion = u && u.estado === 'ACTIVO' ? 'desactivar' : 'activar';
        if (!confirm('¬øDesea ' + accion + ' este usuario?')) return;

        google.script.run
            .withSuccessHandler(function(res) {
                if (res.status === 'success') {
                    mostrarNotificacion('‚úÖ ' + res.message, 'success');
                    cargarUsuariosAdmin();
                } else {
                    mostrarNotificacion('‚ùå ' + res.message, 'error');
                }
            })
            .withFailureHandler(function(err) {
                mostrarNotificacion('‚ùå Error: ' + err.toString(), 'error');
            })
            .toggleEstadoUsuario(id);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // M√ìDULO: GESTOR DE FORMATOS POR EMPRESA
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    let _formatosAdminTotal = []; // cache completo de LISTAS_FORMATOS
    let _fmtEditando        = null; // { id, empresa } del formato en edici√≥n, null = nuevo

    function cargarFormatosAdmin() {
        var loader = '<div class="flex flex-col items-center gap-2 py-8 text-slate-500 text-xs italic">' +
                     '<div class="animate-spin h-6 w-6 border-2 border-primary/30 border-t-primary rounded-full"></div>' +
                     '<span>Cargando formatos...</span></div>';
        var tbody = document.getElementById('fmt-tabla-body');
        var movil = document.getElementById('fmt-lista-mobile');
        if (tbody) tbody.innerHTML = '<tr><td colspan="5" class="py-10 text-center">' + loader + '</td></tr>';
        if (movil) movil.innerHTML = loader;

        google.script.run
            .withSuccessHandler(function(res) {
                if (res.status === 'success') {
                    _formatosAdminTotal = res.data || [];
                    _poblarFiltroEmpresasFormatos();
                    filtrarFormatos();
                } else {
                    mostrarNotificacion('‚ùå ' + res.message, 'error');
                }
            })
            .withFailureHandler(function(err) {
                mostrarNotificacion('‚ùå Error de conexi√≥n: ' + err.toString(), 'error');
            })
            .obtenerFormatosAdmin();
    }

    // Puebla el filtro de empresa din√°micamente y siempre resetea a "todas"
    // para que los nuevos formatos sean visibles inmediatamente tras guardar o recargar
    function _poblarFiltroEmpresasFormatos() {
        var sel = document.getElementById('fmt-filtro-empresa');
        if (!sel) return;
        var empresas = {};
        _formatosAdminTotal.forEach(function(f) { if (f.empresa) empresas[f.empresa] = true; });
        sel.innerHTML = '<option value="" style="background:#1a242f;">Todas las empresas</option>';
        Object.keys(empresas).sort().forEach(function(e) {
            var opt = document.createElement('option');
            opt.value = e; opt.textContent = e; opt.style.background = '#1a242f';
            sel.appendChild(opt);
        });
        // No restauramos el valor previo: al recargar siempre mostramos todos
        sel.value = '';
    }

    function filtrarFormatos() {
        var q       = ((document.getElementById('fmt-filtro-texto')   || {}).value || '').trim().toLowerCase();
        var empresa = ((document.getElementById('fmt-filtro-empresa')  || {}).value || '').trim();
        var tipo    = ((document.getElementById('fmt-filtro-tipo')     || {}).value || '').trim();

        var filtrados = _formatosAdminTotal.filter(function(f) {
            var coincideTexto   = !q       || f.id.toLowerCase().includes(q) || f.descripcion.toLowerCase().includes(q);
            var coincideEmpresa = !empresa || f.empresa === empresa;
            var coincideTipo    = !tipo    || f.tipo === tipo;
            return coincideTexto && coincideEmpresa && coincideTipo;
        });

        _actualizarStatsFormatos(filtrados);
        _renderTablaFormatos(filtrados);
        _renderCardsFormatosMobil(filtrados);
    }

    function _actualizarStatsFormatos(registros) {
        var empresas     = {};
        var permisos     = 0;
        var inspecciones = 0;
        registros.forEach(function(f) {
            if (f.empresa) empresas[f.empresa] = true;
            if (f.tipo === 'Permiso')     permisos++;
            if (f.tipo === 'Inspeccion')  inspecciones++;
        });
        var elTot = document.getElementById('fmt-stat-total');
        var elEmp = document.getElementById('fmt-stat-empresas');
        var elPer = document.getElementById('fmt-stat-permisos');
        var elIns = document.getElementById('fmt-stat-inspecciones');
        if (elTot) elTot.querySelector('.stat-num').textContent = registros.length;
        if (elEmp) elEmp.querySelector('.stat-num').textContent = Object.keys(empresas).length;
        if (elPer) elPer.querySelector('.stat-num').textContent = permisos;
        if (elIns) elIns.querySelector('.stat-num').textContent = inspecciones;
    }

    // Colores por tipo de documento
    var _TIPO_BADGE = {
        'Registro':   { bg: 'bg-green-500/15',  text: 'text-green-400',  border: 'border-green-500/30'  },
        'Permiso':    { bg: 'bg-amber-500/15',   text: 'text-amber-400',  border: 'border-amber-500/30'  },
        'Inspeccion': { bg: 'bg-blue-500/15',    text: 'text-blue-400',   border: 'border-blue-500/30'   },
        'Ejecucion':  { bg: 'bg-purple-500/15',  text: 'text-purple-400', border: 'border-purple-500/30' }
    };

    function _tipoBadge(tipo) {
        var c = _TIPO_BADGE[tipo] || { bg: 'bg-white/10', text: 'text-slate-400', border: 'border-white/20' };
        return '<span class="inline-flex text-[9px] font-black px-2 py-0.5 rounded-lg border ' +
               c.bg + ' ' + c.text + ' ' + c.border + '">' + _esc(tipo || '-') + '</span>';
    }

    function _renderTablaFormatos(registros) {
        var tbody = document.getElementById('fmt-tabla-body');
        if (!tbody) return;
        if (!registros || registros.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-10 text-slate-500 text-xs italic">' +
                '<div class="flex flex-col items-center gap-2">' +
                '<span class="material-symbols-outlined text-3xl">search_off</span>' +
                '<span>Sin formatos para mostrar</span></div></td></tr>';
            return;
        }
        tbody.innerHTML = registros.map(function(f) {
            var idEscaped = encodeURIComponent(f.id);
            var empEscaped = encodeURIComponent(f.empresa);
            return '<tr class="border-b border-white/5 hover:bg-white/5 transition-colors">' +
                '<td class="px-3 py-3"><span class="text-xs font-black text-primary tracking-widest">' + _esc(f.id) + '</span></td>' +
                '<td class="px-3 py-3 text-xs text-slate-200 max-w-[280px]">' + _esc(f.descripcion) + '</td>' +
                '<td class="px-3 py-3">' + _tipoBadge(f.tipo) + '</td>' +
                '<td class="px-3 py-3 text-xs text-slate-300">' + _esc(f.empresa) + '</td>' +
                '<td class="px-3 py-3 text-right">' +
                '<div class="flex items-center justify-end gap-1">' +
                '<button onclick="abrirModalFormato(\'' + idEscaped + '\',\'' + empEscaped + '\')" ' +
                'class="w-7 h-7 flex items-center justify-center rounded-lg bg-white/5 hover:bg-primary/20 text-slate-400 hover:text-primary transition border border-white/10" title="Editar">' +
                '<span class="material-symbols-outlined text-sm">edit</span></button>' +
                '<button onclick="eliminarFormato(\'' + idEscaped + '\',\'' + empEscaped + '\')" ' +
                'class="w-7 h-7 flex items-center justify-center rounded-lg bg-white/5 hover:bg-red-500/20 text-slate-400 hover:text-red-400 transition border border-white/10" title="Eliminar">' +
                '<span class="material-symbols-outlined text-sm">delete</span></button>' +
                '</div></td></tr>';
        }).join('');
    }

    function _renderCardsFormatosMobil(registros) {
        var cont = document.getElementById('fmt-lista-mobile');
        if (!cont) return;
        if (!registros || registros.length === 0) {
            cont.innerHTML = '<div class="flex flex-col items-center gap-2 py-8 text-slate-500 text-xs italic">' +
                '<span class="material-symbols-outlined text-3xl">search_off</span><span>Sin formatos para mostrar</span></div>';
            return;
        }
        cont.innerHTML = registros.map(function(f) {
            var idEscaped  = encodeURIComponent(f.id);
            var empEscaped = encodeURIComponent(f.empresa);
            return '<div class="bg-white/5 rounded-xl border border-white/10 p-3 space-y-2">' +
                '<div class="flex items-start justify-between">' +
                '<div><p class="text-xs font-black text-primary tracking-widest">' + _esc(f.id) + '</p>' +
                '<p class="text-[10px] text-slate-300 mt-0.5">' + _esc(f.descripcion) + '</p></div>' +
                _tipoBadge(f.tipo) + '</div>' +
                '<div class="flex items-center justify-between">' +
                '<span class="text-[9px] text-slate-500">' + _esc(f.empresa) + '</span>' +
                '<div class="flex gap-1">' +
                '<button onclick="abrirModalFormato(\'' + idEscaped + '\',\'' + empEscaped + '\')" ' +
                'class="text-[9px] font-black px-2 py-1 rounded-lg bg-primary/10 text-primary border border-primary/20 hover:opacity-80 transition">Editar</button>' +
                '<button onclick="eliminarFormato(\'' + idEscaped + '\',\'' + empEscaped + '\')" ' +
                'class="text-[9px] font-black px-2 py-1 rounded-lg bg-red-500/10 text-red-400 border border-red-500/20 hover:opacity-80 transition">Eliminar</button>' +
                '</div></div></div>';
        }).join('');
    }

    // ‚îÄ‚îÄ Modal crear / editar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function abrirModalFormato(idEnc, empresaEnc) {
        var modal  = document.getElementById('fmt-modal');
        var titulo = document.getElementById('fmt-modal-titulo');
        var sub    = document.getElementById('fmt-modal-sub');
        var inpId  = document.getElementById('fmt-inp-id');
        var nota   = document.getElementById('fmt-nota-id');

        // Poblar el select de empresas desde _clientesParaModal (cache compartido con usuarios)
        _poblarSelectEmpresasFormatos();

        if (!idEnc) {
            // CREAR
            _fmtEditando = null;
            titulo.textContent = 'Nuevo Formato';
            sub.textContent    = 'Se vincular√° a la empresa seleccionada';
            inpId.value        = '';
            inpId.readOnly     = false;
            inpId.style.opacity = '1';
            if (nota) nota.classList.remove('hidden');
            document.getElementById('fmt-inp-descripcion').value = '';
            document.getElementById('fmt-inp-tipo').value        = '';
            document.getElementById('fmt-inp-empresa').value     = '';
        } else {
            // EDITAR
            var id      = decodeURIComponent(idEnc);
            var empresa = decodeURIComponent(empresaEnc);
            var f = _formatosAdminTotal.find(function(x) { return x.id === id && x.empresa === empresa; });
            if (!f) return;
            _fmtEditando = { id: f.id, empresa: f.empresa };
            titulo.textContent = 'Editar Formato';
            sub.textContent    = f.id + ' ¬∑ ' + f.empresa;
            inpId.value        = f.id;
            inpId.readOnly     = true;
            inpId.style.opacity = '0.5';
            if (nota) nota.classList.add('hidden');
            document.getElementById('fmt-inp-descripcion').value = f.descripcion;
            document.getElementById('fmt-inp-tipo').value        = f.tipo;
            document.getElementById('fmt-inp-empresa').value     = f.empresa;
            document.getElementById('fmt-inp-empresa').disabled  = true;
        }
        modal.classList.remove('hidden');
    }

    function cerrarModalFormato() {
        var modal = document.getElementById('fmt-modal');
        if (modal) modal.classList.add('hidden');
        var selEmp = document.getElementById('fmt-inp-empresa');
        if (selEmp) selEmp.disabled = false;
        _fmtEditando = null;
    }

    // Puebla el select de empresa del modal con los clientes de DB_CLIENTES
    function _poblarSelectEmpresasFormatos() {
        var sel = document.getElementById('fmt-inp-empresa');
        if (!sel) return;
        // Si ya tiene opciones cargadas (m√°s de 1), no repoblar
        if (sel.options.length > 1) return;

        if (_clientesParaModal.length > 0) {
            _llenarSelectEmpresasFormatos(sel);
        } else {
            // Cargar clientes y luego poblar
            google.script.run
                .withSuccessHandler(function(res) {
                    if (res && res.status === 'success') {
                        _clientesParaModal = res.data || [];
                        _llenarSelectEmpresasFormatos(sel);
                    }
                })
                .obtenerClientesParaUsuarios();
        }
    }

    function _llenarSelectEmpresasFormatos(sel) {
        sel.innerHTML = '<option value="" style="background:#1a242f;">Seleccione la empresa...</option>';
        _clientesParaModal.forEach(function(c) {
            var opt = document.createElement('option');
            opt.value = c.nombre; opt.textContent = c.nombre; opt.style.background = '#1a242f';
            sel.appendChild(opt);
        });
    }

    function guardarFormato() {
        var id          = ((document.getElementById('fmt-inp-id')          || {}).value || '').trim().toUpperCase();
        var descripcion = ((document.getElementById('fmt-inp-descripcion') || {}).value || '').trim();
        var tipo        = ((document.getElementById('fmt-inp-tipo')        || {}).value || '').trim();
        var empresa     = ((document.getElementById('fmt-inp-empresa')     || {}).value || '').trim();

        if (!id)          { mostrarNotificacion('‚ö†Ô∏è El c√≥digo del formato es obligatorio.', 'warning'); return; }
        if (!descripcion) { mostrarNotificacion('‚ö†Ô∏è La descripci√≥n es obligatoria.',        'warning'); return; }
        if (!tipo)        { mostrarNotificacion('‚ö†Ô∏è Seleccione el tipo de documento.',      'warning'); return; }
        if (!empresa)     { mostrarNotificacion('‚ö†Ô∏è Seleccione la empresa contratista.',    'warning'); return; }

        var btn     = document.getElementById('fmt-btn-guardar');
        var spinner = document.getElementById('fmt-spinner-guardar');
        if (btn)     btn.disabled = true;
        if (spinner) spinner.classList.remove('hidden');

        var fnExito = function(res) {
            if (btn)     btn.disabled = false;
            if (spinner) spinner.classList.add('hidden');
            if (res.status === 'success') {
                mostrarNotificacion('‚úÖ ' + res.message, 'success');
                cerrarModalFormato();
                cargarFormatosAdmin();
            } else {
                mostrarNotificacion('‚ùå ' + res.message, 'error');
            }
        };
        var fnError = function(err) {
            if (btn)     btn.disabled = false;
            if (spinner) spinner.classList.add('hidden');
            mostrarNotificacion('‚ùå Error: ' + err.toString(), 'error');
        };

        var datos = { id: id, descripcion: descripcion, tipo: tipo, empresa: empresa };
        if (_fmtEditando) {
            datos.empresa = _fmtEditando.empresa; // usar la empresa original como clave
            google.script.run.withSuccessHandler(fnExito).withFailureHandler(fnError).actualizarFormato(datos);
        } else {
            google.script.run.withSuccessHandler(fnExito).withFailureHandler(fnError).crearFormato(datos);
        }
    }

    function eliminarFormato(idEnc, empresaEnc) {
        var id      = decodeURIComponent(idEnc);
        var empresa = decodeURIComponent(empresaEnc);
        if (!confirm('¬øEliminar el formato ' + id + ' de ' + empresa + '?\nEsta acci√≥n no se puede deshacer.')) return;

        google.script.run
            .withSuccessHandler(function(res) {
                if (res.status === 'success') {
                    mostrarNotificacion('‚úÖ ' + res.message, 'success');
                    cargarFormatosAdmin();
                } else {
                    mostrarNotificacion('‚ùå ' + res.message, 'error');
                }
            })
            .withFailureHandler(function(err) {
                mostrarNotificacion('‚ùå Error: ' + err.toString(), 'error');
            })
            .eliminarFormato(id, empresa);
    }

    function onExito(response) {
        mostrarNotificacion('‚úÖ ' + response.message, 'success');
        archivoBase64 = null;
        const form = document.getElementById('sst-form');
        if (form) form.reset();
        const prev = document.getElementById('preview-container');
        if (prev) prev.classList.add('hidden');
        _intentarBloqueoEmpresa();
        const descCont = document.getElementById('formato-descripcion-container');
        if (descCont) descCont.classList.add('hidden');
    }

    function onError(message) {
        mostrarNotificacion('‚ùå Error: ' + message, 'error');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // M√ìDULO 5: GESTI√ìN SUPERVISOR STT ‚Äî Dashboard de rendimiento
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    var _sstCache = null; // Cache de datos cargados del backend

    /**
     * Carga las m√©tricas de supervisores desde el backend y renderiza el dashboard.
     */
    function cargarSupervisorSTT() {
        // Mostrar loader, ocultar contenido y error
        var loader  = document.getElementById('sst-loader');
        var content = document.getElementById('sst-content');
        var errBox  = document.getElementById('sst-error');
        if (loader)  { loader.classList.remove('hidden'); loader.style.display = 'flex'; }
        if (content) content.classList.add('hidden');
        if (errBox)  { errBox.classList.add('hidden'); errBox.style.display = 'none'; }

        google.script.run
            .withSuccessHandler(function(res) {
                if (loader)  { loader.classList.add('hidden'); loader.style.display = 'none'; }
                if (res.status !== 'success') {
                    _sstMostrarError(res.message || 'Error desconocido.');
                    return;
                }
                _sstCache = res.data;
                _sstPoblarFiltros(res.data.supervisores, res.data.empresas || []);
                _sstRenderKpis(res.data.kpis);
                _sstRenderAlertas(res.data.supervisores);
                _sstRenderTabla(res.data.supervisores);
                if (content) content.classList.remove('hidden');
                _sstPoblarSelectoresEval();
            })
            .withFailureHandler(function(err) {
                if (loader) { loader.classList.add('hidden'); loader.style.display = 'none'; }
                _sstMostrarError(err.message || err.toString());
            })
            .obtenerMetricasSupervisoresSTT();
    }

    /** Muestra el panel de error con un mensaje. */
    function _sstMostrarError(msg) {
        var errBox = document.getElementById('sst-error');
        var errMsg = document.getElementById('sst-error-msg');
        if (errMsg) errMsg.textContent = msg;
        if (errBox) { errBox.classList.remove('hidden'); errBox.style.display = 'flex'; }
    }

    /** Rellena los selectores de filtro con los datos cargados. */
    function _sstPoblarFiltros(supervisores, empresas) {
        var selSup  = document.getElementById('sst-filtro-supervisor');
        var selObra = document.getElementById('sst-filtro-obra');
        if (!selSup || !selObra) return;

        // Opciones de supervisor: todos los SUP-SST activos del sistema
        var opcionesSup = '<option value="" style="background:#1a242f;">Todos los supervisores</option>';
        supervisores.forEach(function(s) {
            opcionesSup += '<option value="' + s.email + '" style="background:#1a242f;">' + s.nombre + '</option>';
        });
        selSup.innerHTML = opcionesSup;

        // Opciones de empresa: primero las de DB_CLIENTES activas,
        // luego a√±adir cualquier obra presente en la actividad que no est√© ya en la lista
        var empSet = {};
        (empresas || []).forEach(function(e) { if (e) empSet[e] = true; });
        supervisores.forEach(function(s) {
            (s.obras || []).forEach(function(o) { if (o) empSet[o] = true; });
        });
        var opcionesObra = '<option value="" style="background:#1a242f;">Todas las empresas</option>';
        Object.keys(empSet).sort().forEach(function(o) {
            opcionesObra += '<option value="' + o + '" style="background:#1a242f;">' + o + '</option>';
        });
        selObra.innerHTML = opcionesObra;
    }

    /** Renderiza las 4 tarjetas KPI globales. */
    function _sstRenderKpis(kpis) {
        var set = function(id, val) { var el = document.getElementById(id); if (el) el.textContent = val; };
        set('sst-kpi-supervisores',  kpis.totalSupervisores);
        set('sst-kpi-formatos-pend', kpis.formatosPendientes);
        set('sst-kpi-hallazgos-ab',  kpis.hallazgosAbiertos);
        set('sst-kpi-tasa',          kpis.tasaGlobal + '%');
    }

    /** Renderiza las secciones de alertas cr√≠ticas. */
    function _sstRenderAlertas(supervisores) {
        var alertasBox   = document.getElementById('sst-alertas-box');
        var wrapFormatos = document.getElementById('sst-alertas-formatos-wrap');
        var wrapHallazg  = document.getElementById('sst-alertas-hallazgos-wrap');
        var badgeFmt     = document.getElementById('sst-badge-formatos');
        var badgeHall    = document.getElementById('sst-badge-hallazgos');
        var listFmt      = document.querySelector('#sst-alertas-formatos-list > div');
        var listHall     = document.querySelector('#sst-alertas-hallazgos-list > div');
        if (!alertasBox) return;

        // Recopilar todas las alertas
        var todasAlerFmt  = [];
        var todasAlerHall = [];
        supervisores.forEach(function(s) {
            (s.alertasFormatos || []).forEach(function(a) {
                todasAlerFmt.push({ supervisor: s.nombre, item: a });
            });
            (s.alertasHallazgos || []).forEach(function(a) {
                todasAlerHall.push({ supervisor: s.nombre, item: a });
            });
        });
        todasAlerFmt.sort(function(a, b)  { return b.item.dias - a.item.dias; });
        todasAlerHall.sort(function(a, b) { return b.item.dias - a.item.dias; });

        var hayAlertas = todasAlerFmt.length > 0 || todasAlerHall.length > 0;
        alertasBox.classList.toggle('hidden', !hayAlertas);

        // Formatos sin firma
        if (wrapFormatos) wrapFormatos.classList.toggle('hidden', todasAlerFmt.length === 0);
        if (badgeFmt) badgeFmt.textContent = todasAlerFmt.length;
        if (listFmt) {
            listFmt.innerHTML = todasAlerFmt.map(function(entry) {
                var a = entry.item;
                var color = a.dias > 7 ? 'text-red-400' : a.dias > 3 ? 'text-amber-400' : 'text-slate-300';
                return '<div class="flex items-start justify-between gap-2 py-1.5 border-b border-amber-500/10 last:border-0">' +
                    '<div class="flex-1 min-w-0">' +
                    '<p class="font-bold text-white truncate">' + a.consecutivo + ' ‚Äî ' + a.descripcion + '</p>' +
                    '<p class="text-[10px] text-slate-400">' + entry.supervisor + ' ¬∑ ' + a.empresa + '</p>' +
                    '</div>' +
                    '<span class="shrink-0 font-black ' + color + '">' + a.dias + 'd</span>' +
                    '</div>';
            }).join('');
        }

        // Hallazgos sin cierre
        if (wrapHallazg) wrapHallazg.classList.toggle('hidden', todasAlerHall.length === 0);
        if (badgeHall) badgeHall.textContent = todasAlerHall.length;
        if (listHall) {
            listHall.innerHTML = todasAlerHall.map(function(entry) {
                var a = entry.item;
                var color = a.dias > 7 ? 'text-red-400' : a.dias > 3 ? 'text-amber-400' : 'text-slate-300';
                return '<div class="flex items-start justify-between gap-2 py-1.5 border-b border-red-500/10 last:border-0">' +
                    '<div class="flex-1 min-w-0">' +
                    '<p class="font-bold text-white truncate">' + a.id + ' ‚Äî ' + a.descripcion + '</p>' +
                    '<p class="text-[10px] text-slate-400">' + entry.supervisor + ' ¬∑ ' + a.empresa + '</p>' +
                    '</div>' +
                    '<span class="shrink-0 font-black ' + color + '">' + a.dias + 'd</span>' +
                    '</div>';
            }).join('');
        }
    }

    /**
     * Aplica los filtros activos y re-renderiza tabla + cards.
     * Llamado desde los inputs/selects del HTML.
     */
    function filtrarSupervisorSTT() {
        if (!_sstCache) return;
        var texto = (document.getElementById('sst-filtro-texto')      || {}).value || '';
        var supV  = (document.getElementById('sst-filtro-supervisor') || {}).value || '';
        var obraV = (document.getElementById('sst-filtro-obra')       || {}).value || '';
        var q = texto.toLowerCase().trim();

        var filtrados = _sstCache.supervisores.filter(function(s) {
            if (supV  && s.email !== supV) return false;
            if (obraV && !(s.obras || []).includes(obraV)) return false;
            if (q && !(s.nombre.toLowerCase().includes(q) || (s.obras || []).join(' ').toLowerCase().includes(q))) return false;
            return true;
        });

        _sstRenderTabla(filtrados);
        var sinRes = document.getElementById('sst-sin-resultados');
        if (sinRes) {
            sinRes.classList.toggle('hidden', filtrados.length > 0);
            sinRes.style.display = filtrados.length === 0 ? 'flex' : 'none';
        }
    }

    /**
     * Construye el mensaje de WhatsApp con TODOS los pendientes del supervisor.
     * Incluye formatos sin firma y hallazgos abiertos con detalle completo.
     */
    function _sstMensajeWA(s) {
        var msg = 'üîî *Gesti√≥n SST - Pendientes*\n';
        msg += 'Hola ' + s.nombre + ', te contactamos desde el equipo SST.\n\n';

        var fmts = s.alertasFormatos || [];
        var halls = s.alertasHallazgos || [];

        if (fmts.length > 0) {
            msg += 'üìã *FORMATOS SIN FIRMA (' + fmts.length + '):*\n';
            fmts.forEach(function(a) {
                msg += '  ‚Ä¢ ' + a.consecutivo + ' ‚Äî ' + a.descripcion + '\n';
                msg += '    üìç ' + a.empresa + '  |  ‚è∞ ' + a.dias + ' d√≠a(s) pendiente\n';
            });
            msg += '\n';
        }

        if (halls.length > 0) {
            msg += '‚ö†Ô∏è *HALLAZGOS ABIERTOS (' + halls.length + '):*\n';
            halls.forEach(function(a) {
                msg += '  ‚Ä¢ ' + a.id + ' ‚Äî ' + a.descripcion + '\n';
                msg += '    üìç ' + a.empresa + '  |  ‚è∞ ' + a.dias + ' d√≠a(s) abierto\n';
            });
            msg += '\n';
        }

        if (fmts.length === 0 && halls.length === 0) {
            msg += '‚úÖ ¬°Sin pendientes! Todo al d√≠a.\n\n';
        }

        msg += 'Por favor gestiona estos pendientes a la brevedad. ¬°Gracias!';
        return msg;
    }

    /** Helper: retorna la clase de color seg√∫n el n√∫mero de pendientes. */
    function _sstColorPend(n) {
        if (n === 0) return 'text-green-400';
        if (n <= 2)  return 'text-amber-400';
        return 'text-red-400';
    }

    /** Helper: retorna la clase de color seg√∫n el % de cumplimiento. */
    function _sstColorTasa(t) {
        if (t >= 80) return 'text-green-400';
        if (t >= 50) return 'text-amber-400';
        return 'text-red-400';
    }

    /** Construye y actualiza la tabla desktop + cards mobile. */
    function _sstRenderTabla(supervisores) {
        var tbody   = document.getElementById('sst-tabla-body');
        var mobile  = document.getElementById('sst-lista-mobile');
        var sinRes  = document.getElementById('sst-sin-resultados');

        if (sinRes) {
            sinRes.classList.toggle('hidden', supervisores.length > 0);
            sinRes.style.display = supervisores.length === 0 ? 'flex' : 'none';
        }

        if (supervisores.length === 0) {
            if (tbody)  tbody.innerHTML  = '<tr><td colspan="6" class="py-8 text-center text-slate-500 text-xs italic">Sin resultados</td></tr>';
            if (mobile) mobile.innerHTML = '';
            return;
        }

        // ‚îÄ‚îÄ Tabla desktop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        if (tbody) {
            tbody.innerHTML = supervisores.map(function(s) {
                var obras = (s.obras || []).join(', ') || '‚Äî';
                var wa = s.celular
                    ? '<a href="https://wa.me/' + s.celular.replace(/\D/g, '') + '?text=' + encodeURIComponent(_sstMensajeWA(s)) + '" target="_blank" rel="noopener" ' +
                      'class="flex items-center gap-1 px-3 py-1.5 rounded-lg bg-green-500/10 border border-green-500/30 text-green-400 text-[10px] font-bold hover:bg-green-500/20 transition-all active:scale-95">' +
                      '<span class="material-symbols-outlined text-sm">chat</span>' +
                      '<span class="hidden sm:inline">WhatsApp</span></a>'
                    : '<span class="text-slate-600 text-[10px]">‚Äî</span>';

                return '<tr class="border-b border-white/5 hover:bg-white/3 transition-colors">' +
                    '<td class="px-3 py-3">' +
                        '<p class="text-xs font-bold text-white">' + s.nombre + '</p>' +
                        '<p class="text-[10px] text-slate-500">' + s.email + '</p>' +
                    '</td>' +
                    '<td class="px-3 py-3"><p class="text-[10px] text-slate-400 max-w-[140px] leading-tight">' + obras + '</p></td>' +
                    '<td class="px-3 py-3 text-center">' +
                        '<span class="text-xs font-bold text-slate-400">' + s.formatos.total + '</span>' +
                        '<span class="text-slate-600 mx-1">/</span>' +
                        '<span class="text-xs font-black ' + _sstColorPend(s.formatos.pendiente) + '">' + s.formatos.pendiente + '</span>' +
                        '<span class="text-slate-600 mx-1">/</span>' +
                        '<span class="text-xs font-bold text-green-400">' + s.formatos.cerrado + '</span>' +
                    '</td>' +
                    '<td class="px-3 py-3 text-center">' +
                        '<span class="text-xs font-bold text-slate-400">' + s.hallazgos.total + '</span>' +
                        '<span class="text-slate-600 mx-1">/</span>' +
                        '<span class="text-xs font-black ' + _sstColorPend(s.hallazgos.abiertos) + '">' + s.hallazgos.abiertos + '</span>' +
                        '<span class="text-slate-600 mx-1">/</span>' +
                        '<span class="text-xs font-bold text-green-400">' + s.hallazgos.cerrados + '</span>' +
                    '</td>' +
                    '<td class="px-3 py-3 text-center">' +
                        '<span class="text-sm font-black ' + _sstColorTasa(s.formatos.tasa) + '">' + s.formatos.tasa + '%</span>' +
                    '</td>' +
                    '<td class="px-3 py-3 text-right">' + wa + '</td>' +
                    '</tr>';
            }).join('');
        }

        // ‚îÄ‚îÄ Cards mobile ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        if (mobile) {
            mobile.innerHTML = supervisores.map(function(s) {
                var obras = (s.obras || []).join(', ') || '‚Äî';
                var tasaColor = _sstColorTasa(s.formatos.tasa);
                var pendFmtColor  = _sstColorPend(s.formatos.pendiente);
                var pendHallColor = _sstColorPend(s.hallazgos.abiertos);
                var waBtn = s.celular
                    ? '<a href="https://wa.me/' + s.celular.replace(/\D/g, '') + '?text=' + encodeURIComponent(_sstMensajeWA(s)) + '" target="_blank" rel="noopener" ' +
                      'class="flex-1 flex items-center justify-center gap-1.5 py-2.5 rounded-xl bg-green-500/10 border border-green-500/30 text-green-400 text-[10px] font-black hover:bg-green-500/20 transition-all active:scale-95">' +
                      '<span class="material-symbols-outlined text-base">chat</span>WhatsApp</a>'
                    : '';

                return '<div class="bg-white/5 border border-white/10 rounded-2xl p-4 space-y-3">' +
                    // Header
                    '<div class="flex items-start justify-between gap-2">' +
                        '<div>' +
                            '<p class="text-sm font-black text-white">' + s.nombre + '</p>' +
                            '<p class="text-[10px] text-slate-500 mt-0.5">' + obras + '</p>' +
                        '</div>' +
                        '<span class="text-lg font-black ' + tasaColor + '">' + s.formatos.tasa + '%</span>' +
                    '</div>' +
                    // Stats
                    '<div class="grid grid-cols-3 gap-2">' +
                        '<div class="bg-white/3 rounded-xl p-2 text-center">' +
                            '<p class="text-base font-black ' + pendFmtColor + '">' + s.formatos.pendiente + '</p>' +
                            '<p class="text-[9px] text-slate-500 uppercase tracking-widest">Sin Firma</p>' +
                        '</div>' +
                        '<div class="bg-white/3 rounded-xl p-2 text-center">' +
                            '<p class="text-base font-black ' + pendHallColor + '">' + s.hallazgos.abiertos + '</p>' +
                            '<p class="text-[9px] text-slate-500 uppercase tracking-widest">Sin Cierre</p>' +
                        '</div>' +
                        '<div class="bg-white/3 rounded-xl p-2 text-center">' +
                            '<p class="text-base font-black text-slate-300">' + s.formatos.total + '</p>' +
                            '<p class="text-[9px] text-slate-500 uppercase tracking-widest">Formatos</p>' +
                        '</div>' +
                    '</div>' +
                    // Actions
                    (waBtn ? '<div class="flex gap-2">' + waBtn + '</div>' : '') +
                    '</div>';
            }).join('');
        }
    }

    /**
     * Alterna la expansi√≥n de las secciones de alertas cr√≠ticas.
     * @param {string} tipo 'formatos' | 'hallazgos'
     */
    function _sstToggleAlertas(tipo) {
        var listEl  = document.getElementById('sst-alertas-' + tipo + '-list');
        var iconEl  = document.getElementById('sst-toggle-icon-' + tipo);
        if (!listEl) return;
        var abierto = listEl.style.maxHeight && listEl.style.maxHeight !== '0px';
        if (abierto) {
            listEl.style.maxHeight = '0px';
            if (iconEl) iconEl.style.transform = 'rotate(0deg)';
        } else {
            listEl.style.maxHeight = listEl.scrollHeight + 300 + 'px';
            if (iconEl) iconEl.style.transform = 'rotate(180deg)';
        }
    }

    /**
     * Genera y descarga un CSV con las m√©tricas de todos los supervisores.
     */
    function exportarCSVSupervisores() {
        if (!_sstCache || !_sstCache.supervisores) {
            mostrarNotificacion('Cargue los datos primero.', 'error');
            return;
        }
        var headers = ['Nombre', 'Email', 'Celular', 'Obras', 'Formatos Total', 'Formatos Pendiente', 'Formatos Cerrado', '% Cumplimiento', 'Hallazgos Total', 'Hallazgos Abiertos', 'Hallazgos Cerrados'];
        var filas = _sstCache.supervisores.map(function(s) {
            return [
                '"' + (s.nombre  || '').replace(/"/g, '""') + '"',
                '"' + (s.email   || '') + '"',
                '"' + (s.celular || '') + '"',
                '"' + (s.obras   || []).join(' | ').replace(/"/g, '""') + '"',
                s.formatos.total,
                s.formatos.pendiente,
                s.formatos.cerrado,
                s.formatos.tasa + '%',
                s.hallazgos.total,
                s.hallazgos.abiertos,
                s.hallazgos.cerrados
            ].join(',');
        });
        var csv = [headers.join(',')].concat(filas).join('\n');
        var blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
        var url  = URL.createObjectURL(blob);
        var a    = document.createElement('a');
        a.href     = url;
        a.download = 'supervisores_sst_' + new Date().toISOString().slice(0, 10) + '.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        mostrarNotificacion('CSV exportado correctamente.', 'success');
    }

    // ‚îÄ‚îÄ M√ìDULO EVALUACI√ìN DE DESEMPE√ëO SST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    /** Colapsa / expande el panel de evaluaci√≥n de desempe√±o. */
    function _sstTogglePanelEval() {
        var panel  = document.getElementById('sst-eval-panel');
        var icon   = document.getElementById('sst-eval-toggle-icon');
        if (!panel) return;
        var isOpen = panel.style.maxHeight && panel.style.maxHeight !== '0px';
        if (isOpen) {
            panel.style.maxHeight = '0px';
            if (icon) icon.style.transform = 'rotate(0deg)';
        } else {
            panel.style.maxHeight = panel.scrollHeight + 'px';
            if (icon) icon.style.transform = 'rotate(180deg)';
        }
    }

    /** Establece las fechas desde/hasta seg√∫n el preset seleccionado. */
    function _sstSetPeriodo(tipo) {
        var hoy   = new Date();
        var desde = new Date();
        var hasta = new Date(hoy);

        if (tipo === 'semana') {
            // Lunes de la semana actual
            var dia = hoy.getDay(); // 0=dom
            var diff = dia === 0 ? -6 : 1 - dia;
            desde = new Date(hoy);
            desde.setDate(hoy.getDate() + diff);
        } else if (tipo === 'quincena') {
            desde = new Date(hoy);
            desde.setDate(hoy.getDate() - 14);
        } else if (tipo === 'mes') {
            desde = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
        } else {
            // personalizado: no cambia fechas, solo quita el resaltado de botones
        }

        function _fmt_(d) {
            var mm = String(d.getMonth() + 1).padStart(2, '0');
            var dd = String(d.getDate()).padStart(2, '0');
            return d.getFullYear() + '-' + mm + '-' + dd;
        }

        var elDesde = document.getElementById('sst-eval-desde');
        var elHasta = document.getElementById('sst-eval-hasta');
        if (tipo !== 'personalizado') {
            if (elDesde) elDesde.value = _fmt_(desde);
            if (elHasta) elHasta.value = _fmt_(hasta);
        }

        // Resaltar bot√≥n activo
        document.querySelectorAll('.sst-preset-btn').forEach(function(btn) {
            btn.classList.remove('border-amber-500/40', 'text-amber-400');
            btn.classList.add('border-white/10', 'text-slate-400');
        });
        var btnActivo = document.querySelector('[onclick="_sstSetPeriodo(\'' + tipo + '\')"]');
        if (btnActivo) {
            btnActivo.classList.remove('border-white/10', 'text-slate-400');
            btnActivo.classList.add('border-amber-500/40', 'text-amber-400');
        }
    }

    /** Llena los selects del panel de evaluaci√≥n con datos del cache. */
    function _sstPoblarSelectoresEval() {
        if (!_sstCache) return;
        var selSup  = document.getElementById('sst-eval-supervisor');
        var selEmp  = document.getElementById('sst-eval-empresa');
        if (!selSup || !selEmp) return;

        // Supervisor
        selSup.innerHTML = '<option value="">‚Äî Seleccionar supervisor ‚Äî</option>';
        (_sstCache.supervisores || []).forEach(function(s) {
            var opt = document.createElement('option');
            opt.value = s.email;
            opt.textContent = s.nombre;
            opt.style.background = '#1a242f';
            selSup.appendChild(opt);
        });

        // Empresa
        selEmp.innerHTML = '<option value="">Todas las empresas</option>';
        (_sstCache.empresas || []).forEach(function(e) {
            var opt = document.createElement('option');
            opt.value = e;
            opt.textContent = e;
            opt.style.background = '#1a242f';
            selEmp.appendChild(opt);
        });
    }

    /** Genera el informe individual en PDF (nueva ventana ‚Üí imprimir). */
    function generarInformeIndividual() {
        var emailSup = (document.getElementById('sst-eval-supervisor') || {}).value || '';
        var desde    = (document.getElementById('sst-eval-desde') || {}).value || '';
        var hasta    = (document.getElementById('sst-eval-hasta') || {}).value || '';
        var empresa  = (document.getElementById('sst-eval-empresa') || {}).value || '';

        if (!emailSup) { mostrarNotificacion('Selecciona un supervisor para el informe.', 'error'); return; }
        if (!desde || !hasta) { mostrarNotificacion('Define el per√≠odo (Desde / Hasta).', 'error'); return; }
        if (desde > hasta)    { mostrarNotificacion('La fecha "Desde" debe ser anterior a "Hasta".', 'error'); return; }

        mostrarNotificacion('Generando informe...', 'info');

        google.script.run
            .withSuccessHandler(function(res) {
                if (res.status !== 'success') {
                    mostrarNotificacion(res.message || 'Error al generar el informe.', 'error');
                    return;
                }
                var html = _sstBuildReportHTML(res.data);
                var win = window.open('', '_blank');
                if (!win) {
                    mostrarNotificacion('El navegador bloque√≥ la ventana emergente. Perm√≠tela e intenta de nuevo.', 'error');
                    return;
                }
                win.document.write(html);
                win.document.close();
            })
            .withFailureHandler(function(err) {
                mostrarNotificacion('Error: ' + (err.message || err.toString()), 'error');
            })
            .obtenerReporteDesempenoSTT({ fechaInicio: desde, fechaFin: hasta, emailSupervisor: emailSup, empresa: empresa });
    }

    /** Genera y muestra el ranking del per√≠odo en el modal. */
    function generarRankingPeriodo() {
        var desde   = (document.getElementById('sst-eval-desde') || {}).value || '';
        var hasta   = (document.getElementById('sst-eval-hasta') || {}).value || '';
        var empresa = (document.getElementById('sst-eval-empresa') || {}).value || '';

        if (!desde || !hasta) { mostrarNotificacion('Define el per√≠odo (Desde / Hasta).', 'error'); return; }
        if (desde > hasta)    { mostrarNotificacion('La fecha "Desde" debe ser anterior a "Hasta".', 'error'); return; }

        var modal = document.getElementById('sst-ranking-modal');
        var body  = document.getElementById('sst-ranking-body');
        if (body) body.innerHTML = '<div class="flex flex-col items-center gap-3 py-10 text-slate-500"><div class="animate-spin h-7 w-7 border-2 border-indigo-400 border-t-transparent rounded-full"></div><p class="text-xs font-bold uppercase tracking-widest">Calculando ranking...</p></div>';
        if (modal) modal.classList.remove('hidden');

        google.script.run
            .withSuccessHandler(function(res) {
                if (res.status !== 'success') {
                    if (body) body.innerHTML = '<p class="text-center text-red-400 text-xs py-8">' + (res.message || 'Error al cargar el ranking.') + '</p>';
                    return;
                }
                var tit = document.getElementById('sst-ranking-titulo');
                var sub = document.getElementById('sst-ranking-sub');
                if (tit) tit.textContent = 'Ranking del Per√≠odo';
                if (sub) sub.textContent = res.data.periodo.inicio + ' al ' + res.data.periodo.fin + (res.data.empresa ? ' ¬∑ ' + res.data.empresa : '');
                _sstRenderRanking(res.data, body);
            })
            .withFailureHandler(function(err) {
                if (body) body.innerHTML = '<p class="text-center text-red-400 text-xs py-8">Error: ' + (err.message || err.toString()) + '</p>';
            })
            .obtenerReporteDesempenoSTT({ fechaInicio: desde, fechaFin: hasta, emailSupervisor: '', empresa: empresa });
    }

    /** Cierra el modal de ranking. */
    function cerrarRankingModal() {
        var modal = document.getElementById('sst-ranking-modal');
        if (modal) modal.classList.add('hidden');
    }

    /**
     * Construye el HTML completo del informe individual para imprimir.
     * @param {Object} data Datos devueltos por obtenerReporteDesempenoSTT (tipo='individual')
     * @return {string} HTML completo de la ventana de impresi√≥n
     */
    function _sstBuildReportHTML(data) {
        var sup     = data.supervisor || {};
        var met     = data.metricas  || {};
        var per     = data.periodo   || {};
        var logoUrl = (data.logoUrl  || '').toString().trim();
        var msg     = _sstMsgMotivacional(met.tasa || 0);
        var fmts    = met.detFormatos  || [];
        var halls   = met.detHallazgos || [];
        var tasa    = met.tasa || 0;
        var tasaColor = tasa >= 80 ? '#22c55e' : tasa >= 50 ? '#f59e0b' : '#ef4444';
        var hoy     = new Date().toLocaleDateString('es-CO', { year:'numeric', month:'long', day:'numeric' });

        var rowsFmts = fmts.length === 0
            ? '<tr><td colspan="5" style="text-align:center;color:#64748b;padding:12px;font-style:italic;">Sin formatos en el per√≠odo</td></tr>'
            : fmts.map(function(f, idx) {
                var esC = f.estado === 'CERRADO CON FIRMA';
                return '<tr style="background:' + (idx % 2 === 0 ? '#f8fafc' : '#f1f5f9') + '">'
                    + '<td style="padding:6px 8px;color:#475569;">' + (f.consecutivo || '') + '</td>'
                    + '<td style="padding:6px 8px;color:#334155;">' + (f.descripcion || '') + '</td>'
                    + '<td style="padding:6px 8px;color:#475569;">' + (f.empresa || '') + '</td>'
                    + '<td style="padding:6px 8px;color:#475569;">' + (f.fecha || '') + '</td>'
                    + '<td style="padding:6px 8px;text-align:center;"><span style="background:' + (esC ? '#dcfce7' : '#fef3c7') + ';color:' + (esC ? '#166534' : '#92400e') + ';padding:2px 8px;border-radius:9999px;font-size:10px;font-weight:700;">' + (f.estado || '') + '</span></td>'
                    + '</tr>';
              }).join('');

        var rowsHalls = halls.length === 0
            ? '<tr><td colspan="5" style="text-align:center;color:#64748b;padding:12px;font-style:italic;">Sin hallazgos en el per√≠odo</td></tr>'
            : halls.map(function(h, idx) {
                var esC = h.estado === 'CERRADO';
                return '<tr style="background:' + (idx % 2 === 0 ? '#f8fafc' : '#f1f5f9') + '">'
                    + '<td style="padding:6px 8px;color:#475569;font-size:10px;">' + (h.id || '') + '</td>'
                    + '<td style="padding:6px 8px;color:#334155;">' + (h.descripcion || '') + '</td>'
                    + '<td style="padding:6px 8px;color:#475569;">' + (h.empresa || '') + '</td>'
                    + '<td style="padding:6px 8px;color:#475569;">' + (h.fecha || '') + '</td>'
                    + '<td style="padding:6px 8px;text-align:center;"><span style="background:' + (esC ? '#dcfce7' : '#fee2e2') + ';color:' + (esC ? '#166534' : '#991b1b') + ';padding:2px 8px;border-radius:9999px;font-size:10px;font-weight:700;">' + (h.estado || '') + '</span></td>'
                    + '</tr>';
              }).join('');

        return '<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8">'
            + '<title>Informe Desempe√±o SST - ' + (sup.nombre || '') + '</title>'
            + '<style>'
            + 'body{font-family:"Segoe UI",Arial,sans-serif;background:#f1f5f9;margin:0;padding:0;color:#1e293b;}'
            + '.page{max-width:820px;margin:0 auto;background:#fff;}'
            + '.header{background:linear-gradient(135deg,#0c1520 0%,#1e293b 100%);padding:28px 36px;color:#fff;display:flex;align-items:stretch;justify-content:space-between;gap:20px;}'
            + '.header-left{flex:1;display:flex;flex-direction:column;justify-content:center;gap:4px;}'
            + '.header-brand{display:flex;align-items:center;gap:12px;margin-bottom:6px;}'
            + '.header-logo-img{max-height:48px;max-width:100px;object-fit:contain;border-radius:6px;background:rgba(255,255,255,0.08);padding:4px 8px;}'
            + '.header-label{font-size:10px;color:#94a3b8;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;margin:0;}'
            + '.header h1{margin:4px 0 8px;font-size:24px;font-weight:900;letter-spacing:-.5px;line-height:1.1;}'
            + '.badge{display:inline-block;background:rgba(245,158,11,.18);color:#f59e0b;border:1px solid rgba(245,158,11,.40);padding:3px 12px;border-radius:9999px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;}'
            + '.header-sup{flex-shrink:0;min-width:210px;background:rgba(245,158,11,0.07);border:1.5px solid rgba(245,158,11,0.28);border-radius:14px;padding:16px 18px;display:flex;flex-direction:column;justify-content:center;gap:6px;}'
            + '.sup-name{font-size:15px;font-weight:900;color:#f59e0b;margin:0;letter-spacing:-.3px;line-height:1.2;}'
            + '.sup-detail{font-size:10px;color:#94a3b8;margin:0;display:flex;align-items:center;gap:5px;}'
            + '.sup-detail strong{color:#cbd5e1;}'
            + '.sup-divider{border:none;border-top:1px solid rgba(245,158,11,0.20);margin:4px 0;}'
            + '.sup-period{font-size:10px;font-weight:700;color:#f59e0b;margin:0;}'
            + '.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;padding:24px 36px;}'
            + '.kpi{text-align:center;background:#f8fafc;border-radius:12px;padding:16px 8px;border:1px solid #e2e8f0;}'
            + '.kpi .num{font-size:28px;font-weight:900;line-height:1;}'
            + '.kpi .lbl{font-size:9px;color:#64748b;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-top:4px;}'
            + '.progress-wrap{padding:0 36px 24px;}'
            + '.progress-bar{height:14px;background:#e2e8f0;border-radius:9999px;overflow:hidden;margin-top:6px;}'
            + '.progress-fill{height:100%;border-radius:9999px;transition:width .5s;}'
            + '.progress-label{display:flex;justify-content:space-between;font-size:10px;color:#64748b;font-weight:600;margin-top:4px;}'
            + '.msg-box{margin:0 36px 24px;padding:18px 20px;border-radius:14px;border:1px solid #e2e8f0;background:#f0fdf4;}'
            + '.msg-box.warn{background:#fffbeb;border-color:#fde68a;}'
            + '.msg-box.danger{background:#fff1f2;border-color:#fecdd3;}'
            + '.msg-box .emoji{font-size:28px;}'
            + '.msg-box h2{margin:8px 0 4px;font-size:15px;font-weight:900;}'
            + '.msg-box p{margin:0;font-size:12px;color:#475569;line-height:1.6;}'
            + '.section{padding:0 36px 24px;}'
            + '.section h3{font-size:11px;font-weight:900;text-transform:uppercase;letter-spacing:1px;color:#475569;margin:0 0 10px;border-bottom:1px solid #e2e8f0;padding-bottom:6px;}'
            + 'table{width:100%;border-collapse:collapse;font-size:11px;}'
            + 'th{background:#1e293b;color:#fff;padding:8px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1px;text-align:left;}'
            + '.firma{padding:24px 36px;border-top:1px solid #e2e8f0;display:flex;justify-content:flex-end;}'
            + '.firma-box{width:220px;text-align:center;}'
            + '.firma-line{border-top:1.5px solid #334155;margin-bottom:6px;}'
            + '.firma-box p{font-size:10px;color:#64748b;margin:0;}'
            + '.footer{background:#f8fafc;border-top:1px solid #e2e8f0;padding:12px 36px;text-align:center;font-size:9px;color:#94a3b8;font-weight:600;text-transform:uppercase;letter-spacing:1px;}'
            + '@media print{@page{size:A4;margin:0;}body{background:#fff;}.page{max-width:100%;}}'
            + '</style></head><body>'
            + '<div class="page">'
            + '<div class="header">'
            + '<div class="header-left">'
            + '<div class="header-brand">'
            + (logoUrl ? '<img class="header-logo-img" src="' + logoUrl + '" alt="Logo" onerror="this.style.display=\'none\'">' : '')
            + '<p class="header-label">Sistema SST ¬∑ Security Work S&amp;M</p>'
            + '</div>'
            + '<h1>Informe de Desempe√±o</h1>'
            + '<span class="badge">Evaluaci√≥n del Per√≠odo</span>'
            + '</div>'
            + '<div class="header-sup">'
            + '<p class="sup-name">&#128100; ' + (sup.nombre || '') + '</p>'
            + '<p class="sup-detail">&#9993; <strong>' + (sup.email || '') + '</strong></p>'
            + (sup.celular ? '<p class="sup-detail">&#128241; <strong>' + sup.celular + '</strong></p>' : '')
            + '<hr class="sup-divider">'
            + '<p class="sup-period">&#128197; ' + (per.inicio || '') + ' &rarr; ' + (per.fin || '') + '</p>'
            + '</div>'
            + '</div>'
            + '<div class="kpis">'
            + '<div class="kpi"><div class="num" style="color:#3b82f6">' + ((met.formatos || {}).total || 0) + '</div><div class="lbl">Formatos Cargados</div></div>'
            + '<div class="kpi"><div class="num" style="color:#f59e0b">' + ((met.formatos || {}).pendiente || 0) + '</div><div class="lbl">Formatos Sin Firma</div></div>'
            + '<div class="kpi"><div class="num" style="color:#8b5cf6">' + ((met.hallazgos || {}).total || 0) + '</div><div class="lbl">Hallazgos Reportados</div></div>'
            + '<div class="kpi"><div class="num" style="color:#ef4444">' + ((met.hallazgos || {}).abiertos || 0) + '</div><div class="lbl">Hallazgos Abiertos</div></div>'
            + '</div>'
            + '<div class="progress-wrap">'
            + '<div style="font-size:11px;font-weight:700;color:#475569;">Tasa de Cumplimiento Global: <strong style="color:' + tasaColor + '">' + tasa + '%</strong></div>'
            + '<div class="progress-bar"><div class="progress-fill" style="width:' + tasa + '%;background:' + tasaColor + ';"></div></div>'
            + '<div class="progress-label"><span>0%</span><span>100%</span></div>'
            + '</div>'
            + '<div class="msg-box' + (tasa >= 80 ? '' : tasa >= 50 ? ' warn' : ' danger') + '">'
            + '<div class="emoji">' + msg.emoji + '</div>'
            + '<h2>' + msg.titulo + '</h2>'
            + '<p>' + msg.texto + '</p>'
            + '</div>'
            + '<div class="section"><h3>Formatos del per√≠odo</h3><table>'
            + '<thead><tr><th>Consecutivo</th><th>Descripci√≥n</th><th>Empresa</th><th>Fecha</th><th style="text-align:center">Estado</th></tr></thead>'
            + '<tbody>' + rowsFmts + '</tbody></table></div>'
            + '<div class="section"><h3>Hallazgos del per√≠odo</h3><table>'
            + '<thead><tr><th>ID</th><th>Descripci√≥n</th><th>Empresa</th><th>Fecha</th><th style="text-align:center">Estado</th></tr></thead>'
            + '<tbody>' + rowsHalls + '</tbody></table></div>'
            + '<div class="firma"><div class="firma-box"><div style="height:48px;"></div><div class="firma-line"></div><p>Firma Administrador SST</p><p style="margin-top:2px;">' + hoy + '</p></div></div>'
            + '<div class="footer">Evaluaci√≥n generada por Sistema SST ¬∑ Security Work S&amp;M ¬∑ ' + hoy + '</div>'
            + '</div>'
            + '<script>window.onload=function(){window.print();}<\/script>'
            + '</body></html>';
    }

    /**
     * Retorna mensaje motivacional seg√∫n la tasa de desempe√±o.
     * @param {number} tasa Porcentaje de cumplimiento (0-100)
     * @return {Object} { emoji, titulo, texto }
     */
    function _sstMsgMotivacional(tasa) {
        if (tasa >= 90) return {
            emoji: 'üèÜ', titulo: '¬°Desempe√±o Sobresaliente!',
            texto: 'Tu dedicaci√≥n y profesionalismo son un ejemplo para todo el equipo. ¬°Sigue as√≠, eres clave para la seguridad!'
        };
        if (tasa >= 70) return {
            emoji: '‚≠ê', titulo: '¬°Muy Buen Trabajo!',
            texto: 'Tu esfuerzo es visible y valorado. Est√°s en el camino correcto hacia la excelencia en SST.'
        };
        if (tasa >= 50) return {
            emoji: 'üí™', titulo: '¬°Vas Por Buen Camino!',
            texto: 'Con un poco m√°s de constancia puedes alcanzar la excelencia. El equipo conf√≠a en ti.'
        };
        return {
            emoji: 'ü§ù', titulo: 'Oportunidad de Mejora',
            texto: 'Juntos trabajaremos para fortalecer tu gesti√≥n SST. El apoyo del equipo siempre estar√° contigo.'
        };
    }

    /**
     * Renderiza el ranking en el body del modal.
     * @param {Object} data  Respuesta del backend (tipo='ranking')
     * @param {Element} body Contenedor del modal
     */
    function _sstRenderRanking(data, body) {
        var ranking = data.ranking || [];
        if (ranking.length === 0) {
            body.innerHTML = '<div class="flex flex-col items-center gap-3 py-10 text-slate-500"><span class="material-symbols-outlined text-4xl">search_off</span><p class="text-xs font-bold">Sin datos para el per√≠odo y filtros seleccionados.</p></div>';
            return;
        }

        var podiumEmojis = ['ü•á', 'ü•à', 'ü•â'];
        var podiumColors = [
            'rgba(245,158,11,0.15)', // oro
            'rgba(148,163,184,0.12)', // plata
            'rgba(180,107,60,0.12)'   // bronce
        ];
        var podiumBorders = [
            'rgba(245,158,11,0.40)',
            'rgba(148,163,184,0.30)',
            'rgba(180,107,60,0.30)'
        ];
        var podiumTextC = ['#f59e0b', '#94a3b8', '#b46b3c'];

        var html = '';

        // Top 3 tarjetas
        var top3 = ranking.slice(0, 3);
        html += '<div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4">';
        top3.forEach(function(s, idx) {
            var bg  = podiumColors[idx]  || 'rgba(255,255,255,0.05)';
            var bc  = podiumBorders[idx] || 'rgba(255,255,255,0.10)';
            var tc  = podiumTextC[idx]   || '#94a3b8';
            var pos = podiumEmojis[idx]  || (idx + 1) + '¬∫';
            var tasaC = s.tasa >= 80 ? '#22c55e' : s.tasa >= 50 ? '#f59e0b' : '#ef4444';
            html += '<div style="background:' + bg + ';border:1.5px solid ' + bc + ';" class="rounded-2xl p-3 text-center">'
                + '<div class="text-2xl mb-1">' + pos + '</div>'
                + '<p class="text-xs font-black text-white leading-tight">' + (s.nombre || '') + '</p>'
                + '<p class="text-[9px] font-bold uppercase tracking-widest mt-0.5" style="color:' + tc + '">' + s.tasa + '% cumplimiento</p>'
                + '<div class="mt-2 grid grid-cols-2 gap-1 text-[9px]">'
                + '<div class="bg-white/5 rounded-lg p-1.5"><span class="font-black text-white">' + s.formatos.total + '</span><br><span class="text-slate-500">formatos</span></div>'
                + '<div class="bg-white/5 rounded-lg p-1.5"><span class="font-black text-white">' + s.hallazgos.total + '</span><br><span class="text-slate-500">hallazgos</span></div>'
                + '</div></div>';
        });
        html += '</div>';

        // Tabla completa
        html += '<div class="overflow-x-auto rounded-xl border border-white/10">'
            + '<table class="w-full min-w-[520px] text-left">'
            + '<thead><tr style="background:rgba(255,255,255,0.04);" class="border-b border-white/10">'
            + '<th class="px-3 py-2.5 text-[9px] font-black text-slate-400 uppercase tracking-widest">#</th>'
            + '<th class="px-3 py-2.5 text-[9px] font-black text-slate-400 uppercase tracking-widest">Supervisor</th>'
            + '<th class="px-3 py-2.5 text-[9px] font-black text-amber-500/70 uppercase tracking-widest text-center">Formatos<br><span class="text-slate-500 normal-case">Tot / Cerr</span></th>'
            + '<th class="px-3 py-2.5 text-[9px] font-black text-red-500/70 uppercase tracking-widest text-center">Hallazgos<br><span class="text-slate-500 normal-case">Tot / Cerr</span></th>'
            + '<th class="px-3 py-2.5 text-[9px] font-black text-green-500/70 uppercase tracking-widest text-center">% Cumpl.</th>'
            + '</tr></thead><tbody>';

        ranking.forEach(function(s, idx) {
            var tasaC = s.tasa >= 80 ? '#22c55e' : s.tasa >= 50 ? '#f59e0b' : '#ef4444';
            var bgRow = idx % 2 === 0 ? '' : 'style="background:rgba(255,255,255,0.02)"';
            html += '<tr ' + bgRow + ' class="border-b border-white/5 hover:bg-white/3 transition-colors">'
                + '<td class="px-3 py-2.5 text-xs font-black text-slate-400">' + (podiumEmojis[idx] || (idx + 1) + '¬∫') + '</td>'
                + '<td class="px-3 py-2.5"><p class="text-xs font-bold text-white leading-tight">' + (s.nombre || '') + '</p></td>'
                + '<td class="px-3 py-2.5 text-center text-xs text-slate-300">' + s.formatos.total + ' / <span class="text-green-400 font-bold">' + s.formatos.cerrado + '</span></td>'
                + '<td class="px-3 py-2.5 text-center text-xs text-slate-300">' + s.hallazgos.total + ' / <span class="text-green-400 font-bold">' + s.hallazgos.cerrado + '</span></td>'
                + '<td class="px-3 py-2.5 text-center"><span class="text-sm font-black" style="color:' + tasaC + '">' + s.tasa + '%</span></td>'
                + '</tr>';
        });

        html += '</tbody></table></div>';
        body.innerHTML = html;
    }

    // ‚îÄ‚îÄ FIN M√ìDULO GESTI√ìN SUPERVISOR STT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function onError(message) {
        mostrarNotificacion('‚ùå Error: ' + message, 'error');
    }
</script>