<script>
    /**
     * LOGIN.JS.HTML
     * Maneja la interacción del formulario de inicio de sesión.
     */

    function showLoginError(msg) {
        var el = document.getElementById('login-error');
        var txt = document.getElementById('login-error-msg');
        if (el && txt) {
            txt.textContent = msg;
            el.style.display = 'flex';
        }
    }

    function hideLoginError() {
        var el = document.getElementById('login-error');
        if (el) el.style.display = 'none';
    }

    // Auto-ocultar error al escribir
    ['email', 'password'].forEach(function (id) {
        var el = document.getElementById(id);
        if (el) el.addEventListener('input', hideLoginError);
    });

    function togglePassword() {
        const passInput = document.getElementById('password');
        const eyeIcon = document.getElementById('eye-icon');
        if (passInput.type === 'password') {
            passInput.type = 'text';
            eyeIcon.textContent = 'visibility';
        } else {
            passInput.type = 'password';
            eyeIcon.textContent = 'visibility_off';
        }
    }

    document.getElementById('login-form').addEventListener('submit', function (e) {
        e.preventDefault();

        const btn = document.getElementById('btn-login');
        const spinner = document.getElementById('login-spinner');
        const btnText = document.getElementById('btn-text');
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        // Bloquear UI
        btn.disabled = true;
        spinner.classList.remove('hidden');
        btnText.textContent = "VERIFICANDO...";
        hideLoginError();

        // Timeout: si GAS no responde en 12s, resetear automáticamente
        var loginTimeout = setTimeout(function () {
            showLoginError('La conexión tardó demasiado. Verifica tu internet e intenta de nuevo.');
            resetButton();
        }, 12000);

        google.script.run
            .withSuccessHandler(function (response) {
                clearTimeout(loginTimeout);
                if (response.status === "success") {
                    // Guardar sesión completa en localStorage para persistencia
                    const userData = {
                        email: response.data.email,
                        nombre: response.data.nombre,
                        rol: response.data.rol,
                        idCliente: response.data.idCliente
                    };
                    localStorage.setItem('userSST', JSON.stringify(userData));

                    // URL de destino
                    const baseUrl = (typeof SCRIPT_URL !== 'undefined' && SCRIPT_URL)
                        ? SCRIPT_URL
                        : window.location.href.split('?')[0];
                    const role = response.data.rol || 'USER';
                    const emailEnc = encodeURIComponent(response.data.email || '');
                    const destination = baseUrl + '?page=app&role=' + role + '&email=' + emailEnc;

                    // Efecto de salida
                    document.getElementById('login-container').classList.add('scale-95', 'opacity-0', 'transition-all', 'duration-500');

                    // Redirección directa
                    window.top.location.href = destination;
                } else {
                    showLoginError(response.message || 'Credenciales incorrectas');
                    resetButton();
                }
            })
            .withFailureHandler(function (err) {
                clearTimeout(loginTimeout);
                showLoginError('Error de conexión. Intenta de nuevo.');
                console.error('[SST] Login error:', err);
                resetButton();
            })
            .validarCredenciales(email, password);
    });

    function resetButton() {
        const btn = document.getElementById('btn-login');
        const spinner = document.getElementById('login-spinner');
        const btnText = document.getElementById('btn-text');
        btn.disabled = false;
        spinner.classList.add('hidden');
        btnText.textContent = "INICIAR SESIÓN";
    }
</script>